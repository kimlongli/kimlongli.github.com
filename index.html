<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="李金隆的博客, Jinlong blog, 副业造轮子" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Jinlong's Blog">
<meta property="og:url" content="http://kimlongli.github.io/index.html">
<meta property="og:site_name" content="Jinlong's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jinlong's Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kimlongli.github.io/"/>





  <title> Jinlong's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Jinlong's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">副业造轮子</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/12/14/如何设计一个还可以的五子棋AI/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/14/如何设计一个还可以的五子棋AI/" itemprop="url">
                  如何设计一个还可以的五子棋AI
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-14T01:08:44+08:00">
                2016-12-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/14/如何设计一个还可以的五子棋AI/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/14/如何设计一个还可以的五子棋AI/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="图形界面"><a href="#图形界面" class="headerlink" title="图形界面"></a>图形界面</h3><p>由于图形界面不是本次讨论的重点，所以只用python实现了一个简单的图形界面，然后用C++来实现算法部分的内容，编译成动态链接库，在python界面程序中调用动态链接库中的相关函数就可以了。选择python是因为考虑到它的夸平台性，在各大操作系统都可以直接解释执行。对于动态链接库，Linux是so，而Windows是dll，代码写法略有不同，但也差别不大。<br>比如说在*nix系统中直接编译我们写好的代码成so库就好了，而在Windows中函数则要额外加上<strong>declspec(dllexport)或</strong>declspec(dllimport)声明，例如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> BUILD_DLL</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">define</span> DLL_EXPORT __declspec(dllexport)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">	<span class="meta">#<span class="meta-keyword">define</span> DLL_EXPORT __declspec(dllimport)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</div><div class="line">	<span class="function">DLL_EXPORT <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> a + b;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意，如果是用C++，需要用extern “C” {}把导出函数括起来，否则C++中的函数名字修饰（Decorated Name）会导致在加载动态链接库中相应函数的时候找不到函数名</p>
<p>另外附上*uix平台和Windows平台编译生成动态链接库的命令：<br>Linux<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">g++ -shared <span class="_">-f</span>PIC -o libfivechess.so fivechess.cpp</div></pre></td></tr></table></figure></p>
<p>Windows<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">g++ -c -DBUILD fivechess.cpp</div><div class="line">g++ -shared -o fivechess.dll fivechess.o -Wl,--out-implib,libfivechess.a</div></pre></td></tr></table></figure></p>
<p>当应用需要发布的时候可以用pyinstaller等工具来把python脚本打包成exe等可执行文件。<br><a href="/source/uploads/wuziqi3.jpg">!wuziqi3.jpg</a><br><a href="/source/uploads/wuziqi4.jpg">!wuziqi4.jpg</a></p>
<h3 id="最初的思路"><a href="#最初的思路" class="headerlink" title="最初的思路"></a>最初的思路</h3><pre><code>下面进入本次讨论的重点，算法部分。
最初的思路是根据人的经验制定一个评分表，根据评分表对棋盘中每一个位置进行评分，选取评分最高的位置作为下一步走的棋。什么是评分表呢？看下图：
[!score.jpg](/source/uploads/score.jpg)
这是摘自董红安2005年论文“计算机五子棋博弈系统的研究与实现”中的评分表，图中共有16中不同的特征，在每一种特征中，O代表棋子，+代表空位，每一种特征的右侧有其对应的评分。在一个好的评分表中，威胁大的特征具有绝对优势的评分，再多威胁小的评分加起来也不可能超过威胁大的评分表。
有了评分表，那怎么利用评分表对相应位置进行评分呢？评分规则如下：
对该位置所在的行和列和正斜列以及反斜列上相关范围进行扫描，如图
[!score1.jpg](/source/uploads/score1.jpg)
可以看出，图中四个矩形的模式分别是(假如要在粉色多边形的位置上放置绿方棋子）：
* 横：+++OO++++
* 竖：+++OOO+++
* \：++++O++++
* /：++AOO++++
其中的A表示该位置有敌方棋子，我们对这四组数据进行模式匹配，得出该位置的分数为：
120 + 720 + 20 + 0 = 860
应用此算法对棋盘中的所有位置进行评分，然后选取分数最高的位置进行下棋
</code></pre><h3 id="加入博弈树-利用极大极小搜索提升棋力"><a href="#加入博弈树-利用极大极小搜索提升棋力" class="headerlink" title="加入博弈树-利用极大极小搜索提升棋力"></a>加入博弈树-利用极大极小搜索提升棋力</h3><pre><code>上诉的方法虽然简单容易实现，却可以取得不错的效果，有时候一不小还真的被他打输了。但是，上诉方法的确有非常大的缺陷，电脑只能预测一步，相当于一个仅仅拘束于眼前利益的傻子，稍微熟悉五子棋的人套路一下电脑，就可以轻易打赢电脑了。
解决方法是我们可以设计程序让电脑可以思考几步，极大极小搜索树可以帮忙我们实现这种功能。在此我们需要修改一下评分函数，这次不是对每一个位置进行评分，而是对整个棋局来进行评分（评分的时候对整个棋盘的每一行每一列每一斜列进行模式匹配，然后把所有的分数加起来即可），整个棋局作为一个独立单位。
[!score2.jpg](/source/uploads/score2.jpg)
如图，我们先计算叶子节点的分数（注：这里指的分数是对于己方来说的，分数越高，对己方越有利）。接着，如果子节点是己（敌）方下的棋，则子节点的父节点的值被赋值为子节点中的最大（小）值。最后，在第一层中，找出得分最高的节点，作为下一步下棋的位置。

在使用了极大极小搜索之后，棋力得到了一定的提升。但是因为极大极小搜索需要巨大的运算量（时间复杂度为指数级别），所以只能做很少几层的搜索（3层），这对于计算机来说是患了很深的近视眼（观察距离只能是3层），下面我们通过AlphaBeta优化来优化极大极小搜索。
</code></pre><h3 id="质的提升-AlphaBeta剪枝"><a href="#质的提升-AlphaBeta剪枝" class="headerlink" title="质的提升-AlphaBeta剪枝"></a>质的提升-AlphaBeta剪枝</h3><pre><code>AlphaBeta剪枝是对极大极小搜索的优化，描述算法需要大量的篇幅，这里就不讨论了，直接给出一篇写的还不错的文章[http://www.xqbase.com/computer/search_alphabeta.htm](http://www.xqbase.com/computer/search_alphabeta.htm)，另外附上伪代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">AlphaBeta</span><span class="params">(<span class="keyword">int</span> depth, <span class="keyword">int</span> alpha, <span class="keyword">int</span> beta)</span> </span>&#123;</div><div class="line">　<span class="keyword">if</span>(depth == <span class="number">0</span>) &#123;</div><div class="line">　　<span class="keyword">return</span> Evaluate();</div><div class="line">　&#125;</div><div class="line">　GenerateLegalMoves();</div><div class="line">　<span class="keyword">while</span>(MovesLeft()) &#123;</div><div class="line">　　MakeNextMove();</div><div class="line">　　val = -AlphaBeta(depth - <span class="number">1</span>, -beta, -alpha);</div><div class="line">　　UnmakeMove();</div><div class="line">　　<span class="keyword">if</span>(val &gt;= beta) &#123;</div><div class="line">　　　<span class="keyword">return</span> beta;</div><div class="line">　　&#125;</div><div class="line">　　<span class="keyword">if</span>(val &gt; alpha) &#123;</div><div class="line">　　　alpha = val;</div><div class="line">　　&#125;</div><div class="line">　&#125;</div><div class="line">　<span class="keyword">return</span> alpha;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><h3 id="再一次质的提升-启发式搜索"><a href="#再一次质的提升-启发式搜索" class="headerlink" title="再一次质的提升-启发式搜索"></a>再一次质的提升-启发式搜索</h3><pre><code>AlphaBeta剪枝有严重依赖于每一层节点扫描的顺序，因为前面节点生成的alpha直接决定了后面节点剪枝的多少。如果我们针对每一层生成的节点事先排好序，那么程序的速度将极大地提升。然而，对生成的节点进行绝对准确地排序是不可能的，因为需要巨大的运算量（等同于再进行一次alphabeta剪枝的搜索），所以我们只能对节点进行粗略地排好序。
在&quot;最初的思想&quot;中，我们已经讨论了如何对棋盘上的位置进行评分，我们可以利用这个评分，对生成的可能的点进行排序。排序开销小，然而对整体的搜索速度带来巨大的提升。加入此优化之后，五子棋可以轻松做到5层搜索。
</code></pre><h3 id="看起来不起眼的一个小优化"><a href="#看起来不起眼的一个小优化" class="headerlink" title="看起来不起眼的一个小优化"></a>看起来不起眼的一个小优化</h3><pre><code>在进行了AlphaBeta剪枝和启发式搜索之后，搜索依然只能进行到5层左右。6层还非常慢。
在启发式式搜索的优化中，已经对下一步可能出现的位置粗略地排好了序，极大地提高了AlphaBeta剪枝的效率。但是由于每层产生的点太多，导致计算机仍然需要搜索数量巨大的节点。
事实上，只要对位置进行评分的函数足够好，我们就可以保证最优解基本出现在排好序的节点的前十之中。所以我们只需要扫描产生的排好序的点的前十个点就ok了。这个不起眼的优化提升非常巨大，有了这个小优化之后，在一台好一点的电脑五子棋的搜索层数可以达到7层。棋力迅猛提升，在电脑先走的情况下基本打不赢电脑。
附上伪代码：
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">AlphaBeta</span><span class="params">(<span class="keyword">int</span> depth, <span class="keyword">int</span> alpha, <span class="keyword">int</span> beta)</span> </span>&#123;</div><div class="line">　<span class="keyword">if</span>(depth == <span class="number">0</span>) &#123;</div><div class="line">　　<span class="keyword">return</span> Evaluate();</div><div class="line">　&#125;</div><div class="line">　GenerateLegalMoves();</div><div class="line"></div><div class="line">  <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"></div><div class="line">　<span class="keyword">while</span>(MovesLeft()) &#123;</div><div class="line">　　MakeNextMove();</div><div class="line">　　val = -AlphaBeta(depth - <span class="number">1</span>, -beta, -alpha);</div><div class="line">　　UnmakeMove();</div><div class="line">　　<span class="keyword">if</span>(val &gt;= beta) &#123;</div><div class="line">　　　<span class="keyword">return</span> beta;</div><div class="line">　　&#125;</div><div class="line">　　<span class="keyword">if</span>(val &gt; alpha) &#123;</div><div class="line">　　　alpha = val;</div><div class="line">　　&#125;</div><div class="line">	<span class="keyword">if</span>(count++ &gt;= <span class="number">10</span>)</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">　&#125;</div><div class="line">　<span class="keyword">return</span> alpha;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><h3 id="增加置换表以及悔棋功能"><a href="#增加置换表以及悔棋功能" class="headerlink" title="增加置换表以及悔棋功能"></a>增加置换表以及悔棋功能</h3><pre><code>到此，棋子力已经超过7层了。然而在搜索的过程中，还是会出现一些重复搜索的情况，例如：
[score3.jpg](/source/uploads/score3.jpg)
这时候，就要用到zobrist和置换表了，相关链接如下：
[http://www.xqbase.com/computer/struct_zobrist.htm](http://www.xqbase.com/computer/struct_zobrist.htm)
[http://www.xqbase.com/computer/search_hashing.htm](http://www.xqbase.com/computer/search_hashing.htm)
对于置换表，保存搜索过的棋局的哈希数组越大，速度就越快。但是这次的提升并没有前几次优化的提升那么明显，以为索引的计算以及记录也需要时间，况且总结点还那么大，加入了置换表之后搜索还是只能停留在7层。不过，总体来看，使用置换表对程序的性能来说还是有一定的提升的。使用置换表还有一个很有用的功能，那就是如果用户悔棋，然后再下的话，运算速度可以快不少，因为有的节点已经搜索过计算好保存在置换表中啦。
</code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><pre><code>好了，到此我们就完成了一个简易版但棋力还可以的五子棋AI。
下面是其对弈github中小有名气的五子棋项目[gobang](https://github.com/lihongxun945/gobang)的对弈结果，本讨论做的具有7层搜索能力的五子棋AI可以轻松打赢gobang（其实也可以打赢网上大部分的五子棋软件）。
[wuziqi1.jpg](/source/uploads/wuziqi1.jpg)
[wuziqi2.jpg](/source/uploads/wuziqi2.jpg)
最后附上下载链接：
[!https://kimlongli.github.io/files/fivechess.zip](https://kimlongli.github.io/files/fivechess.zip)
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/26/入门：使用React-Native设计一个计算器/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/26/入门：使用React-Native设计一个计算器/" itemprop="url">
                  入门：使用React Native设计一个计算器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-26T20:23:09+08:00">
                2016-11-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/26/入门：使用React-Native设计一个计算器/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/26/入门：使用React-Native设计一个计算器/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>期末快要来了，各种大作业蜂拥而至，其中就包括于士琪的Java Web的大作业。为了摆脱历史性遗留的各种管理系统(…)，我决定做一个简单版的微信，考虑对原生Android开发并不是很熟悉（特别是界面），还有微信小程序的出现，还有越来越火看起来势不可挡的React Native以及其跨平台性，还考虑到React Native的简单易用(好吧，被看穿了)，我决定用React Native和JSP(这个是必须的了)来做这次的Java Web大作业。在此之前，先做一个简单的计算器来练练手。</p>
<h3 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h3><h5 id="界面设计"><a href="#界面设计" class="headerlink" title="界面设计"></a>界面设计</h5><p>先看看实现后的效果<br><img src="/uploads/calculator.jpg" alt="calculator.jpg"><br>界面设计思路如下：</p>
<ul>
<li>整个程序界面为一个大的container(style.container)</li>
<li>大界面分为两个部分，一个是显示区域(style.displayContainer)（顶部显示输入的数字的区域），一个是输入区域(style.inputContainer)（下面的按钮区域）</li>
<li>显示区域只包含一个Text组件</li>
<li>输入区域包含许多行(style.inputBoxRow)</li>
<li>每一行包含若干个按钮(style.inputBox)</li>
</ul>
<p>inputButton（界面中的按钮）类代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InputButton</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span>( </div><div class="line">      &lt;TouchableHighlight style=&#123;style.inputBox&#125; onPress=&#123;this.props.onPress&#125;&gt;</div><div class="line">        &lt;Text style=&#123;style.inputBoxText&#125;&gt;&#123;this.props.value&#125;&lt;/Text&gt;</div><div class="line">      &lt;/TouchableHighlight&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>主类（Calculator）程序中的render代码以及绘制按钮的函数代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Calculator</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">	...</div><div class="line">	_renderInputBoxes() &#123;</div><div class="line">	    <span class="keyword">var</span> result = [];</div><div class="line">	    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</div><div class="line">	      	<span class="keyword">var</span> inputRow = [];</div><div class="line">	      	<span class="keyword">for</span>(<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</div><div class="line">	        	inputRow.push(&lt;InputButton key=&#123;"inputBox" + i + j&#125; value=&#123;inputButtons[i][j]&#125; onPress=&#123;this._onPressButton.bind(this, inputButtons[i][j])&#125; /&gt;);</div><div class="line">	      	&#125;</div><div class="line">	      	result.push(&lt;View style=&#123;style.inputBoxRow&#125; key=&#123;"inputBoxRow" + i&#125;&gt;&#123;inputRow&#125;&lt;/View&gt;);</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    return result;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	render() &#123;</div><div class="line">	    return(</div><div class="line">			&lt;View style=&#123;style.container&#125;&gt;</div><div class="line">				&lt;View style=&#123;style.displayContainer&#125;&gt;</div><div class="line">				  	&lt;Text style=&#123;style.displayText&#125;&gt;&#123;this.state.displayContent&#125;&lt;/Text&gt;</div><div class="line">				&lt;/View&gt;</div><div class="line">				&lt;View style=&#123;style.inputContainer&#125;&gt;</div><div class="line">				  	&#123;this._renderInputBoxes()&#125;</div><div class="line">				&lt;/View&gt;</div><div class="line">			&lt;/View&gt;</div><div class="line">	    );</div><div class="line">	  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>噢对了，还有样式定义的代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> style = StyleSheet.create(&#123;</div><div class="line">	<span class="attr">container</span>: &#123;</div><div class="line">		<span class="attr">flex</span>: <span class="number">1</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">displayContainer</span>: &#123;</div><div class="line">		<span class="attr">flex</span>: <span class="number">2</span>,</div><div class="line">		<span class="attr">backgroundColor</span>: <span class="string">'#183442'</span>,</div><div class="line">		<span class="attr">justifyContent</span>: <span class="string">'center'</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">displayText</span>: &#123;</div><div class="line">		<span class="attr">fontSize</span>: <span class="number">70</span>,</div><div class="line">		<span class="attr">flex</span>: <span class="number">1</span>,</div><div class="line">		<span class="attr">textAlign</span>: <span class="string">'right'</span>,</div><div class="line">		<span class="attr">color</span>: <span class="string">'white'</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">inputContainer</span>: &#123;</div><div class="line">		<span class="attr">flex</span>: <span class="number">8</span>,</div><div class="line">		<span class="attr">backgroundColor</span>: <span class="string">'#3d6070'</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">inputBoxRow</span>: &#123;</div><div class="line">		<span class="attr">flex</span>: <span class="number">1</span>,</div><div class="line">		<span class="attr">flexDirection</span>: <span class="string">'row'</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">inputBox</span>: &#123;</div><div class="line">		<span class="attr">flex</span>: <span class="number">1</span>,</div><div class="line">		<span class="attr">alignItems</span>: <span class="string">'center'</span>,</div><div class="line">		<span class="attr">justifyContent</span>: <span class="string">'center'</span>,</div><div class="line">		<span class="attr">borderWidth</span>: <span class="number">0.5</span>,</div><div class="line">		<span class="attr">borderColor</span>: <span class="string">'#91AA9D'</span></div><div class="line">	&#125;,</div><div class="line">	<span class="attr">inputBoxText</span>: &#123;</div><div class="line">		<span class="attr">fontSize</span>: <span class="number">70</span>,</div><div class="line">		<span class="attr">color</span>: <span class="string">'white'</span>,</div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h5 id="逻辑设计"><a href="#逻辑设计" class="headerlink" title="逻辑设计"></a>逻辑设计</h5><p>接下来就是逻辑设计了，首先看看主类的state<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">constructor</span>(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line">    <span class="keyword">this</span>.state = &#123;</div><div class="line">		<span class="attr">displayContent</span>: <span class="string">""</span>,</div><div class="line">		<span class="attr">saveNumber</span>: <span class="number">0.0</span>,</div><div class="line">		<span class="attr">saveOperator</span>: <span class="string">'+'</span>,</div><div class="line">		<span class="attr">haveDot</span>: <span class="literal">false</span>,</div><div class="line">		<span class="attr">mode</span>: <span class="number">0</span>,</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>思路如下：<br>程序通过一个mode变量来记录程序的状态（一个自动机）。</p>
<ul>
<li>当mode为0，数字键按下时候，mode立即变为1，显示的内容被设置为刚才按下的键的内容；其它键按下无效。</li>
<li>当mode为1，数字键按下的时候，把按下的键的内容加到显示内容的末尾；当符号键（加减乘除）按下的时候，mode变成2，并把当前显示的内容保存到saveNumber变量中；</li>
<li>当mode为2，数字键按下时候，mode立即变为3，显示的内容被设置为刚才按下的键的内容；其它键按下无效。</li>
<li>当mode为3，数字键按下的时候，把按下的键的内容加到显示内容的末尾；当等号键按下的时候，计算结果并显示到屏幕，mode变为0；</li>
<li>循环</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">_setOperator(ch) &#123;</div><div class="line">    <span class="keyword">if</span>(ch == <span class="string">'+'</span> || ch == <span class="string">'-'</span> || ch == <span class="string">'*'</span> || ch == <span class="string">'/'</span>) &#123;</div><div class="line">      <span class="keyword">let</span> number = <span class="built_in">parseFloat</span>(<span class="keyword">this</span>.state.displayContent);</div><div class="line">      <span class="keyword">this</span>.setState(&#123;<span class="attr">saveOperator</span>: ch, <span class="attr">mode</span>: <span class="number">2</span>, <span class="attr">saveNumber</span>: number&#125;);</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"> &#125;</div><div class="line"> _onPressButton(ch) &#123;</div><div class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>._setOperator(ch)) &#123;</div><div class="line">      <span class="keyword">if</span>(ch == <span class="string">'='</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state.mode == <span class="number">0</span> || <span class="keyword">this</span>.state.mode == <span class="number">2</span>)</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">let</span> result = <span class="built_in">eval</span>(<span class="keyword">this</span>.state.saveNumber + <span class="keyword">this</span>.state.saveOperator + <span class="keyword">this</span>.state.displayContent);</div><div class="line">        <span class="keyword">if</span>(result % <span class="number">1</span> === <span class="number">0</span>)</div><div class="line">          <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: result, <span class="attr">mode</span>: <span class="number">0</span>&#125;);</div><div class="line">        <span class="keyword">else</span></div><div class="line">          <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: result.toFixed(<span class="number">3</span>), <span class="attr">mode</span>: <span class="number">0</span>&#125;);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.mode == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: ch.toString(), <span class="attr">mode</span>: <span class="number">1</span>, <span class="attr">haveDot</span>: <span class="literal">false</span>&#125;);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.mode == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state.haveDot &amp;&amp; ch == <span class="string">'.'</span>)</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: <span class="keyword">this</span>.state.displayContent + ch.toString()&#125;);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.mode == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: ch.toString(), <span class="attr">mode</span>: <span class="number">3</span>, <span class="attr">haveDot</span>: <span class="literal">false</span>&#125;);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.mode == <span class="number">3</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state.haveDot &amp;&amp; ch == <span class="string">'.'</span>)</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: <span class="keyword">this</span>.state.displayContent + ch.toString()&#125;);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span>(ch == <span class="string">'.'</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">haveDot</span>: <span class="literal">true</span>&#125;);</div><div class="line"></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="打包发布应用"><a href="#打包发布应用" class="headerlink" title="打包发布应用"></a>打包发布应用</h3><p>停留在Debug版本的React Native应用运行时候是需要连接开发服务器的（默认是本机的8081端口），这样的话，就不能把debug版本的apk发送到其它系统上去运行了。解决办法是生成签名（因为没有root权限的安卓系统不允许没有签名的应用安装），把应用打包成release版本的apk，然后就可以发送到其它系统去测试了。步骤如下：</p>
<ul>
<li><p>生成密钥<br>进入android/app/，运行如下命令生成签名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">keytool -genkey -v -keystore my-test-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000</div></pre></td></tr></table></figure>
</li>
<li><p>创建assets文件夹<br>在android/app/src/main下创建assets文件夹</p>
</li>
<li><p>获取bundle文件并保存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -k <span class="string">"http://localhost:8081/index.android.bundle"</span> &gt; android/app/src/main/assets/index.android.bundle</div></pre></td></tr></table></figure>
</li>
<li><p>添加gradle的keystore配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">//在 defaultConfig 后面添加</div><div class="line">signingConfigs &#123;</div><div class="line">    release &#123;</div><div class="line">        storeFile file(&quot;/my-test-key.keystore&quot;) //替换成你实际密匙文件所在位置</div><div class="line">        storePassword  &quot;生成密钥步骤中的密码&quot;　　</div><div class="line">        keyAlias  &quot;my-key-alias&quot;　　　　</div><div class="line">        keyPassword  &quot;生成密钥步骤中的密码&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">//修改原来的配置，主要是加入 signingConfig 这一行</div><div class="line">buildTypes &#123;</div><div class="line">    release &#123;</div><div class="line">        minifyEnabled enableProguardInReleaseBuilds</div><div class="line">        proguardFiles fetDefaultProguardFile(&apos;proguard-android.txt), &apos;proguard-rules.pro&apos; </div><div class="line">        signingConfig signingConfigs.release</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>执行打包脚本<br>进入android目录，执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./gradlew assembleRelease</div></pre></td></tr></table></figure>
</li>
<li><p>发布应用<br>拷贝android/app/build/outputs/apk下的apk文件（release版本）发送到你想要测试的系统上安装运行即可。</p>
</li>
</ul>
<p><img src="/uploads/calculator1.jpg" alt="calculator1.jpg"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/25/笔记：Java中的反射机制/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/25/笔记：Java中的反射机制/" itemprop="url">
                  笔记：Java中的反射机制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-25T17:30:25+08:00">
                2016-11-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/25/笔记：Java中的反射机制/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/25/笔记：Java中的反射机制/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><blockquote>
<p>JAVA反射机制是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意方法和属性；这种动态获取信息以及动态调用对象方法的功能称为java语言的反射机制。JAVA反射（放射）机制：“程序运行时，允许改变程序结构或变量类型，这种语言称为动态语言”。从这个观点看，Perl，Python，Ruby是动态语言，C++，Java，C#不是动态语言。但是JAVA有着一个非常突出的动态相关机制：Reflection，用在Java身上指的是我们可以于运行时加载、探知、使用编译期间完全未知的classes。换句话说，Java程序可以加载一个运行时才得知名称的class，获悉其完整构造（但不包括methods定义），并生成其对象实体、或对其fields设值、或唤起其methods。 —-摘自某百科</p>
</blockquote>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> MyTest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Field;</div><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"><span class="keyword">import</span> java.io.Serializable;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Human</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> age = <span class="number">0</span>;</div><div class="line">	<span class="keyword">private</span> String name = <span class="string">""</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> age;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String []args)</span> </span>&#123;</div><div class="line">		Human human = <span class="keyword">new</span> Human();</div><div class="line"></div><div class="line">		<span class="comment">//获取class对象，方式一</span></div><div class="line">		System.out.println(<span class="string">"###获取class对象，方式一###"</span>);</div><div class="line">		Class&lt;Human&gt; c1 = Human.class;</div><div class="line">		System.out.println(c1);</div><div class="line"></div><div class="line">		<span class="comment">//方式二</span></div><div class="line">		System.out.println(<span class="string">"###方式二###"</span>);</div><div class="line">		Class&lt;? extends Human&gt; c2 = human.getClass();</div><div class="line">		System.out.println(c2);</div><div class="line"></div><div class="line">		<span class="comment">//方式三</span></div><div class="line">		System.out.println(<span class="string">"###方式三###"</span>);</div><div class="line">		Class&lt;?&gt; c3 = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			c3 = Class.forName(<span class="string">"MyTest.Human"</span>);</div><div class="line">		&#125; <span class="keyword">catch</span>(ClassNotFoundException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		System.out.println(c3);</div><div class="line"></div><div class="line">		<span class="comment">//生成对象</span></div><div class="line">		System.out.println(<span class="string">"###生成对象###"</span>);</div><div class="line">		Human h3 = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			h3 = (Human)c3.newInstance();</div><div class="line">		&#125; <span class="keyword">catch</span>(InstantiationException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span>(IllegalAccessException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		h3.setName(<span class="string">"lijinlong"</span>);</div><div class="line">		System.out.println(h3.getName());</div><div class="line"></div><div class="line"></div><div class="line">		<span class="comment">//获取构造函数</span></div><div class="line">		System.out.println(<span class="string">"###获取构造函数###"</span>);</div><div class="line">		Constructor&lt;?&gt; con3 = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			con3 = c3.getConstructor(String.class, <span class="keyword">int</span>.class);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span>(NoSuchMethodException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; </div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			h3 = (Human)con3.newInstance(<span class="string">"zhouyi"</span>, <span class="number">19</span>);</div><div class="line">		&#125; <span class="keyword">catch</span>(InstantiationException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span>(IllegalAccessException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span>(InvocationTargetException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		System.out.println(h3.getName());</div><div class="line"></div><div class="line"></div><div class="line">		<span class="comment">//取得类的构造方法</span></div><div class="line">		System.out.println(<span class="string">"###获取类的构造方法###"</span>);</div><div class="line">		Constructor&lt;?&gt;[] cons = c3.getConstructors();</div><div class="line">		System.out.println(Arrays.toString(cons));</div><div class="line"></div><div class="line">		<span class="comment">//取得接口</span></div><div class="line">		System.out.println(<span class="string">"###取得接口###"</span>);</div><div class="line">		Class&lt;?&gt;[] interfaces = c3.getInterfaces();</div><div class="line">		System.out.println(Arrays.toString(interfaces));</div><div class="line"></div><div class="line">		<span class="comment">//取得父类(Java中不允许多继承，所以只有一个)</span></div><div class="line">		System.out.println(<span class="string">"###取得父类###"</span>);</div><div class="line">		Class&lt;?&gt; superClass = c3.getSuperclass();</div><div class="line">		System.out.println(superClass);</div><div class="line"></div><div class="line">		<span class="comment">//取得类的所有方法</span></div><div class="line">		System.out.println(<span class="string">"###取得类的所有方法###"</span>);</div><div class="line">		Method []methods = c3.getMethods();</div><div class="line">		System.out.println(Arrays.toString(methods));</div><div class="line"></div><div class="line">		<span class="comment">//调用获取的方法</span></div><div class="line">		System.out.println(<span class="string">"###调用获取的方法###"</span>);</div><div class="line">		Method method = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			method = c3.getMethod(<span class="string">"setName"</span>, String.class);</div><div class="line">		&#125; <span class="keyword">catch</span>(NoSuchMethodException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			method.invoke(h3, <span class="string">"seer"</span>);</div><div class="line">		&#125; <span class="keyword">catch</span>(IllegalAccessException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span>(InvocationTargetException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		System.out.println(h3.getName());</div><div class="line">		</div><div class="line"></div><div class="line"></div><div class="line">		<span class="comment">//获取类的属性，并改变属性值</span></div><div class="line">		System.out.println(<span class="string">"###获取类的属性，并改变属性值###"</span>);</div><div class="line">		h3.setName(<span class="string">"rongjie"</span>);</div><div class="line">		Field nameField = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//也可以用getField，但是getField不可以获取私有变量</span></div><div class="line">			nameField = c3.getDeclaredField(<span class="string">"name"</span>);</div><div class="line">		&#125; <span class="keyword">catch</span>(NoSuchFieldException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		nameField.setAccessible(<span class="keyword">true</span>);</div><div class="line">		String name = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			nameField.set(h3, <span class="string">"gear"</span>);</div><div class="line">			name = (String)nameField.get(h3);</div><div class="line">		&#125; <span class="keyword">catch</span>(IllegalAccessException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		System.out.println(name);</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###获取class对象，方式一###</span></div><div class="line">class MyTest.Human</div><div class="line"><span class="comment">###方式二###</span></div><div class="line">class MyTest.Human</div><div class="line"><span class="comment">###方式三###</span></div><div class="line">class MyTest.Human</div><div class="line"><span class="comment">###生成对象###</span></div><div class="line">lijinlong</div><div class="line"><span class="comment">###获取构造函数###</span></div><div class="line">zhouyi</div><div class="line"><span class="comment">###获取类的构造方法###</span></div><div class="line">[public MyTest.Human(), public MyTest.Human(java.lang.String,int)]</div><div class="line"><span class="comment">###取得接口###</span></div><div class="line">[interface java.io.Serializable]</div><div class="line"><span class="comment">###取得父类###</span></div><div class="line">class java.lang.Object</div><div class="line"><span class="comment">###取得类的所有方法###</span></div><div class="line">[public java.lang.String MyTest.Human.getName(), public void MyTest.Human.setName(java.lang.String), public void MyTest.Human.setAge(int), public int MyTest.Human.getAge(), public final void java.lang.Object.wait(long,int) throws java.lang.InterruptedException, public final native void java.lang.Object.wait(long) throws java.lang.InterruptedException, public final void java.lang.Object.wait() throws java.lang.InterruptedException, public boolean java.lang.Object.equals(java.lang.Object), public java.lang.String java.lang.Object.toString(), public native int java.lang.Object.hashCode(), public final native java.lang.Class java.lang.Object.getClass(), public final native void java.lang.Object.notify(), public final native void java.lang.Object.notifyAll()]</div><div class="line"><span class="comment">###调用获取的方法###</span></div><div class="line">seer</div><div class="line"><span class="comment">###获取类的属性，并改变属性值###</span></div><div class="line">gear</div></pre></td></tr></table></figure>
<p>```</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/19/Redis源代码分析之ziplist/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/19/Redis源代码分析之ziplist/" itemprop="url">
                  Redis源代码分析之ziplist
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-19T15:52:20+08:00">
                2016-11-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/19/Redis源代码分析之ziplist/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/19/Redis源代码分析之ziplist/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>ziplist.c的头部给出了ziplist的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* ZIPLIST OVERALL LAYOUT:</span></div><div class="line"> * The general layout of the ziplist is as follows:</div><div class="line"> * &lt;zlbytes&gt;&lt;zltail&gt;&lt;zllen&gt;&lt;entry&gt;&lt;entry&gt;&lt;zlend&gt;</div><div class="line"> *</div><div class="line"> * &lt;zlbytes&gt; is an unsigned integer to hold the number of bytes that the</div><div class="line"> * ziplist occupies. This value needs to be stored to be able to resize the</div><div class="line"> * entire structure without the need to traverse it first.</div><div class="line"> *</div><div class="line"> * &lt;zltail&gt; is the offset to the last entry in the list. This allows a pop</div><div class="line"> * operation on the far side of the list without the need for full traversal.</div><div class="line"> *</div><div class="line"> * &lt;zllen&gt; is the number of entries.When this value is larger than 2**16-2,</div><div class="line"> * we need to traverse the entire list to know how many items it holds.</div><div class="line"> *</div><div class="line"> * &lt;zlend&gt; is a single byte special value, equal to 255, which indicates the</div><div class="line"> * end of the list.</div><div class="line"> *</div><div class="line"> * ZIPLIST ENTRIES:</div><div class="line"> * Every entry in the ziplist is prefixed by a header that contains two pieces</div><div class="line"> * of information. First, the length of the previous entry is stored to be</div><div class="line"> * able to traverse the list from back to front. Second, the encoding with an</div><div class="line"> * optional string length of the entry itself is stored.</div><div class="line"> *</div><div class="line"> * The length of the previous entry is encoded in the following way:</div><div class="line"> * If this length is smaller than 254 bytes, it will only consume a single</div><div class="line"> * byte that takes the length as value. When the length is greater than or</div><div class="line"> * equal to 254, it will consume 5 bytes. The first byte is set to 254 to</div><div class="line"> * indicate a larger value is following. The remaining 4 bytes take the</div><div class="line"> * length of the previous entry as value.</div><div class="line"> *</div><div class="line"> * The other header field of the entry itself depends on the contents of the</div><div class="line"> * entry. When the entry is a string, the first 2 bits of this header will hold</div><div class="line"> * the type of encoding used to store the length of the string, followed by the</div><div class="line"> * actual length of the string. When the entry is an integer the first 2 bits</div><div class="line"> * are both set to 1. The following 2 bits are used to specify what kind of</div><div class="line"> * integer will be stored after this header. An overview of the different</div><div class="line"> * types and encodings is as follows:</div><div class="line"> *</div><div class="line"> * |00pppppp| - 1 byte</div><div class="line"> *      String value with length less than or equal to 63 bytes (6 bits).</div><div class="line"> * |01pppppp|qqqqqqqq| - 2 bytes</div><div class="line"> *      String value with length less than or equal to 16383 bytes (14 bits).</div><div class="line"> * |10______|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt| - 5 bytes</div><div class="line"> *      String value with length greater than or equal to 16384 bytes.</div><div class="line"> * |11000000| - 1 byte</div><div class="line"> *      Integer encoded as int16_t (2 bytes).</div><div class="line"> * |11010000| - 1 byte</div><div class="line"> *      Integer encoded as int32_t (4 bytes).</div><div class="line"> * |11100000| - 1 byte</div><div class="line"> *      Integer encoded as int64_t (8 bytes).</div><div class="line"> * |11110000| - 1 byte</div><div class="line"> *      Integer encoded as 24 bit signed (3 bytes).</div><div class="line"> * |11111110| - 1 byte</div><div class="line"> *      Integer encoded as 8 bit signed (1 byte).</div><div class="line"> * |1111xxxx| - (with xxxx between 0000 and 1101) immediate 4 bit integer.</div><div class="line"> *      Unsigned integer from 0 to 12. The encoded value is actually from</div><div class="line"> *      1 to 13 because 0000 and 1111 can not be used, so 1 should be</div><div class="line"> *      subtracted from the encoded 4 bit value to obtain the right value.</div><div class="line"> * |11111111| - End of ziplist.</div><div class="line"> *</div><div class="line"> * All the integers are represented in little endian byte order.</div><div class="line"> */</div></pre></td></tr></table></figure>
<p>由上面的的定义可以看出，ziplist大概看起来就是下面这样子<br><img src="/uploads/ziplist.jpg" alt="ziplist"></p>
<ul>
<li>其中zllen为4个字节，保存ziplist字节数；</li>
<li>zltail保存的是尾节点偏移量，4个字节；</li>
<li>zllen保存的是ziplist的长度，2个字节，ziplist的长度超出范围，只能通过遍历来知道ziplist的长度；</li>
<li><p>接着是一个个的entry，这是ziplist的节点，entry包含三个字段，第一个是prevlen，记录前一个节点的长度，方便逆向遍历，长度为1个字节或者5个字节，第二个是encoding，里面记录了data段的长度，1个字节到5个字节，最后的一个字段是data段，记录数据；</p>
</li>
<li><p>最后是zlend，结束标志，值为255</p>
</li>
</ul>
<h3 id="源代码分析"><a href="#源代码分析" class="headerlink" title="源代码分析"></a>源代码分析</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div><div class="line">856</div><div class="line">857</div><div class="line">858</div><div class="line">859</div><div class="line">860</div><div class="line">861</div><div class="line">862</div><div class="line">863</div><div class="line">864</div><div class="line">865</div><div class="line">866</div><div class="line">867</div><div class="line">868</div><div class="line">869</div><div class="line">870</div><div class="line">871</div><div class="line">872</div><div class="line">873</div><div class="line">874</div><div class="line">875</div><div class="line">876</div><div class="line">877</div><div class="line">878</div><div class="line">879</div><div class="line">880</div><div class="line">881</div><div class="line">882</div><div class="line">883</div><div class="line">884</div><div class="line">885</div><div class="line">886</div><div class="line">887</div><div class="line">888</div><div class="line">889</div><div class="line">890</div><div class="line">891</div><div class="line">892</div><div class="line">893</div><div class="line">894</div><div class="line">895</div><div class="line">896</div><div class="line">897</div><div class="line">898</div><div class="line">899</div><div class="line">900</div><div class="line">901</div><div class="line">902</div><div class="line">903</div><div class="line">904</div><div class="line">905</div><div class="line">906</div><div class="line">907</div><div class="line">908</div><div class="line">909</div><div class="line">910</div><div class="line">911</div><div class="line">912</div><div class="line">913</div><div class="line">914</div><div class="line">915</div><div class="line">916</div><div class="line">917</div><div class="line">918</div><div class="line">919</div><div class="line">920</div><div class="line">921</div><div class="line">922</div><div class="line">923</div><div class="line">924</div><div class="line">925</div><div class="line">926</div><div class="line">927</div><div class="line">928</div><div class="line">929</div><div class="line">930</div><div class="line">931</div><div class="line">932</div><div class="line">933</div><div class="line">934</div><div class="line">935</div><div class="line">936</div><div class="line">937</div><div class="line">938</div><div class="line">939</div><div class="line">940</div><div class="line">941</div><div class="line">942</div><div class="line">943</div><div class="line">944</div><div class="line">945</div><div class="line">946</div><div class="line">947</div><div class="line">948</div><div class="line">949</div><div class="line">950</div><div class="line">951</div><div class="line">952</div></pre></td><td class="code"><pre><div class="line">#define ZIP_END 255				//ziplist结尾zlend</div><div class="line">#define ZIP_BIGLEN 254			//zllen如果超过ZIP_BIGLEN的话，将会使用5个字节存储，不能使255，否则就跟zlend重复了</div><div class="line"></div><div class="line">/* Different encoding/length possibilities */</div><div class="line">#define ZIP_STR_MASK 0xc0</div><div class="line">#define ZIP_INT_MASK 0x30</div><div class="line">#define ZIP_STR_06B (0 &lt;&lt; 6)</div><div class="line">#define ZIP_STR_14B (1 &lt;&lt; 6)</div><div class="line">#define ZIP_STR_32B (2 &lt;&lt; 6)</div><div class="line">#define ZIP_INT_16B (0xc0 | 0&lt;&lt;4)</div><div class="line">#define ZIP_INT_32B (0xc0 | 1&lt;&lt;4)</div><div class="line">#define ZIP_INT_64B (0xc0 | 2&lt;&lt;4)</div><div class="line">#define ZIP_INT_24B (0xc0 | 3&lt;&lt;4)</div><div class="line">#define ZIP_INT_8B 0xfe</div><div class="line">/* 4 bit integer immediate encoding */</div><div class="line">#define ZIP_INT_IMM_MASK 0x0f</div><div class="line">#define ZIP_INT_IMM_MIN 0xf1    /* 11110001 */</div><div class="line">#define ZIP_INT_IMM_MAX 0xfd    /* 11111101 */</div><div class="line">#define ZIP_INT_IMM_VAL(v) (v &amp; ZIP_INT_IMM_MASK)</div><div class="line"></div><div class="line">#define INT24_MAX 0x7fffff</div><div class="line">#define INT24_MIN (-INT24_MAX - 1)</div><div class="line"></div><div class="line">/* Macro to determine type */</div><div class="line">#define ZIP_IS_STR(enc) (((enc) &amp; ZIP_STR_MASK) &lt; ZIP_STR_MASK)</div><div class="line"></div><div class="line">/* Utility macros */</div><div class="line">#define ZIPLIST_BYTES(zl)       (*((uint32_t*)(zl)))  //返回ziplist字节数</div><div class="line">#define ZIPLIST_TAIL_OFFSET(zl) (*((uint32_t*)((zl)+sizeof(uint32_t))))	//返回尾节点偏移量</div><div class="line">#define ZIPLIST_LENGTH(zl)      (*((uint16_t*)((zl)+sizeof(uint32_t)*2))) //返回ziplist的长度</div><div class="line">#define ZIPLIST_HEADER_SIZE     (sizeof(uint32_t)*2+sizeof(uint16_t)) //返回ziplist的头部长度，即zlbytes&gt;&lt;zltail&gt;&lt;zllen&gt;的长度</div><div class="line">#define ZIPLIST_END_SIZE        (sizeof(uint8_t))	//zlend的长度</div><div class="line">#define ZIPLIST_ENTRY_HEAD(zl)  ((zl)+ZIPLIST_HEADER_SIZE) //ziplist节点的开始位置</div><div class="line">#define ZIPLIST_ENTRY_TAIL(zl)  ((zl)+intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) //ziplist为尾部节点</div><div class="line">#define ZIPLIST_ENTRY_END(zl)   ((zl)+intrev32ifbe(ZIPLIST_BYTES(zl))-1) //ziplist结束符zlend</div><div class="line"></div><div class="line"></div><div class="line">//增加ziplist的长度</div><div class="line">#define ZIPLIST_INCR_LENGTH(zl,incr) &#123; \</div><div class="line">	//如果zllen的长度小于2**16 -  1，那么zllen = zllen + 1，否则不加1，这样的话求ziplist长度时候需要遍历整个ziplist才能知道zllen</div><div class="line">    if (ZIPLIST_LENGTH(zl) &lt; UINT16_MAX) \</div><div class="line">        ZIPLIST_LENGTH(zl) = intrev16ifbe(intrev16ifbe(ZIPLIST_LENGTH(zl))+incr); \</div><div class="line">&#125;</div><div class="line"></div><div class="line">//ziplist节点结构体（注：并非用来存储ziplist的原生数据）</div><div class="line">typedef struct zlentry &#123;</div><div class="line">    unsigned int prevrawlensize, prevrawlen;	//编码前一个节点的长度所需要的字节数，前一个节点的长度</div><div class="line">    unsigned int lensize, len; 	//编码本节点长度所需要的字节数，本字节的长度</div><div class="line">    unsigned int headersize; 	//ziplist的头长度，包括zlbytes,zltail,zllen</div><div class="line">    unsigned char encoding;		//数据编码</div><div class="line">    unsigned char *p;			//节点数据</div><div class="line">&#125; zlentry;</div><div class="line"></div><div class="line">//初始化zlentry</div><div class="line">#define ZIPLIST_ENTRY_ZERO(zle) &#123; \</div><div class="line">    (zle)-&gt;prevrawlensize = (zle)-&gt;prevrawlen = 0; \</div><div class="line">    (zle)-&gt;lensize = (zle)-&gt;len = (zle)-&gt;headersize = 0; \</div><div class="line">    (zle)-&gt;encoding = 0; \</div><div class="line">    (zle)-&gt;p = NULL; \</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Extract the encoding from the byte pointed by 'ptr' and set it into</div><div class="line"> * 'encoding'. */</div><div class="line">#define ZIP_ENTRY_ENCODING(ptr, encoding) do &#123;  \</div><div class="line">    (encoding) = (ptr[0]); \</div><div class="line">    if ((encoding) &lt; ZIP_STR_MASK) (encoding) &amp;= ZIP_STR_MASK; \</div><div class="line">&#125; while(0)</div><div class="line"></div><div class="line">void ziplistRepr(unsigned char *zl);</div><div class="line"></div><div class="line">//根据encoding来判断编码整数数据所需要的长度</div><div class="line">static unsigned int zipIntSize(unsigned char encoding) &#123;</div><div class="line">    switch(encoding) &#123;</div><div class="line">    case ZIP_INT_8B:  return 1;		//1个字节的整数</div><div class="line">    case ZIP_INT_16B: return 2;		//2</div><div class="line">    case ZIP_INT_24B: return 3;		//...</div><div class="line">    case ZIP_INT_32B: return 4;</div><div class="line">    case ZIP_INT_64B: return 8;</div><div class="line">    default: return 0; /* 4 bit immediate */</div><div class="line">    &#125;</div><div class="line">    assert(NULL);</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//给p写入encoding数据（字符串和整数分情况），如果p为空，则直接返回存储encoding所需要的长度</div><div class="line">static unsigned int zipEncodeLength(unsigned char *p, unsigned char encoding, unsigned int rawlen) &#123;</div><div class="line">    unsigned char len = 1, buf[5];</div><div class="line"></div><div class="line">    if (ZIP_IS_STR(encoding)) &#123;</div><div class="line">        /* Although encoding is given it may not be set for strings,</div><div class="line">         * so we determine it here using the raw length. */</div><div class="line">        if (rawlen &lt;= 0x3f) &#123;</div><div class="line">            if (!p) return len;</div><div class="line">            buf[0] = ZIP_STR_06B | rawlen;</div><div class="line">        &#125; else if (rawlen &lt;= 0x3fff) &#123;</div><div class="line">            len += 1;</div><div class="line">            if (!p) return len;</div><div class="line">            buf[0] = ZIP_STR_14B | ((rawlen &gt;&gt; 8) &amp; 0x3f);</div><div class="line">            buf[1] = rawlen &amp; 0xff;</div><div class="line">        &#125; else &#123;</div><div class="line">            len += 4;</div><div class="line">            if (!p) return len;</div><div class="line">            buf[0] = ZIP_STR_32B;</div><div class="line">            buf[1] = (rawlen &gt;&gt; 24) &amp; 0xff;</div><div class="line">            buf[2] = (rawlen &gt;&gt; 16) &amp; 0xff;</div><div class="line">            buf[3] = (rawlen &gt;&gt; 8) &amp; 0xff;</div><div class="line">            buf[4] = rawlen &amp; 0xff;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        //如果是整数直接返回1（整数encoding只需要一个字节来保存）</div><div class="line">        if (!p) return len;</div><div class="line">        buf[0] = encoding;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Store this length at p */</div><div class="line">    memcpy(p,buf,len);</div><div class="line">    return len;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//解码ptr位置的encoding，把编码长度赋值给lensize，把data段长度赋值给len</div><div class="line">#define ZIP_DECODE_LENGTH(ptr, encoding, lensize, len) do &#123;                    \</div><div class="line">    ZIP_ENTRY_ENCODING((ptr), (encoding));                                     \</div><div class="line">    if ((encoding) &lt; ZIP_STR_MASK) &#123;                                           \</div><div class="line">        if ((encoding) == ZIP_STR_06B) &#123;                                       \</div><div class="line">            (lensize) = 1;                                                     \</div><div class="line">            (len) = (ptr)[0] &amp; 0x3f;                                           \</div><div class="line">        &#125; else if ((encoding) == ZIP_STR_14B) &#123;                                \</div><div class="line">            (lensize) = 2;                                                     \</div><div class="line">            (len) = (((ptr)[0] &amp; 0x3f) &lt;&lt; 8) | (ptr)[1];                       \</div><div class="line">        &#125; else if (encoding == ZIP_STR_32B) &#123;                                  \</div><div class="line">            (lensize) = 5;                                                     \</div><div class="line">            (len) = ((ptr)[1] &lt;&lt; 24) |                                         \</div><div class="line">                    ((ptr)[2] &lt;&lt; 16) |                                         \</div><div class="line">                    ((ptr)[3] &lt;&lt;  8) |                                         \</div><div class="line">                    ((ptr)[4]);                                                \</div><div class="line">        &#125; else &#123;                                                               \</div><div class="line">            assert(NULL);                                                      \</div><div class="line">        &#125;                                                                      \</div><div class="line">    &#125; else &#123;                                                                   \</div><div class="line">        (lensize) = 1;                                                         \</div><div class="line">        (len) = zipIntSize(encoding);                                          \</div><div class="line">    &#125;                                                                          \</div><div class="line">&#125; while(0);</div><div class="line"></div><div class="line">//根据前一个节点的长度len在指针p的位置编码prevlen，如果p为NULL，则返回编码该prevlen所需要的长度</div><div class="line">static unsigned int zipPrevEncodeLength(unsigned char *p, unsigned int len) &#123;</div><div class="line">    if (p == NULL) &#123;</div><div class="line">        //如果len小于254，则用一个字节编码即可，如果不是则要5个字节</div><div class="line">        return (len &lt; ZIP_BIGLEN) ? 1 : sizeof(len)+1;</div><div class="line">    &#125; else &#123;</div><div class="line">        if (len &lt; ZIP_BIGLEN) &#123;</div><div class="line">            //写数据</div><div class="line">            p[0] = len;</div><div class="line">            return 1;</div><div class="line">        &#125; else &#123;</div><div class="line">            p[0] = ZIP_BIGLEN;</div><div class="line">            memcpy(p+1,&amp;len,sizeof(len));</div><div class="line">            memrev32ifbe(p+1);</div><div class="line">            return 1+sizeof(len);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//prevlen的编码，用于prevlen如果大于254的情况下</div><div class="line">static void zipPrevEncodeLengthForceLarge(unsigned char *p, unsigned int len) &#123;</div><div class="line">    if (p == NULL) return;</div><div class="line">    //前一个字节赋值为254，后面的四个字节保存len</div><div class="line">    p[0] = ZIP_BIGLEN;</div><div class="line">    memcpy(p+1,&amp;len,sizeof(len));</div><div class="line">    memrev32ifbe(p+1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回在ptr位置的prevlen的编码长度</div><div class="line">#define ZIP_DECODE_PREVLENSIZE(ptr, prevlensize) do &#123;                          \</div><div class="line">    if ((ptr)[0] &lt; ZIP_BIGLEN) &#123;                                               \</div><div class="line">        (prevlensize) = 1;                                                     \</div><div class="line">    &#125; else &#123;                                                                   \</div><div class="line">        (prevlensize) = 5;                                                     \</div><div class="line">    &#125;                                                                          \</div><div class="line">&#125; while(0);</div><div class="line"></div><div class="line">//解码在ptr位置的prevlen，把它的值保存在prevlen变量中</div><div class="line">#define ZIP_DECODE_PREVLEN(ptr, prevlensize, prevlen) do &#123;                     \</div><div class="line">    //先获取编码长度</div><div class="line">    ZIP_DECODE_PREVLENSIZE(ptr, prevlensize);                                  \</div><div class="line">    if ((prevlensize) == 1) &#123;                                                  \</div><div class="line">        (prevlen) = (ptr)[0];                                                  \</div><div class="line">    &#125; else if ((prevlensize) == 5) &#123;                                           \</div><div class="line">        assert(sizeof((prevlensize)) == 4);                                    \</div><div class="line">        memcpy(&amp;(prevlen), ((char*)(ptr)) + 1, 4);                             \</div><div class="line">        memrev32ifbe(&amp;prevlen);                                                \</div><div class="line">    &#125;                                                                          \</div><div class="line">&#125; while(0);</div><div class="line"></div><div class="line">//计算新的prevlen与旧的prevlen相差的字节数</div><div class="line">static int zipPrevLenByteDiff(unsigned char *p, unsigned int len) &#123;</div><div class="line">    unsigned int prevlensize;</div><div class="line">    //先获取旧的prevlen的编码长度</div><div class="line">    ZIP_DECODE_PREVLENSIZE(p, prevlensize);</div><div class="line">    //用现在需要的长度减去旧的prevlen的编码长度，算出diff</div><div class="line">    return zipPrevEncodeLength(NULL, len) - prevlensize;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//算出整个节点的长度</div><div class="line">static unsigned int zipRawEntryLength(unsigned char *p) &#123;</div><div class="line">    unsigned int prevlensize, encoding, lensize, len;</div><div class="line">    //先获取prevlen的编码长度</div><div class="line">    ZIP_DECODE_PREVLENSIZE(p, prevlensize);</div><div class="line">    //在获取encoding的编码长度lensize，和解码出data段的长度，len</div><div class="line">    ZIP_DECODE_LENGTH(p + prevlensize, encoding, lensize, len);</div><div class="line">    //加起来就是一个节点的总长度，</div><div class="line">    return prevlensize + lensize + len;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//尝试把字符串entry转换成整形，存在v中</div><div class="line">static int zipTryEncoding(unsigned char *entry, unsigned int entrylen, long long *v, unsigned char *encoding) &#123;</div><div class="line">    long long value;</div><div class="line"></div><div class="line">    //字符串长度超过32位或者字符串长度为0的时候，直接返回0</div><div class="line">    if (entrylen &gt;= 32 || entrylen == 0) return 0;</div><div class="line">    //如果可以转换的话</div><div class="line">    if (string2ll((char*)entry,entrylen,&amp;value)) &#123;</div><div class="line">        //判断转换出来的整数处于什么范围，选择最短的编码长度</div><div class="line">        if (value &gt;= 0 &amp;&amp; value &lt;= 12) &#123;</div><div class="line">            *encoding = ZIP_INT_IMM_MIN+value;</div><div class="line">        &#125; else if (value &gt;= INT8_MIN &amp;&amp; value &lt;= INT8_MAX) &#123;</div><div class="line">            *encoding = ZIP_INT_8B;</div><div class="line">        &#125; else if (value &gt;= INT16_MIN &amp;&amp; value &lt;= INT16_MAX) &#123;</div><div class="line">            *encoding = ZIP_INT_16B;</div><div class="line">        &#125; else if (value &gt;= INT24_MIN &amp;&amp; value &lt;= INT24_MAX) &#123;</div><div class="line">            *encoding = ZIP_INT_24B;</div><div class="line">        &#125; else if (value &gt;= INT32_MIN &amp;&amp; value &lt;= INT32_MAX) &#123;</div><div class="line">            *encoding = ZIP_INT_32B;</div><div class="line">        &#125; else &#123;</div><div class="line">            *encoding = ZIP_INT_64B;</div><div class="line">        &#125;</div><div class="line">        *v = value;</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//保存值在p位置，以encoding的格式保存</div><div class="line">static void zipSaveInteger(unsigned char *p, int64_t value, unsigned char encoding) &#123;</div><div class="line">    int16_t i16;</div><div class="line">    int32_t i32;</div><div class="line">    int64_t i64;</div><div class="line">    //判断encoding的类型，根据类型来写入value值在data段</div><div class="line">    if (encoding == ZIP_INT_8B) &#123;</div><div class="line">        ((int8_t*)p)[0] = (int8_t)value;</div><div class="line">    &#125; else if (encoding == ZIP_INT_16B) &#123;</div><div class="line">        i16 = value;</div><div class="line">        memcpy(p,&amp;i16,sizeof(i16));</div><div class="line">        memrev16ifbe(p);</div><div class="line">    &#125; else if (encoding == ZIP_INT_24B) &#123;</div><div class="line">        i32 = value&lt;&lt;8;</div><div class="line">        memrev32ifbe(&amp;i32);</div><div class="line">        memcpy(p,((uint8_t*)&amp;i32)+1,sizeof(i32)-sizeof(uint8_t));</div><div class="line">    &#125; else if (encoding == ZIP_INT_32B) &#123;</div><div class="line">        i32 = value;</div><div class="line">        memcpy(p,&amp;i32,sizeof(i32));</div><div class="line">        memrev32ifbe(p);</div><div class="line">    &#125; else if (encoding == ZIP_INT_64B) &#123;</div><div class="line">        i64 = value;</div><div class="line">        memcpy(p,&amp;i64,sizeof(i64));</div><div class="line">        memrev64ifbe(p);</div><div class="line">    &#125; else if (encoding &gt;= ZIP_INT_IMM_MIN &amp;&amp; encoding &lt;= ZIP_INT_IMM_MAX) &#123;</div><div class="line">        /* Nothing to do, the value is stored in the encoding itself. */</div><div class="line">    &#125; else &#123;</div><div class="line">        assert(NULL);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//根据encoding来读取Integer，原理同上，注释略</div><div class="line">static int64_t zipLoadInteger(unsigned char *p, unsigned char encoding) &#123;</div><div class="line">    int16_t i16;</div><div class="line">    int32_t i32;</div><div class="line">    int64_t i64, ret = 0;</div><div class="line">    if (encoding == ZIP_INT_8B) &#123;</div><div class="line">        ret = ((int8_t*)p)[0];</div><div class="line">    &#125; else if (encoding == ZIP_INT_16B) &#123;</div><div class="line">        memcpy(&amp;i16,p,sizeof(i16));</div><div class="line">        memrev16ifbe(&amp;i16);</div><div class="line">        ret = i16;</div><div class="line">    &#125; else if (encoding == ZIP_INT_32B) &#123;</div><div class="line">        memcpy(&amp;i32,p,sizeof(i32));</div><div class="line">        memrev32ifbe(&amp;i32);</div><div class="line">        ret = i32;</div><div class="line">    &#125; else if (encoding == ZIP_INT_24B) &#123;</div><div class="line">        i32 = 0;</div><div class="line">        memcpy(((uint8_t*)&amp;i32)+1,p,sizeof(i32)-sizeof(uint8_t));</div><div class="line">        memrev32ifbe(&amp;i32);</div><div class="line">        ret = i32&gt;&gt;8;</div><div class="line">    &#125; else if (encoding == ZIP_INT_64B) &#123;</div><div class="line">        memcpy(&amp;i64,p,sizeof(i64));</div><div class="line">        memrev64ifbe(&amp;i64);</div><div class="line">        ret = i64;</div><div class="line">    &#125; else if (encoding &gt;= ZIP_INT_IMM_MIN &amp;&amp; encoding &lt;= ZIP_INT_IMM_MAX) &#123;</div><div class="line">        ret = (encoding &amp; ZIP_INT_IMM_MASK)-1;</div><div class="line">    &#125; else &#123;</div><div class="line">        assert(NULL);</div><div class="line">    &#125;</div><div class="line">    return ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//解码节点信息，保存在结构体e中</div><div class="line">static void zipEntry(unsigned char *p, zlentry *e) &#123;</div><div class="line">    //获取prevlen，以及其编码长度</div><div class="line">    ZIP_DECODE_PREVLEN(p, e-&gt;prevrawlensize, e-&gt;prevrawlen);</div><div class="line">    //获取encoding和其编码长度，和data段的长度len</div><div class="line">    ZIP_DECODE_LENGTH(p + e-&gt;prevrawlensize, e-&gt;encoding, e-&gt;lensize, e-&gt;len);</div><div class="line">    //计算节点“头”的长度，即prevlen的编码长度加上encoding的编码长度</div><div class="line">    e-&gt;headersize = e-&gt;prevrawlensize + e-&gt;lensize;</div><div class="line">    e-&gt;p = p;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//创建一个新的ziplist</div><div class="line">unsigned char *ziplistNew(void) &#123;</div><div class="line">    unsigned int bytes = ZIPLIST_HEADER_SIZE+1;</div><div class="line">    unsigned char *zl = zmalloc(bytes);</div><div class="line">    ZIPLIST_BYTES(zl) = intrev32ifbe(bytes);</div><div class="line">    ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(ZIPLIST_HEADER_SIZE);</div><div class="line">    ZIPLIST_LENGTH(zl) = 0;</div><div class="line">    zl[bytes-1] = ZIP_END;</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//从新分配zl的大小</div><div class="line">static unsigned char *ziplistResize(unsigned char *zl, unsigned int len) &#123;</div><div class="line">    zl = zrealloc(zl,len);</div><div class="line">    ZIPLIST_BYTES(zl) = intrev32ifbe(len);</div><div class="line">    zl[len-1] = ZIP_END;</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//连锁更新函数，因为当插入一个新的节点时候，新节点的后一个元素的prevlen要重新编码，由此</div><div class="line">//新节点的后后个元素就又要更新prevlen了...由此导致一系列的连锁更新</div><div class="line">static unsigned char *__ziplistCascadeUpdate(unsigned char *zl, unsigned char *p) &#123;</div><div class="line">    size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), rawlen, rawlensize;</div><div class="line">    size_t offset, noffset, extra;</div><div class="line">    unsigned char *np;</div><div class="line">    zlentry cur, next;</div><div class="line"></div><div class="line">    //如果p还没到达尾部的话</div><div class="line">    while (p[0] != ZIP_END) &#123;</div><div class="line">        //解码p位置上的节点，把相关信息保存在cur结构体中</div><div class="line">        zipEntry(p, &amp;cur);</div><div class="line">        //整个节点的大小</div><div class="line">        rawlen = cur.headersize + cur.len;</div><div class="line">        //编码这个节点的大小所需要的字节数</div><div class="line">        rawlensize = zipPrevEncodeLength(NULL,rawlen);</div><div class="line"></div><div class="line">        //如果p位置所在的节点后面是zlend，也就是后面没有节点了，跳出</div><div class="line">        if (p[rawlen] == ZIP_END) break;</div><div class="line">        //把下一个节点的信息读取到next结构体中</div><div class="line">        zipEntry(p+rawlen, &amp;next);</div><div class="line"></div><div class="line">        //如果下一个节点的prevlen编码长度与编码rawlen所需要的长度一样，跳出</div><div class="line">        if (next.prevrawlen == rawlen) break;</div><div class="line"></div><div class="line">        //如果下一个节点的prevlen编码长度不够</div><div class="line">        if (next.prevrawlensize &lt; rawlensize) &#123;</div><div class="line">           </div><div class="line">            offset = p-zl;</div><div class="line">            //计算需要的额外空间extra</div><div class="line">            extra = rawlensize-next.prevrawlensize;</div><div class="line">            //重新分配</div><div class="line">            zl = ziplistResize(zl,curlen+extra);</div><div class="line">            p = zl+offset;</div><div class="line"></div><div class="line">            //np为下一个节点的位置</div><div class="line">            np = p+rawlen;</div><div class="line">            //noffset为下一个节点的偏移量</div><div class="line">            noffset = np-zl;</div><div class="line"></div><div class="line">            //如果np不是尾节点，则更新zltail，如果np是尾节点，则不用更新，因为np的位置相对之前没有变</div><div class="line">            if ((zl+intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) != np) &#123;</div><div class="line">                ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">                    intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+extra);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            //内存移动</div><div class="line">            memmove(np+rawlensize,</div><div class="line">                np+next.prevrawlensize,</div><div class="line">                curlen-noffset-next.prevrawlensize-1);</div><div class="line">            //把rawlen编码进np的prevlen字段中</div><div class="line">            zipPrevEncodeLength(np,rawlen);</div><div class="line"></div><div class="line">            //跟新p和curlen</div><div class="line">            p += rawlen;</div><div class="line">            curlen += extra;</div><div class="line">        &#125; else &#123;</div><div class="line">            //如果下一个节点的prevlen的编码长度比rawlensize要大</div><div class="line">            if (next.prevrawlensize &gt; rawlensize) &#123;</div><div class="line">                //这说明要缩小np的prevlen编码长度，但是我们采用懒惰策略，暂时不缩小prelen的编码长度，而是把rawlen先写入np的prevlen中</div><div class="line">                zipPrevEncodeLengthForceLarge(p+rawlen,rawlen);</div><div class="line">            &#125; else &#123;</div><div class="line">                //如果长度刚刚好，则编码rawlen到np的prevlen字段中</div><div class="line">                zipPrevEncodeLength(p+rawlen,rawlen);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            /* Stop here, as the raw length of "next" has not changed. */</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Delete "num" entries, starting at "p". Returns pointer to the ziplist. */</div><div class="line">static unsigned char *__ziplistDelete(unsigned char *zl, unsigned char *p, unsigned int num) &#123;</div><div class="line">    unsigned int i, totlen, deleted = 0;</div><div class="line">    size_t offset;</div><div class="line">    int nextdiff = 0;</div><div class="line">    zlentry first, tail;</div><div class="line"></div><div class="line">    zipEntry(p, &amp;first);</div><div class="line">    for (i = 0; p[0] != ZIP_END &amp;&amp; i &lt; num; i++) &#123;</div><div class="line">        p += zipRawEntryLength(p);</div><div class="line">        deleted++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    totlen = p-first.p;</div><div class="line">    if (totlen &gt; 0) &#123;</div><div class="line">        if (p[0] != ZIP_END) &#123;</div><div class="line">            /* Storing `prevrawlen` in this entry may increase or decrease the</div><div class="line">             * number of bytes required compare to the current `prevrawlen`.</div><div class="line">             * There always is room to store this, because it was previously</div><div class="line">             * stored by an entry that is now being deleted. */</div><div class="line">            nextdiff = zipPrevLenByteDiff(p,first.prevrawlen);</div><div class="line">            p -= nextdiff;</div><div class="line">            zipPrevEncodeLength(p,first.prevrawlen);</div><div class="line"></div><div class="line">            /* Update offset for tail */</div><div class="line">            ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">                intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))-totlen);</div><div class="line"></div><div class="line">            /* When the tail contains more than one entry, we need to take</div><div class="line">             * "nextdiff" in account as well. Otherwise, a change in the</div><div class="line">             * size of prevlen doesn't have an effect on the *tail* offset. */</div><div class="line">            zipEntry(p, &amp;tail);</div><div class="line">            if (p[tail.headersize+tail.len] != ZIP_END) &#123;</div><div class="line">                ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">                   intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+nextdiff);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            /* Move tail to the front of the ziplist */</div><div class="line">            memmove(first.p,p,</div><div class="line">                intrev32ifbe(ZIPLIST_BYTES(zl))-(p-zl)-1);</div><div class="line">        &#125; else &#123;</div><div class="line">            /* The entire tail was deleted. No need to move memory. */</div><div class="line">            ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">                intrev32ifbe((first.p-zl)-first.prevrawlen);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        /* Resize and update length */</div><div class="line">        offset = first.p-zl;</div><div class="line">        zl = ziplistResize(zl, intrev32ifbe(ZIPLIST_BYTES(zl))-totlen+nextdiff);</div><div class="line">        ZIPLIST_INCR_LENGTH(zl,-deleted);</div><div class="line">        p = zl+offset;</div><div class="line"></div><div class="line">        /* When nextdiff != 0, the raw length of the next entry has changed, so</div><div class="line">         * we need to cascade the update throughout the ziplist */</div><div class="line">        if (nextdiff != 0)</div><div class="line">            zl = __ziplistCascadeUpdate(zl,p);</div><div class="line">    &#125;</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Insert item at "p". */</div><div class="line">//在位置p中插入节点，数据后移</div><div class="line">static unsigned char *__ziplistInsert(unsigned char *zl, unsigned char *p, unsigned char *s, unsigned int slen) &#123;</div><div class="line">    size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), reqlen;</div><div class="line">    unsigned int prevlensize, prevlen = 0;</div><div class="line">    size_t offset;</div><div class="line">    int nextdiff = 0;</div><div class="line">    unsigned char encoding = 0;</div><div class="line">    long long value = 123456789; /* initialized to avoid warning. Using a value</div><div class="line">                                    that is easy to see if for some reason</div><div class="line">                                    we use it uninitialized. */</div><div class="line">    zlentry tail;	</div><div class="line"></div><div class="line">    //判断位置p是不是zlend</div><div class="line">    if (p[0] != ZIP_END) &#123;</div><div class="line">    	//把位置p中所在的节点的[编码前一个节点长度所需的字节数]和[前一个节点的长度]计算出来</div><div class="line">        ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);</div><div class="line">    &#125; else &#123;</div><div class="line">    	//如果位置p是zlend，</div><div class="line">        unsigned char *ptail = ZIPLIST_ENTRY_TAIL(zl);	//返回尾节点</div><div class="line">        //如果尾节点不为zlend的话，也就是ziplist不为空时</div><div class="line">        if (ptail[0] != ZIP_END) &#123;</div><div class="line">        	//把尾部节点的长度计算出来</div><div class="line">            prevlen = zipRawEntryLength(ptail);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //判断字符串数据是否可以用整数来表示，如果可以，则用整数类型表示，以节省空间</div><div class="line">    if (zipTryEncoding(s,slen,&amp;value,&amp;encoding)) &#123;</div><div class="line">        //获取存储该整数数据所需要的字节数</div><div class="line">        reqlen = zipIntSize(encoding);</div><div class="line">    &#125; else &#123;</div><div class="line">        //如果不能转化为整数数据，直接把字符串长度付给reqlen</div><div class="line">        reqlen = slen;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //reqlen加上编码prevlen需要的字节数</div><div class="line">    reqlen += zipPrevEncodeLength(NULL,prevlen);</div><div class="line">    //reqlen加上编码len需要的字节数</div><div class="line">    reqlen += zipEncodeLength(NULL,encoding,slen);</div><div class="line"></div><div class="line">    //因为加入新节点之后，新节点的后一个节点的prevlen字段先前保存的时候新节点的前一个节点的长度</div><div class="line">    //现在保存的是新节点的长度，所以长度可能有所改变，长度改变用nextdiff来计算</div><div class="line">    nextdiff = (p[0] != ZIP_END) ? zipPrevLenByteDiff(p,reqlen) : 0;</div><div class="line"></div><div class="line">    //对存储ziplist的内存进行realloc，因为zl的地址可能会改变，所以要先保存好p到zl的offset</div><div class="line">    offset = p-zl;</div><div class="line">    zl = ziplistResize(zl,curlen+reqlen+nextdiff);</div><div class="line">    p = zl+offset;		//恢复p</div><div class="line"></div><div class="line">    //如果插入位置不在ziplist的尾部</div><div class="line">    if (p[0] != ZIP_END) &#123;</div><div class="line">        //数据后移，为新节点腾出空间</div><div class="line">        memmove(p+reqlen,p-nextdiff,curlen-offset-1+nextdiff);</div><div class="line"></div><div class="line">        //更新新节点的后一个节点的prevlen</div><div class="line">        zipPrevEncodeLength(p+reqlen,reqlen);</div><div class="line"></div><div class="line">        //更新tail位置，看到这里大家可能有点懵逼，这里为什么不用加上nextdiff的长度的呢，别急，继续往下看</div><div class="line">        ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">            intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+reqlen);</div><div class="line"></div><div class="line">        /* When the tail contains more than one entry, we need to take</div><div class="line">         * "nextdiff" in account as well. Otherwise, a change in the</div><div class="line">         * size of prevlen doesn't have an effect on the *tail* offset. */</div><div class="line">        //把新节点后一个节点的信息提取到*tail结构体中</div><div class="line">        zipEntry(p+reqlen, &amp;tail);</div><div class="line">        //如果新节点后一个节点不是尾节点，那么就要加上nextdiff（解答了上面的疑惑）</div><div class="line">        if (p[reqlen+tail.headersize+tail.len] != ZIP_END) &#123;</div><div class="line">            ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">                intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+nextdiff);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">    	//如果新节点就是ziplist的为节点，那么就更新zltail</div><div class="line">        ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(p-zl);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //如果nextdiff不为0，那么就执行连锁更新</div><div class="line">    if (nextdiff != 0) &#123;</div><div class="line">        offset = p-zl;</div><div class="line">        zl = __ziplistCascadeUpdate(zl,p+reqlen);</div><div class="line">        p = zl+offset;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //把prelen写入新节点中</div><div class="line">    p += zipPrevEncodeLength(p,prevlen);</div><div class="line">    //把len(encoding)写入新节点中</div><div class="line">    p += zipEncodeLength(p,encoding,slen);</div><div class="line">    //如果数据是字符串，那么宝贝数据到data段</div><div class="line">    if (ZIP_IS_STR(encoding)) &#123;</div><div class="line">        memcpy(p,s,slen);</div><div class="line">    &#125; else &#123;</div><div class="line">    	//如果是整数就整数</div><div class="line">        zipSaveInteger(p,value,encoding);</div><div class="line">    &#125;</div><div class="line">    //给ziplist的长度加1</div><div class="line">    ZIPLIST_INCR_LENGTH(zl,1);</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"> //合并两个压缩表first和second，两个中比较大的一个压缩表会被realloc以足以存储合并后的结果，另一个会被释放掉</div><div class="line">unsigned char *ziplistMerge(unsigned char **first, unsigned char **second) &#123;</div><div class="line">    //任何一个参数为NULL的话，返回NULL</div><div class="line">    if (first == NULL || *first == NULL || second == NULL || *second == NULL)</div><div class="line">        return NULL;</div><div class="line"></div><div class="line">    //如果这两个ziplist是同一个ziplist的话，返回NULL</div><div class="line">    if (*first == *second)</div><div class="line">        return NULL;</div><div class="line"></div><div class="line">    //第一个ziplist的字节数</div><div class="line">    size_t first_bytes = intrev32ifbe(ZIPLIST_BYTES(*first));</div><div class="line">    //第一个ziplist的节点数</div><div class="line">    size_t first_len = intrev16ifbe(ZIPLIST_LENGTH(*first));</div><div class="line"></div><div class="line">    //第二个ziplist的字节数</div><div class="line">    size_t second_bytes = intrev32ifbe(ZIPLIST_BYTES(*second));</div><div class="line">    //第二个ziplist的节点数</div><div class="line">    size_t second_len = intrev16ifbe(ZIPLIST_LENGTH(*second));</div><div class="line"></div><div class="line">    int append;</div><div class="line">    unsigned char *source, *target;</div><div class="line">    size_t target_bytes, source_bytes;</div><div class="line">    /* Pick the largest ziplist so we can resize easily in-place.</div><div class="line">     * We must also track if we are now appending or prepending to</div><div class="line">     * the target ziplist. */</div><div class="line">    //如果第一个ziplist的节点数大于第二个ziplist的话</div><div class="line">    if (first_len &gt;= second_len) &#123;</div><div class="line">        //那么就把second合并到first</div><div class="line">        target = *first;</div><div class="line">        target_bytes = first_bytes;</div><div class="line">        source = *second;</div><div class="line">        source_bytes = second_bytes;</div><div class="line">        append = 1;</div><div class="line">    &#125; else &#123;</div><div class="line">        //否则，把first合并到second</div><div class="line">        target = *second;</div><div class="line">        target_bytes = second_bytes;</div><div class="line">        source = *first;</div><div class="line">        source_bytes = first_bytes;</div><div class="line">        append = 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //计算合并后的字节数</div><div class="line">    size_t zlbytes = first_bytes + second_bytes -</div><div class="line">                     ZIPLIST_HEADER_SIZE - ZIPLIST_END_SIZE;</div><div class="line">    //计算合并后的节点数</div><div class="line">    size_t zllength = first_len + second_len;</div><div class="line"></div><div class="line">    //zllength应该小于2**16 - 1，否则把2**16 - 1赋给zllength</div><div class="line">    zllength = zllength &lt; UINT16_MAX ? zllength : UINT16_MAX;</div><div class="line"></div><div class="line">    //分别求出firs和second的尾节点偏移</div><div class="line">    size_t first_offset = intrev32ifbe(ZIPLIST_TAIL_OFFSET(*first));</div><div class="line">    size_t second_offset = intrev32ifbe(ZIPLIST_TAIL_OFFSET(*second));</div><div class="line"></div><div class="line">    //给target分配空间（两个ziplist合起来的空间）</div><div class="line">    target = zrealloc(target, zlbytes);</div><div class="line">    if (append) &#123;</div><div class="line">        //如果把second(source)加到first(target)</div><div class="line">        //把second拷贝到first后</div><div class="line">        memcpy(target + target_bytes - ZIPLIST_END_SIZE,</div><div class="line">               source + ZIPLIST_HEADER_SIZE,</div><div class="line">               source_bytes - ZIPLIST_HEADER_SIZE);</div><div class="line">    &#125; else &#123;</div><div class="line">        //如果把first(source)加到second(target)</div><div class="line">        //先把second后移，腾出空间给first</div><div class="line">        memmove(target + source_bytes - ZIPLIST_END_SIZE,</div><div class="line">                target + ZIPLIST_HEADER_SIZE,</div><div class="line">                target_bytes - ZIPLIST_HEADER_SIZE);</div><div class="line">        //把first拷贝到腾出的空间里面</div><div class="line">        memcpy(target, source, source_bytes - ZIPLIST_END_SIZE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //更新ziplist的zlbytes</div><div class="line">    ZIPLIST_BYTES(target) = intrev32ifbe(zlbytes);</div><div class="line">    //更新ziplist的zllen</div><div class="line">    ZIPLIST_LENGTH(target) = intrev16ifbe(zllength);</div><div class="line"></div><div class="line">    //更新尾节点偏移</div><div class="line">    ZIPLIST_TAIL_OFFSET(target) = intrev32ifbe(</div><div class="line">                                   (first_bytes - ZIPLIST_END_SIZE) +</div><div class="line">                                   (second_offset - ZIPLIST_HEADER_SIZE));</div><div class="line"></div><div class="line">    //连锁更新</div><div class="line">    target = __ziplistCascadeUpdate(target, target+first_offset);</div><div class="line"></div><div class="line">    //释放资源</div><div class="line">    if (append) &#123;</div><div class="line">        zfree(*second);</div><div class="line">        *second = NULL;</div><div class="line">        *first = target;</div><div class="line">    &#125; else &#123;</div><div class="line">        zfree(*first);</div><div class="line">        *first = NULL;</div><div class="line">        *second = target;</div><div class="line">    &#125;</div><div class="line">    return target;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//把s加到ziplist开始或者末尾</div><div class="line">unsigned char *ziplistPush(unsigned char *zl, unsigned char *s, unsigned int slen, int where) &#123;</div><div class="line">    unsigned char *p;</div><div class="line">    p = (where == ZIPLIST_HEAD) ? ZIPLIST_ENTRY_HEAD(zl) : ZIPLIST_ENTRY_END(zl);</div><div class="line">    return __ziplistInsert(zl,p,s,slen);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回index位置上的节点，如果不存在返回NULL, 如果index未负数，从尾节点开始向前遍历</div><div class="line">unsigned char *ziplistIndex(unsigned char *zl, int index) &#123;</div><div class="line">    unsigned char *p;</div><div class="line">    unsigned int prevlensize, prevlen = 0;</div><div class="line">    //如果为负数，从后往前遍历</div><div class="line">    if (index &lt; 0) &#123;</div><div class="line">        index = (-index)-1;</div><div class="line">        p = ZIPLIST_ENTRY_TAIL(zl);</div><div class="line">        if (p[0] != ZIP_END) &#123;</div><div class="line">            ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);</div><div class="line">            while (prevlen &gt; 0 &amp;&amp; index--) &#123;</div><div class="line">                p -= prevlen;</div><div class="line">                ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        p = ZIPLIST_ENTRY_HEAD(zl);</div><div class="line">        while (p[0] != ZIP_END &amp;&amp; index--) &#123;</div><div class="line">            p += zipRawEntryLength(p);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return (p[0] == ZIP_END || index &gt; 0) ? NULL : p;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回在p位置的节点的下一个节点</div><div class="line">unsigned char *ziplistNext(unsigned char *zl, unsigned char *p) &#123;</div><div class="line">    ((void) zl);</div><div class="line"></div><div class="line">    /* "p" could be equal to ZIP_END, caused by ziplistDelete,</div><div class="line">     * and we should return NULL. Otherwise, we should return NULL</div><div class="line">     * when the *next* element is ZIP_END (there is no next entry). */</div><div class="line">    if (p[0] == ZIP_END) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    p += zipRawEntryLength(p);</div><div class="line">    if (p[0] == ZIP_END) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return p;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回上一个节点</div><div class="line">unsigned char *ziplistPrev(unsigned char *zl, unsigned char *p) &#123;</div><div class="line">    unsigned int prevlensize, prevlen = 0;</div><div class="line"></div><div class="line">    /* Iterating backwards from ZIP_END should return the tail. When "p" is</div><div class="line">     * equal to the first element of the list, we're already at the head,</div><div class="line">     * and should return NULL. */</div><div class="line">    if (p[0] == ZIP_END) &#123;</div><div class="line">        p = ZIPLIST_ENTRY_TAIL(zl);</div><div class="line">        return (p[0] == ZIP_END) ? NULL : p;</div><div class="line">    &#125; else if (p == ZIPLIST_ENTRY_HEAD(zl)) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125; else &#123;</div><div class="line">        ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);</div><div class="line">        assert(prevlen &gt; 0);</div><div class="line">        return p-prevlen;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//获取p位置上的值，如果是字符串，则存于sstr中，如果是整数，则存于sval中</div><div class="line">unsigned int ziplistGet(unsigned char *p, unsigned char **sstr, unsigned int *slen, long long *sval) &#123;</div><div class="line">    zlentry entry;</div><div class="line">    if (p == NULL || p[0] == ZIP_END) return 0;</div><div class="line">    if (sstr) *sstr = NULL;</div><div class="line"></div><div class="line">    //提取节点信息</div><div class="line">    zipEntry(p, &amp;entry);</div><div class="line">    //如果是字符串</div><div class="line">    if (ZIP_IS_STR(entry.encoding)) &#123;</div><div class="line">        if (sstr) &#123;</div><div class="line">            *slen = entry.len;</div><div class="line">            *sstr = p+entry.headersize;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        if (sval) &#123;</div><div class="line">            //如果是整数直接根据enconding提取p+entry.headersize上的数据存在sval中</div><div class="line">            *sval = zipLoadInteger(p+entry.headersize,entry.encoding);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return 1;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//包装函数，在p位置插入字符窜s，slen为s的长度</div><div class="line">unsigned char *ziplistInsert(unsigned char *zl, unsigned char *p, unsigned char *s, unsigned int slen) &#123;</div><div class="line">    return __ziplistInsert(zl,p,s,slen);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Delete a single entry from the ziplist, pointed to by *p.</div><div class="line"> * Also update *p in place, to be able to iterate over the</div><div class="line"> * ziplist, while deleting entries. */</div><div class="line">unsigned char *ziplistDelete(unsigned char *zl, unsigned char **p) &#123;</div><div class="line">    size_t offset = *p-zl;</div><div class="line">    zl = __ziplistDelete(zl,*p,1);</div><div class="line"></div><div class="line">    /* Store pointer to current element in p, because ziplistDelete will</div><div class="line">     * do a realloc which might result in a different "zl"-pointer.</div><div class="line">     * When the delete direction is back to front, we might delete the last</div><div class="line">     * entry and end up with "p" pointing to ZIP_END, so check this. */</div><div class="line">    *p = zl+offset;</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//删除指定位置上的节点</div><div class="line">unsigned char *ziplistDeleteRange(unsigned char *zl, int index, unsigned int num) &#123;</div><div class="line">    unsigned char *p = ziplistIndex(zl,index);</div><div class="line">    return (p == NULL) ? zl : __ziplistDelete(zl,p,num);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//比较p位置的节点与sstr的数据是否相等</div><div class="line">unsigned int ziplistCompare(unsigned char *p, unsigned char *sstr, unsigned int slen) &#123;</div><div class="line">    zlentry entry;</div><div class="line">    unsigned char sencoding;</div><div class="line">    long long zval, sval;</div><div class="line">    if (p[0] == ZIP_END) return 0;</div><div class="line"></div><div class="line">    //提取当前节点的信息到entry结构体</div><div class="line">    zipEntry(p, &amp;entry);</div><div class="line">    if (ZIP_IS_STR(entry.encoding)) &#123;</div><div class="line">        //如果是当前节点的数据段是字符串的话，进行字符串比较</div><div class="line">        if (entry.len == slen) &#123;</div><div class="line">            return memcmp(p+entry.headersize,sstr,slen) == 0;</div><div class="line">        &#125; else &#123;</div><div class="line">            return 0;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">       	//如果不是字符串，先尝试把sstr转换成整数，然后再对其进行比较</div><div class="line">        if (zipTryEncoding(sstr,slen,&amp;sval,&amp;sencoding)) &#123;</div><div class="line">          zval = zipLoadInteger(p+entry.headersize,entry.encoding);</div><div class="line">          return zval == sval;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//给出vstr，查找与之相等的节点，skip指定每隔skip个节点比较一次，如果没有找到，返回NULL</div><div class="line">unsigned char *ziplistFind(unsigned char *p, unsigned char *vstr, unsigned int vlen, unsigned int skip) &#123;</div><div class="line">    int skipcnt = 0;</div><div class="line">    unsigned char vencoding = 0;</div><div class="line">    long long vll = 0;</div><div class="line"></div><div class="line">    //如果没达到zlend</div><div class="line">    while (p[0] != ZIP_END) &#123;</div><div class="line">        unsigned int prevlensize, encoding, lensize, len;</div><div class="line">        unsigned char *q;</div><div class="line"></div><div class="line">        //解码出当前节点的prevlensize</div><div class="line">        ZIP_DECODE_PREVLENSIZE(p, prevlensize);</div><div class="line">        //解码出len和lensize</div><div class="line">        ZIP_DECODE_LENGTH(p + prevlensize, encoding, lensize, len);</div><div class="line">        //求出数据段的开始地址q</div><div class="line">        q = p + prevlensize + lensize;</div><div class="line"></div><div class="line">        if (skipcnt == 0) &#123;</div><div class="line">            //比较当前节点的数据是否跟给出的vstr相同，如果相同则返回当前节点的开始地址</div><div class="line">            //如果是字符串数据</div><div class="line">            if (ZIP_IS_STR(encoding)) &#123;</div><div class="line">                if (len == vlen &amp;&amp; memcmp(q, vstr, vlen) == 0) &#123;</div><div class="line">                    return p;</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                //接下来是编码输入数据vstr，当vencoding为0的时候，说明其还没有被编码，下面的代码对它进行编码</div><div class="line">                if (vencoding == 0) &#123;</div><div class="line">                    if (!zipTryEncoding(vstr, vlen, &amp;vll, &amp;vencoding)) &#123;</div><div class="line">                        //如果不能被转化成整形数据，那么把vencoding设成255，这样的话下次就不会再对其进行编码了</div><div class="line">                        vencoding = UCHAR_MAX;</div><div class="line">                    &#125;</div><div class="line">                    /* Must be non-zero by now */</div><div class="line">                    assert(vencoding);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                //如果vencoding不是UCHAR_MAX，那么说明vstr已经被转换成整形数据</div><div class="line">                if (vencoding != UCHAR_MAX) &#123;</div><div class="line">                    long long ll = zipLoadInteger(q, encoding);</div><div class="line">        			//ll等于vll的话，那就返回当前节点的开始指针</div><div class="line">                    if (ll == vll) &#123;</div><div class="line">                        return p;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            /* Reset skip count */</div><div class="line">            skipcnt = skip;</div><div class="line">        &#125; else &#123;</div><div class="line">            /* Skip entry */</div><div class="line">            skipcnt--;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //更新p，移动到下一个节点</div><div class="line">        p = q + len;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return NULL;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回ziplist的长度</div><div class="line">unsigned int ziplistLen(unsigned char *zl) &#123;</div><div class="line">    unsigned int len = 0;</div><div class="line">    //如果zllen字段的长度小于UINT16_MAX(2**16 - 1)，那么直接返回</div><div class="line">    if (intrev16ifbe(ZIPLIST_LENGTH(zl)) &lt; UINT16_MAX) &#123;</div><div class="line">        len = intrev16ifbe(ZIPLIST_LENGTH(zl));</div><div class="line">    &#125; else &#123;</div><div class="line">    	//否则，需要遍历整个ziplist，然后返回其长度，整个过程很低效</div><div class="line">        unsigned char *p = zl+ZIPLIST_HEADER_SIZE;</div><div class="line">        while (*p != ZIP_END) &#123;</div><div class="line">            p += zipRawEntryLength(p);</div><div class="line">            len++;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //如果遍历之后发现长度小于UINT16_MAX的话，重新更改zllen字段，改成实际长度，避免下次再次遍历</div><div class="line">        if (len &lt; UINT16_MAX) ZIPLIST_LENGTH(zl) = intrev16ifbe(len);</div><div class="line">    &#125;</div><div class="line">    return len;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回ziplist的字节数</div><div class="line">size_t ziplistBlobLen(unsigned char *zl) &#123;</div><div class="line">    return intrev32ifbe(ZIPLIST_BYTES(zl));</div><div class="line">&#125;</div><div class="line"></div><div class="line">//列出ziplist的基本信息，注释略</div><div class="line">void ziplistRepr(unsigned char *zl) &#123;</div><div class="line">    unsigned char *p;</div><div class="line">    int index = 0;</div><div class="line">    zlentry entry;</div><div class="line"></div><div class="line">    printf(</div><div class="line">        "&#123;total bytes %d&#125; "</div><div class="line">        "&#123;length %u&#125;\n"</div><div class="line">        "&#123;tail offset %u&#125;\n",</div><div class="line">        intrev32ifbe(ZIPLIST_BYTES(zl)),</div><div class="line">        intrev16ifbe(ZIPLIST_LENGTH(zl)),</div><div class="line">        intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl)));</div><div class="line">    p = ZIPLIST_ENTRY_HEAD(zl);</div><div class="line">    while(*p != ZIP_END) &#123;</div><div class="line">        zipEntry(p, &amp;entry);</div><div class="line">        printf(</div><div class="line">            "&#123;"</div><div class="line">                "addr 0x%08lx, "</div><div class="line">                "index %2d, "</div><div class="line">                "offset %5ld, "</div><div class="line">                "rl: %5u, "</div><div class="line">                "hs %2u, "</div><div class="line">                "pl: %5u, "</div><div class="line">                "pls: %2u, "</div><div class="line">                "payload %5u"</div><div class="line">            "&#125; ",</div><div class="line">            (long unsigned)p,</div><div class="line">            index,</div><div class="line">            (unsigned long) (p-zl),</div><div class="line">            entry.headersize+entry.len,</div><div class="line">            entry.headersize,</div><div class="line">            entry.prevrawlen,</div><div class="line">            entry.prevrawlensize,</div><div class="line">            entry.len);</div><div class="line">        p += entry.headersize;</div><div class="line">        if (ZIP_IS_STR(entry.encoding)) &#123;</div><div class="line">            if (entry.len &gt; 40) &#123;</div><div class="line">                if (fwrite(p,40,1,stdout) == 0) perror("fwrite");</div><div class="line">                printf("...");</div><div class="line">            &#125; else &#123;</div><div class="line">                if (entry.len &amp;&amp;</div><div class="line">                    fwrite(p,entry.len,1,stdout) == 0) perror("fwrite");</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            printf("%lld", (long long) zipLoadInteger(p,entry.encoding));</div><div class="line">        &#125;</div><div class="line">        printf("\n");</div><div class="line">        p += entry.len;</div><div class="line">        index++;</div><div class="line">    &#125;</div><div class="line">    printf("&#123;end&#125;\n\n");</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>时间问题只写了几个核心函数的注释和一些小函数的注释，不过读懂了那几个函数其它函数其实也就大同小异，先出门喝杯咖啡散散步，什么时候有空补上没有写完的注释。</p>
<p>## 2016/11/22 已经更新完所有注释 ##</p>
<p>能力有限，可能会有错误，欢迎指出，大家一起交流学习。</p>
<p><iframe src="https://music.163.com/outchain/player?type=2&amp;id=21969945&amp;auto=0&amp;height=66" width="330" height="86" frameborder="no" marginwidth="0" marginheight="0"></iframe></p>





















          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/19/工具分享：dash3-3破解版/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/19/工具分享：dash3-3破解版/" itemprop="url">
                  工具分享：dash3.3破解版
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-19T11:50:50+08:00">
                2016-11-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/19/工具分享：dash3-3破解版/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/19/工具分享：dash3-3破解版/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Dash是mac平台上常用的文档查询工具，但是Dash不是免费的，过了试用期之后要付费，否则在查询文档的过程中会出现8秒延迟，如下图：</p>
<p><img src="/uploads/dash_raw.jpg" alt="dash_raw"></p>
<p>从没使用过正版软件的我(…)立马想到了通过逆向工程把查询延迟的页面给屏蔽掉，经过一番努力，效果如下：</p>
<p><img src="/uploads/dash_cracking.jpg" alt="dash_cracking"><br><img src="/uploads/dash_cracked.jpg" alt="dash_cracked"></p>
<p>承诺不留后门，大家可以放心使用。<br>下面给出下载地址，只需要把下载好的dash程序替换掉原来Contents/MacOS/的Dash即可</p>
<p><a href="https://kimlongli.github.io/files/Dash">https://kimlongli.github.io/files/Dash</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/18/Redis源代码分析之有序集合/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/18/Redis源代码分析之有序集合/" itemprop="url">
                  Redis源代码分析之有序集合
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-18T02:24:29+08:00">
                2016-11-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/18/Redis源代码分析之有序集合/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/18/Redis源代码分析之有序集合/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>本文对Redis中的有序集合部分源代码进行分析（基于Redis3.2.0源码）<br>skiplist参考资料(A Skip List Cookbook)：<br><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.17.524&amp;rep=rep1&amp;type=pdf" target="_blank" rel="external">http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.17.524&amp;rep=rep1&amp;type=pdf</a></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>Redis中有序集合的底层实现是skiplist和ziplist，在server.h中，相关的两个有序集合如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//在有序集合的实现中用来表示score的范围</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="keyword">double</span> min, max;</div><div class="line">    <span class="keyword">int</span> minex, maxex; <span class="comment">/* are min or max exclusive? */</span></div><div class="line">&#125; zrangespec;</div><div class="line"></div><div class="line"><span class="comment">//在有序集合的实现中用来表示键的范围</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    robj *min, *max; </div><div class="line">    <span class="keyword">int</span> minex, maxex;</div><div class="line">&#125; zlexrangespec;</div><div class="line"></div><div class="line"><span class="comment">//跳表节点</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> zskiplistNode &#123;</div><div class="line">    robj *obj;          <span class="comment">//键对象</span></div><div class="line">    <span class="keyword">double</span> score;       <span class="comment">//分值</span></div><div class="line">    <span class="keyword">struct</span> zskiplistNode *backward;     <span class="comment">//上一个节点</span></div><div class="line">    <span class="keyword">struct</span> zskiplistLevel &#123;</div><div class="line">        <span class="keyword">struct</span> zskiplistNode *forward;  <span class="comment">//下一个节点</span></div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> span;      <span class="comment">//与下一个节点之间的跨度</span></div><div class="line">    &#125; level[];  <span class="comment">//指向下一个节点的节点列表</span></div><div class="line">&#125; zskiplistNode;</div><div class="line"></div><div class="line"><span class="comment">//跳表</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> zskiplist &#123;</div><div class="line">    <span class="keyword">struct</span> zskiplistNode *header, *tail;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> length;</div><div class="line">    <span class="keyword">int</span> level;</div><div class="line">&#125; zskiplist;</div><div class="line"></div><div class="line"><span class="comment">//有序集合</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> zset &#123;</div><div class="line">    dict *dict;</div><div class="line">    zskiplist *zsl;</div><div class="line">&#125; zset;</div></pre></td></tr></table></figure></p>
<p>t_zset.c是对redis有序集合的具体实现，代码以及注释如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建skiplist节点</span></div><div class="line"><span class="function">zskiplistNode *<span class="title">zslCreateNode</span><span class="params">(<span class="keyword">int</span> level, <span class="keyword">double</span> score, robj *obj)</span> </span>&#123;</div><div class="line">    zskiplistNode *zn = zmalloc(<span class="keyword">sizeof</span>(*zn)+level*<span class="keyword">sizeof</span>(<span class="keyword">struct</span> zskiplistLevel));</div><div class="line">    zn-&gt;score = score;</div><div class="line">    zn-&gt;obj = obj;</div><div class="line">    <span class="keyword">return</span> zn;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//创建skiplist</span></div><div class="line"><span class="function">zskiplist *<span class="title">zslCreate</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> j;</div><div class="line">    zskiplist *zsl;</div><div class="line"></div><div class="line">    zsl = zmalloc(<span class="keyword">sizeof</span>(*zsl));</div><div class="line">    zsl-&gt;level = <span class="number">1</span>;</div><div class="line">    zsl-&gt;length = <span class="number">0</span>;</div><div class="line">    zsl-&gt;header = zslCreateNode(ZSKIPLIST_MAXLEVEL,<span class="number">0</span>,<span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; ZSKIPLIST_MAXLEVEL; j++) &#123;</div><div class="line">        zsl-&gt;header-&gt;level[j].forward = <span class="literal">NULL</span>;</div><div class="line">        zsl-&gt;header-&gt;level[j].span = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    zsl-&gt;header-&gt;backward = <span class="literal">NULL</span>;</div><div class="line">    zsl-&gt;tail = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">return</span> zsl;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//释放skiplist节点</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">zslFreeNode</span><span class="params">(zskiplistNode *node)</span> </span>&#123;</div><div class="line">    decrRefCount(node-&gt;obj);</div><div class="line">    zfree(node);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//释放skiplist</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">zslFree</span><span class="params">(zskiplist *zsl)</span> </span>&#123;</div><div class="line">    zskiplistNode *node = zsl-&gt;header-&gt;level[<span class="number">0</span>].forward, *next;</div><div class="line"></div><div class="line">    zfree(zsl-&gt;header);</div><div class="line">    <span class="keyword">while</span>(node) &#123;</div><div class="line">        next = node-&gt;level[<span class="number">0</span>].forward;</div><div class="line">        zslFreeNode(node);</div><div class="line">        node = next;</div><div class="line">    &#125;</div><div class="line">    zfree(zsl);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//随机生成一个level</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslRandomLevel</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> level = <span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span> ((random()&amp;<span class="number">0xFFFF</span>) &lt; (ZSKIPLIST_P * <span class="number">0xFFFF</span>))</div><div class="line">        level += <span class="number">1</span>;</div><div class="line">    <span class="keyword">return</span> (level&lt;ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//在skiplist中插入一个键值对</span></div><div class="line"><span class="function">zskiplistNode *<span class="title">zslInsert</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, robj *obj)</span> </span>&#123;</div><div class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rank[ZSKIPLIST_MAXLEVEL];</div><div class="line">    <span class="keyword">int</span> i, level;</div><div class="line"></div><div class="line">    serverAssert(!isnan(score));</div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="comment">/* store rank that is crossed to reach the insert position */</span></div><div class="line">        rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</div><div class="line">            (x-&gt;level[i].forward-&gt;score &lt; score ||</div><div class="line">                (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</div><div class="line">                compareStringObjects(x-&gt;level[i].forward-&gt;obj,obj) &lt; <span class="number">0</span>))) &#123;</div><div class="line">            rank[i] += x-&gt;level[i].span;</div><div class="line">            x = x-&gt;level[i].forward;</div><div class="line">        &#125;</div><div class="line">        update[i] = x;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* we assume the key is not already inside, since we allow duplicated</span></div><div class="line">     * scores, and the re-insertion of score and redis object should never</div><div class="line">     * happen since the caller of zslInsert() should test in the hash table</div><div class="line">     * if the element is already inside or not. */</div><div class="line">    level = zslRandomLevel();</div><div class="line">    <span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</div><div class="line">        <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</div><div class="line">            rank[i] = <span class="number">0</span>;</div><div class="line">            update[i] = zsl-&gt;header;</div><div class="line">            update[i]-&gt;level[i].span = zsl-&gt;length;</div><div class="line">        &#125;</div><div class="line">        zsl-&gt;level = level;</div><div class="line">    &#125;</div><div class="line">    x = zslCreateNode(level,score,obj);</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</div><div class="line">        x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</div><div class="line">        update[i]-&gt;level[i].forward = x;</div><div class="line"></div><div class="line">        <span class="comment">/* update span covered by update[i] as x is inserted here */</span></div><div class="line">        x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</div><div class="line">        update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* increment span for untouched levels */</span></div><div class="line">    <span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</div><div class="line">        update[i]-&gt;level[i].span++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</div><div class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</div><div class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        zsl-&gt;tail = x;</div><div class="line">    zsl-&gt;length++;</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//删除skiplist节点辅助函数，给定update数组和需要删除的节点x，以及相应的skiplist zsl</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">zslDeleteNode</span><span class="params">(zskiplist *zsl, zskiplistNode *x, zskiplistNode **update)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; zsl-&gt;level; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (update[i]-&gt;level[i].forward == x) &#123;</div><div class="line">            update[i]-&gt;level[i].span += x-&gt;level[i].span - <span class="number">1</span>;</div><div class="line">            update[i]-&gt;level[i].forward = x-&gt;level[i].forward;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            update[i]-&gt;level[i].span -= <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward) &#123;</div><div class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x-&gt;backward;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        zsl-&gt;tail = x-&gt;backward;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span>(zsl-&gt;level &gt; <span class="number">1</span> &amp;&amp; zsl-&gt;header-&gt;level[zsl-&gt;level<span class="number">-1</span>].forward == <span class="literal">NULL</span>)</div><div class="line">        zsl-&gt;level--;</div><div class="line">    zsl-&gt;length--;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//删除指定的键值对，要求score和obj对应</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslDelete</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, robj *obj)</span> </span>&#123;</div><div class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</div><div class="line">            (x-&gt;level[i].forward-&gt;score &lt; score ||</div><div class="line">                (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</div><div class="line">                compareStringObjects(x-&gt;level[i].forward-&gt;obj,obj) &lt; <span class="number">0</span>)))</div><div class="line">            x = x-&gt;level[i].forward;</div><div class="line">        update[i] = x;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* We may have multiple elements with the same score, what we need</span></div><div class="line">     * is to find the element with both the right score and object. */</div><div class="line">    x = x-&gt;level[<span class="number">0</span>].forward;</div><div class="line">    <span class="keyword">if</span> (x &amp;&amp; score == x-&gt;score &amp;&amp; equalStringObjects(x-&gt;obj,obj)) &#123;</div><div class="line">        zslDeleteNode(zsl, x, update);</div><div class="line">        zslFreeNode(x);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* not found */</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//value是否大于最小值</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">zslValueGteMin</span><span class="params">(<span class="keyword">double</span> value, zrangespec *spec)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> spec-&gt;minex ? (value &gt; spec-&gt;min) : (value &gt;= spec-&gt;min);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//value是否小于最大值</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslValueLteMax</span><span class="params">(<span class="keyword">double</span> value, zrangespec *spec)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> spec-&gt;maxex ? (value &lt; spec-&gt;max) : (value &lt;= spec-&gt;max);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//该skiplist的score是否在范围range之内</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslIsInRange</span><span class="params">(zskiplist *zsl, zrangespec *range)</span> </span>&#123;</div><div class="line">    zskiplistNode *x;</div><div class="line"></div><div class="line">    <span class="comment">/* Test for ranges that will always be empty. */</span></div><div class="line">    <span class="keyword">if</span> (range-&gt;min &gt; range-&gt;max ||</div><div class="line">            (range-&gt;min == range-&gt;max &amp;&amp; (range-&gt;minex || range-&gt;maxex)))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    x = zsl-&gt;tail;</div><div class="line">    <span class="keyword">if</span> (x == <span class="literal">NULL</span> || !zslValueGteMin(x-&gt;score,range))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    x = zsl-&gt;header-&gt;level[<span class="number">0</span>].forward;</div><div class="line">    <span class="keyword">if</span> (x == <span class="literal">NULL</span> || !zslValueLteMax(x-&gt;score,range))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//找出在指定score范围range之内的第一个元素并返回</span></div><div class="line"><span class="function">zskiplistNode *<span class="title">zslFirstInRange</span><span class="params">(zskiplist *zsl, zrangespec *range)</span> </span>&#123;</div><div class="line">    zskiplistNode *x;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    <span class="comment">/* If everything is out of range, return early. */</span></div><div class="line">    <span class="keyword">if</span> (!zslIsInRange(zsl,range)) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="comment">/* Go forward while *OUT* of range. */</span></div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</div><div class="line">            !zslValueGteMin(x-&gt;level[i].forward-&gt;score,range))</div><div class="line">                x = x-&gt;level[i].forward;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* This is an inner range, so the next node cannot be NULL. */</span></div><div class="line">    x = x-&gt;level[<span class="number">0</span>].forward;</div><div class="line">    serverAssert(x != <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* Check if score &lt;= max. */</span></div><div class="line">    <span class="keyword">if</span> (!zslValueLteMax(x-&gt;score,range)) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//找出在指定score范围range之内的最后一个元素并返回</span></div><div class="line"><span class="function">zskiplistNode *<span class="title">zslLastInRange</span><span class="params">(zskiplist *zsl, zrangespec *range)</span> </span>&#123;</div><div class="line">    zskiplistNode *x;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    <span class="comment">/* If everything is out of range, return early. */</span></div><div class="line">    <span class="keyword">if</span> (!zslIsInRange(zsl,range)) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="comment">/* Go forward while *IN* range. */</span></div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</div><div class="line">            zslValueLteMax(x-&gt;level[i].forward-&gt;score,range))</div><div class="line">                x = x-&gt;level[i].forward;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* This is an inner range, so this node cannot be NULL. */</span></div><div class="line">    serverAssert(x != <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* Check if score &gt;= min. */</span></div><div class="line">    <span class="keyword">if</span> (!zslValueGteMin(x-&gt;score,range)) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//删除指定score范围内range内的所有节点</span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">zslDeleteRangeByScore</span><span class="params">(zskiplist *zsl, zrangespec *range, dict *dict)</span> </span>&#123;</div><div class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> removed = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp; (range-&gt;minex ?</div><div class="line">            x-&gt;level[i].forward-&gt;score &lt;= range-&gt;min :</div><div class="line">            x-&gt;level[i].forward-&gt;score &lt; range-&gt;min))</div><div class="line">                x = x-&gt;level[i].forward;</div><div class="line">        update[i] = x;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* Current node is the last with score &lt; or &lt;= min. */</span></div><div class="line">    x = x-&gt;level[<span class="number">0</span>].forward;</div><div class="line"></div><div class="line">    <span class="comment">/* Delete nodes while in range. */</span></div><div class="line">    <span class="keyword">while</span> (x &amp;&amp;</div><div class="line">           (range-&gt;maxex ? x-&gt;score &lt; range-&gt;max : x-&gt;score &lt;= range-&gt;max))</div><div class="line">    &#123;</div><div class="line">        zskiplistNode *next = x-&gt;level[<span class="number">0</span>].forward;</div><div class="line">        zslDeleteNode(zsl,x,update);</div><div class="line">        dictDelete(dict,x-&gt;obj);</div><div class="line">        zslFreeNode(x);</div><div class="line">        removed++;</div><div class="line">        x = next;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> removed;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//删除键范围range之间的所有节点</span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">zslDeleteRangeByLex</span><span class="params">(zskiplist *zsl, zlexrangespec *range, dict *dict)</span> </span>&#123;</div><div class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> removed = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line"></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</div><div class="line">            !zslLexValueGteMin(x-&gt;level[i].forward-&gt;obj,range))</div><div class="line">                x = x-&gt;level[i].forward;</div><div class="line">        update[i] = x;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* Current node is the last with score &lt; or &lt;= min. */</span></div><div class="line">    x = x-&gt;level[<span class="number">0</span>].forward;</div><div class="line"></div><div class="line">    <span class="comment">/* Delete nodes while in range. */</span></div><div class="line">    <span class="keyword">while</span> (x &amp;&amp; zslLexValueLteMax(x-&gt;obj,range)) &#123;</div><div class="line">        zskiplistNode *next = x-&gt;level[<span class="number">0</span>].forward;</div><div class="line">        zslDeleteNode(zsl,x,update);</div><div class="line">        dictDelete(dict,x-&gt;obj);</div><div class="line">        zslFreeNode(x);</div><div class="line">        removed++;</div><div class="line">        x = next;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> removed;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//删除第start个节点到第end个节点之间的节点</span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">zslDeleteRangeByRank</span><span class="params">(zskiplist *zsl, <span class="keyword">unsigned</span> <span class="keyword">int</span> start, <span class="keyword">unsigned</span> <span class="keyword">int</span> end, dict *dict)</span> </span>&#123;</div><div class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> traversed = <span class="number">0</span>, removed = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp; (traversed + x-&gt;level[i].span) &lt; start) &#123;</div><div class="line">            traversed += x-&gt;level[i].span;</div><div class="line">            x = x-&gt;level[i].forward;</div><div class="line">        &#125;</div><div class="line">        update[i] = x;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    traversed++;</div><div class="line">    x = x-&gt;level[<span class="number">0</span>].forward;</div><div class="line">    <span class="keyword">while</span> (x &amp;&amp; traversed &lt;= end) &#123;</div><div class="line">        zskiplistNode *next = x-&gt;level[<span class="number">0</span>].forward;</div><div class="line">        zslDeleteNode(zsl,x,update);</div><div class="line">        dictDelete(dict,x-&gt;obj);</div><div class="line">        zslFreeNode(x);</div><div class="line">        removed++;</div><div class="line">        traversed++;</div><div class="line">        x = next;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> removed;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//给定键值对，获取它的rank值</span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">zslGetRank</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, robj *o)</span> </span>&#123;</div><div class="line">    zskiplistNode *x;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rank = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</div><div class="line">            (x-&gt;level[i].forward-&gt;score &lt; score ||</div><div class="line">                (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</div><div class="line">                compareStringObjects(x-&gt;level[i].forward-&gt;obj,o) &lt;= <span class="number">0</span>))) &#123;</div><div class="line">            rank += x-&gt;level[i].span;</div><div class="line">            x = x-&gt;level[i].forward;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* x might be equal to zsl-&gt;header, so test if obj is non-NULL */</span></div><div class="line">        <span class="keyword">if</span> (x-&gt;obj &amp;&amp; equalStringObjects(x-&gt;obj,o)) &#123;</div><div class="line">            <span class="keyword">return</span> rank;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//获取第rank个节点</span></div><div class="line"><span class="function">zskiplistNode* <span class="title">zslGetElementByRank</span><span class="params">(zskiplist *zsl, <span class="keyword">unsigned</span> <span class="keyword">long</span> rank)</span> </span>&#123;</div><div class="line">    zskiplistNode *x;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> traversed = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp; (traversed + x-&gt;level[i].span) &lt;= rank)</div><div class="line">        &#123;</div><div class="line">            traversed += x-&gt;level[i].span;</div><div class="line">            x = x-&gt;level[i].forward;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (traversed == rank) &#123;</div><div class="line">            <span class="keyword">return</span> x;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//把命令行中指定的字符串形式的范围转换到浮点数形式的范围中，下面的注释中有说明</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">zslParseRange</span><span class="params">(robj *min, robj *max, zrangespec *spec)</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> *eptr;</div><div class="line">    spec-&gt;minex = spec-&gt;maxex = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Parse the min-max interval. If one of the values is prefixed</span></div><div class="line">     * by the "(" character, it's considered "open". For instance</div><div class="line">     * ZRANGEBYSCORE zset (1.5 (2.5 will match min &lt; x &lt; max</div><div class="line">     * ZRANGEBYSCORE zset 1.5 2.5 will instead match min &lt;= x &lt;= max */</div><div class="line">    <span class="keyword">if</span> (min-&gt;encoding == OBJ_ENCODING_INT) &#123;</div><div class="line">        spec-&gt;min = (<span class="keyword">long</span>)min-&gt;ptr;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (((<span class="keyword">char</span>*)min-&gt;ptr)[<span class="number">0</span>] == <span class="string">'('</span>) &#123;</div><div class="line">            spec-&gt;min = strtod((<span class="keyword">char</span>*)min-&gt;ptr+<span class="number">1</span>,&amp;eptr);</div><div class="line">            <span class="keyword">if</span> (eptr[<span class="number">0</span>] != <span class="string">'\0'</span> || isnan(spec-&gt;min)) <span class="keyword">return</span> C_ERR;</div><div class="line">            spec-&gt;minex = <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            spec-&gt;min = strtod((<span class="keyword">char</span>*)min-&gt;ptr,&amp;eptr);</div><div class="line">            <span class="keyword">if</span> (eptr[<span class="number">0</span>] != <span class="string">'\0'</span> || isnan(spec-&gt;min)) <span class="keyword">return</span> C_ERR;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (max-&gt;encoding == OBJ_ENCODING_INT) &#123;</div><div class="line">        spec-&gt;max = (<span class="keyword">long</span>)max-&gt;ptr;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (((<span class="keyword">char</span>*)max-&gt;ptr)[<span class="number">0</span>] == <span class="string">'('</span>) &#123;</div><div class="line">            spec-&gt;max = strtod((<span class="keyword">char</span>*)max-&gt;ptr+<span class="number">1</span>,&amp;eptr);</div><div class="line">            <span class="keyword">if</span> (eptr[<span class="number">0</span>] != <span class="string">'\0'</span> || isnan(spec-&gt;max)) <span class="keyword">return</span> C_ERR;</div><div class="line">            spec-&gt;maxex = <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            spec-&gt;max = strtod((<span class="keyword">char</span>*)max-&gt;ptr,&amp;eptr);</div><div class="line">            <span class="keyword">if</span> (eptr[<span class="number">0</span>] != <span class="string">'\0'</span> || isnan(spec-&gt;max)) <span class="keyword">return</span> C_ERR;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> C_OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//下面的几个带有Lex字样的函数是把命令行的各种代表数据的字符串转化成真正的数据，实际上是转化和包装函数</span></div><div class="line"><span class="comment">/* Parse max or min argument of ZRANGEBYLEX.</span></div><div class="line">  * (foo means foo (open interval)</div><div class="line">  * [foo means foo (closed interval)</div><div class="line">  * - means the min string possible</div><div class="line">  * + means the max string possible</div><div class="line">  *</div><div class="line">  * If the string is valid the *dest pointer is set to the redis object</div><div class="line">  * that will be used for the comparision, and ex will be set to 0 or 1</div><div class="line">  * respectively if the item is exclusive or inclusive. C_OK will be</div><div class="line">  * returned.</div><div class="line">  *</div><div class="line">  * If the string is not a valid range C_ERR is returned, and the value</div><div class="line">  * of *dest and *ex is undefined. */</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslParseLexRangeItem</span><span class="params">(robj *item, robj **dest, <span class="keyword">int</span> *ex)</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> *c = item-&gt;ptr;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span>(c[<span class="number">0</span>]) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">'+'</span>:</div><div class="line">        <span class="keyword">if</span> (c[<span class="number">1</span>] != <span class="string">'\0'</span>) <span class="keyword">return</span> C_ERR;</div><div class="line">        *ex = <span class="number">0</span>;</div><div class="line">        *dest = shared.maxstring;</div><div class="line">        incrRefCount(shared.maxstring);</div><div class="line">        <span class="keyword">return</span> C_OK;</div><div class="line">    <span class="keyword">case</span> <span class="string">'-'</span>:</div><div class="line">        <span class="keyword">if</span> (c[<span class="number">1</span>] != <span class="string">'\0'</span>) <span class="keyword">return</span> C_ERR;</div><div class="line">        *ex = <span class="number">0</span>;</div><div class="line">        *dest = shared.minstring;</div><div class="line">        incrRefCount(shared.minstring);</div><div class="line">        <span class="keyword">return</span> C_OK;</div><div class="line">    <span class="keyword">case</span> <span class="string">'('</span>:</div><div class="line">        *ex = <span class="number">1</span>;</div><div class="line">        *dest = createStringObject(c+<span class="number">1</span>,sdslen(c)<span class="number">-1</span>);</div><div class="line">        <span class="keyword">return</span> C_OK;</div><div class="line">    <span class="keyword">case</span> <span class="string">'['</span>:</div><div class="line">        *ex = <span class="number">0</span>;</div><div class="line">        *dest = createStringObject(c+<span class="number">1</span>,sdslen(c)<span class="number">-1</span>);</div><div class="line">        <span class="keyword">return</span> C_OK;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        <span class="keyword">return</span> C_ERR;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* Populate the rangespec according to the objects min and max.</span></div><div class="line"> *</div><div class="line"> * Return C_OK on success. On error C_ERR is returned.</div><div class="line"> * When OK is returned the structure must be freed with zslFreeLexRange(),</div><div class="line"> * otherwise no release is needed. */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">zslParseLexRange</span><span class="params">(robj *min, robj *max, zlexrangespec *spec)</span> </span>&#123;</div><div class="line">    <span class="comment">/* The range can't be valid if objects are integer encoded.</span></div><div class="line">     * Every item must start with ( or [. */</div><div class="line">    <span class="keyword">if</span> (min-&gt;encoding == OBJ_ENCODING_INT ||</div><div class="line">        max-&gt;encoding == OBJ_ENCODING_INT) <span class="keyword">return</span> C_ERR;</div><div class="line"></div><div class="line">    spec-&gt;min = spec-&gt;max = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (zslParseLexRangeItem(min, &amp;spec-&gt;min, &amp;spec-&gt;minex) == C_ERR ||</div><div class="line">        zslParseLexRangeItem(max, &amp;spec-&gt;max, &amp;spec-&gt;maxex) == C_ERR) &#123;</div><div class="line">        <span class="keyword">if</span> (spec-&gt;min) decrRefCount(spec-&gt;min);</div><div class="line">        <span class="keyword">if</span> (spec-&gt;max) decrRefCount(spec-&gt;max);</div><div class="line">        <span class="keyword">return</span> C_ERR;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> C_OK;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* Free a lex range structure, must be called only after zelParseLexRange()</span></div><div class="line"> * populated the structure with success (C_OK returned). */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">zslFreeLexRange</span><span class="params">(zlexrangespec *spec)</span> </span>&#123;</div><div class="line">    decrRefCount(spec-&gt;min);</div><div class="line">    decrRefCount(spec-&gt;max);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* This is just a wrapper to compareStringObjects() that is able to</span></div><div class="line"> * handle shared.minstring and shared.maxstring as the equivalent of</div><div class="line"> * -inf and +inf for strings */</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">compareStringObjectsForLexRange</span><span class="params">(robj *a, robj *b)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (a == b) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* This makes sure that we handle inf,inf and</span></div><div class="line">                             -inf,-inf ASAP. One special case less. */</div><div class="line">    <span class="keyword">if</span> (a == shared.minstring || b == shared.maxstring) <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    <span class="keyword">if</span> (a == shared.maxstring || b == shared.minstring) <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    <span class="keyword">return</span> compareStringObjects(a,b);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">zslLexValueGteMin</span><span class="params">(robj *value, zlexrangespec *spec)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> spec-&gt;minex ?</div><div class="line">        (compareStringObjectsForLexRange(value,spec-&gt;min) &gt; <span class="number">0</span>) :</div><div class="line">        (compareStringObjectsForLexRange(value,spec-&gt;min) &gt;= <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">zslLexValueLteMax</span><span class="params">(robj *value, zlexrangespec *spec)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> spec-&gt;maxex ?</div><div class="line">        (compareStringObjectsForLexRange(value,spec-&gt;max) &lt; <span class="number">0</span>) :</div><div class="line">        (compareStringObjectsForLexRange(value,spec-&gt;max) &lt;= <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* Returns if there is a part of the zset is in the lex range. */</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">zslIsInLexRange</span><span class="params">(zskiplist *zsl, zlexrangespec *range)</span> </span>&#123;</div><div class="line">    zskiplistNode *x;</div><div class="line"></div><div class="line">    <span class="comment">/* Test for ranges that will always be empty. */</span></div><div class="line">    <span class="keyword">if</span> (compareStringObjectsForLexRange(range-&gt;min,range-&gt;max) &gt; <span class="number">1</span> ||</div><div class="line">            (compareStringObjects(range-&gt;min,range-&gt;max) == <span class="number">0</span> &amp;&amp;</div><div class="line">            (range-&gt;minex || range-&gt;maxex)))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    x = zsl-&gt;tail;</div><div class="line">    <span class="keyword">if</span> (x == <span class="literal">NULL</span> || !zslLexValueGteMin(x-&gt;obj,range))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    x = zsl-&gt;header-&gt;level[<span class="number">0</span>].forward;</div><div class="line">    <span class="keyword">if</span> (x == <span class="literal">NULL</span> || !zslLexValueLteMax(x-&gt;obj,range))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* Find the first node that is contained in the specified lex range.</span></div><div class="line"> * Returns NULL when no element is contained in the range. */</div><div class="line"><span class="function">zskiplistNode *<span class="title">zslFirstInLexRange</span><span class="params">(zskiplist *zsl, zlexrangespec *range)</span> </span>&#123;</div><div class="line">    zskiplistNode *x;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    <span class="comment">/* If everything is out of range, return early. */</span></div><div class="line">    <span class="keyword">if</span> (!zslIsInLexRange(zsl,range)) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="comment">/* Go forward while *OUT* of range. */</span></div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</div><div class="line">            !zslLexValueGteMin(x-&gt;level[i].forward-&gt;obj,range))</div><div class="line">                x = x-&gt;level[i].forward;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* This is an inner range, so the next node cannot be NULL. */</span></div><div class="line">    x = x-&gt;level[<span class="number">0</span>].forward;</div><div class="line">    serverAssert(x != <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* Check if score &lt;= max. */</span></div><div class="line">    <span class="keyword">if</span> (!zslLexValueLteMax(x-&gt;obj,range)) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* Find the last node that is contained in the specified range.</span></div><div class="line"> * Returns NULL when no element is contained in the range. */</div><div class="line"><span class="function">zskiplistNode *<span class="title">zslLastInLexRange</span><span class="params">(zskiplist *zsl, zlexrangespec *range)</span> </span>&#123;</div><div class="line">    zskiplistNode *x;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    <span class="comment">/* If everything is out of range, return early. */</span></div><div class="line">    <span class="keyword">if</span> (!zslIsInLexRange(zsl,range)) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="comment">/* Go forward while *IN* range. */</span></div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</div><div class="line">            zslLexValueLteMax(x-&gt;level[i].forward-&gt;obj,range))</div><div class="line">                x = x-&gt;level[i].forward;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* This is an inner range, so this node cannot be NULL. */</span></div><div class="line">    serverAssert(x != <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* Check if score &gt;= min. */</span></div><div class="line">    <span class="keyword">if</span> (!zslLexValueGteMin(x-&gt;obj,range)) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">&#125;</div><div class="line"><span class="comment">//再以下的代码是ziplist的api和有序集合的命令实现，以后再作讨论</span></div><div class="line"></div><div class="line"><span class="comment">/* 此处省略ziplist的api和有序集合的命令实现的代码 */</span></div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Redis中的跳表实现跟一般教科书上的跳表实现基本相同，有一点不同的是Redis在skiplist的节点中加入了backward属性，来记录上一个节点的地址，由此跳表的节点与节点间便变成了一个双向链表，这样做在方便节点的插入删除操作的同时，又帮助实现了诸如ZREVRANGE这样的指令。</p>
<p>能力有限，难免有分析不周全或分析错误的地方，如发现望指出，大家一起学习交流。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/17/UOOC插件/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/17/UOOC插件/" itemprop="url">
                  UOOC插件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-17T15:08:19+08:00">
                2016-11-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/17/UOOC插件/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/17/UOOC插件/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>很多同学对于UOOC上的这种限制应该并不陌生，有没有办法可以解除这个限制呢？这是我很久以前的一个想法了，但是一直都懒于去实现，对于UOOC视频失去焦点时自动暂停的这种限制，都是自己打开浏览器，手动改改其中的JavaScript，让其解除限制，然而这种方法神烦，当页面重新加载的时候，又要重新手动修改JavaScript代码。于是，本文所要讲述的这个插件诞生了，技术手段比较简单，这里就不阐述了。但不可否认，它非常的实用，大家感兴趣可以按以下指引安装到自己的浏览器上。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载地址：<a href="https://kimlongli.github.io/files/uooc.crx">https://kimlongli.github.io/files/uooc.crx</a><br>（注：支持的浏览器有chrome浏览器或者如360极速浏览器、猎豹浏览器这种带有chrome内核的浏览器，如果用chrome直接点击链接下载，由于此插件不是google应用商店上面的插件，所以会提示插件安装失败，可以换用另外一种方式下载，鼠标右键，另存为，然后按照下面的方法去安装）<br>猎豹浏览器和360浏览器直接点击下载连接安装即可。<br>chrome安装方法如下：<br>根据如上给出的下载地址下载好uooc.crx，然后打开chrome浏览器的[更多工具-&gt;拓展程序]，然后把uooc.crx拖曳进来就行了，期间会提示是否添加插件之类的提示，按指示操作就好了。<br>插件安装截图：<br><img src="/uploads/uooc2.jpg" alt="uooc2.jpeg"><br><img src="/uploads/uooc1.jpg" alt="uooc1.jpeg"></p>
<h3 id="A-amp-Q"><a href="#A-amp-Q" class="headerlink" title="A&amp;Q"></a>A&amp;Q</h3><p>Q:发现添加了这个UOOC插件之后，我的视频就暂停不了了，那应该怎样暂停呢？<br>A:点击网页上方的关闭按钮就好啦<br>Q:停用了这个插件之后，当我想要再次开启的时候，发现其提示是”并非来自Chrome网上应用商店”，然后开启的框框点击不了。<br>A:先卸载掉这个插件，再重新添加就好啦。<br>Q:UOOC网站有两个，一个是<a href="http://www.uooc.online/" target="_blank" rel="external">http://www.uooc.online/</a>，另一个是<a href="http://uooc.net.cn/portal" target="_blank" rel="external">http://uooc.net.cn/portal</a>，插件对两个网站都有效吗？<br>A:对<a href="http://www.uooc.online/" target="_blank" rel="external">http://www.uooc.online/</a>的支持比较好，基本功能都能用，但对于<a href="http://uooc.net.cn/portal" target="_blank" rel="external">http://uooc.net.cn/portal</a>不支持快进功能。</p>
<h3 id="欢迎反馈"><a href="#欢迎反馈" class="headerlink" title="欢迎反馈"></a>欢迎反馈</h3><p>插件处于测试阶段，可能会有bug，欢迎向我反馈：kimlongli@icloud.com</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/17/笔记：后缀数组/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/17/笔记：后缀数组/" itemprop="url">
                  笔记：后缀数组
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-17T01:02:14+08:00">
                2016-11-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/17/笔记：后缀数组/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/17/笔记：后缀数组/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>假如要实现这样一个功能，给定一个字符串str，找出str中重复的最长的子串，比如，给定”banana”，其中最长的出现重复的子串为ana（分别出现在第1个位置和第3个位置上），穷解法的时间复杂度为O(m * n^2)，利用后缀数组可以在O(nlogn + n)的复杂度下实现此功能。<br>比如给定一个字符串”banana”，先列出其后缀：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">banana</div><div class="line">anana</div><div class="line">nana</div><div class="line">ana</div><div class="line">na</div><div class="line">a</div></pre></td></tr></table></figure></p>
<p>然后对后缀进行排序<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">a</div><div class="line">ana</div><div class="line">anana</div><div class="line">banana</div><div class="line">na</div><div class="line">nana</div></pre></td></tr></table></figure></p>
<p>然后对排好序的后缀进行一次线性扫描即可找出”banana”中出现重复的最长的子串为”ana”，时间复杂度为O(nlogn + n)</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>具体实现如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="comment">//最大字符串长度</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_LENGTH 1024</span></div><div class="line"></div><div class="line"><span class="comment">//字符串比较函数</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">cmp_char</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *a, <span class="keyword">const</span> <span class="keyword">void</span> *b)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">strcmp</span>(*((<span class="keyword">char</span>**)a), *((<span class="keyword">char</span>**)b));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//计算字符串a和字符串b的公共前缀长度</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">compute_common_len</span><span class="params">(<span class="keyword">char</span> *a, <span class="keyword">char</span> *b)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">	<span class="keyword">while</span>(*a != <span class="string">'\0'</span> &amp;&amp; *b != <span class="string">'\0'</span> &amp;&amp; *(a++) == *(b++))</div><div class="line">		result++;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">char</span> str[MAX_LENGTH];	<span class="comment">//存储字符串</span></div><div class="line">	<span class="keyword">char</span> *pstr[MAX_LENGTH];	<span class="comment">//后缀数组</span></div><div class="line"></div><div class="line">	<span class="built_in">cout</span>&lt;&lt;<span class="string">"input the string:"</span>;</div><div class="line">	<span class="built_in">cin</span>&gt;&gt;str;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> i, limit = <span class="built_in">strlen</span>(str);</div><div class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; limit; i++) &#123;</div><div class="line">		pstr[i] = &amp;str[i];	<span class="comment">//初始化后缀数组</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	qsort(pstr, limit, <span class="keyword">sizeof</span>(<span class="keyword">char</span>*), cmp_char);	<span class="comment">//对后缀数组进行排序</span></div><div class="line"></div><div class="line">	<span class="comment">//输出排好序的后缀数组</span></div><div class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; limit; i++) &#123;</div><div class="line">		<span class="built_in">cout</span>&lt;&lt;pstr[i]&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="keyword">int</span> max_len = <span class="number">-1</span>;	<span class="comment">//记录最大公共前缀长度</span></div><div class="line">	<span class="keyword">int</span> index = <span class="number">-1</span>;		<span class="comment">//记录结果在数组pstr中的索引</span></div><div class="line">	<span class="keyword">int</span> common_len;</div><div class="line"></div><div class="line">	<span class="comment">//线性扫描</span></div><div class="line">	<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt; limit; i++) &#123;</div><div class="line">		<span class="comment">//计算pstr[i - 1]和pstr[i]的公共前缀长度</span></div><div class="line">		common_len = compute_common_len(pstr[i - <span class="number">1</span>], pstr[i]);</div><div class="line"></div><div class="line">		<span class="comment">//如果计算出来的公共前缀长度比max_len大，则更新max_len和index</span></div><div class="line">		<span class="keyword">if</span>(common_len &gt; max_len) &#123;</div><div class="line">			max_len = common_len;</div><div class="line">			index = i - <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//输出结果</span></div><div class="line">	<span class="built_in">cout</span>&lt;&lt;<span class="string">"result:"</span>&lt;&lt;pstr[index]&lt;&lt;<span class="built_in">endl</span>;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行程序，输入banana，输出结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ ./a.out</div><div class="line">input the string:banana</div><div class="line">a</div><div class="line">ana</div><div class="line">anana</div><div class="line">banana</div><div class="line">na</div><div class="line">nana</div><div class="line">result:ana</div></pre></td></tr></table></figure></p>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>稍微修改以上给出的代码，读取《鲁宾逊漂流记》里面的内容，然后找出小说中重复过的最长的一句话：</p>
<blockquote>
<p>that if i did take this foolish step, god would not bless me, and i would have leisure hereafter to reflect upon having neglected his counsel</p>
</blockquote>
<p>后缀数组还可用在文本编辑器的字符串搜索上，因为在文本编辑器中，可能需要频繁地进行搜索操作，所以每次搜索都使用KMP或者BM算法对文本就行遍历一遍那是不可行的，可以利用后缀数组建立后缀树（skiplist也可以），这样每次搜索的成本就降到了O(logn)，大大提升了性能。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>《编程珠玑》第十五章 珍珠字符串</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/16/备忘：MySQL创建用户中的坑/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/16/备忘：MySQL创建用户中的坑/" itemprop="url">
                  备忘：MySQL创建用户中的坑
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-16T18:11:35+08:00">
                2016-11-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/16/备忘：MySQL创建用户中的坑/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/16/备忘：MySQL创建用户中的坑/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>MySQL数据库作业中需要创建多用户，并对其赋予相应的权限。于是我索性用create user语句创建了一个名为lijinlong的用户，如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">user</span> lijinlong@<span class="string">"%"</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">"password"</span>;</div><div class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</div></pre></td></tr></table></figure>
<p>@后面使用通配符是因为想要这个账户在任何主机都可以登录。创建好账户之后退出数据库，重新用lijinlong的账号登录，发现就算密码输入对了仍然是Access denied。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ mysql -u lijinlong -p</div><div class="line">Enter password: </div><div class="line">ERROR 1045 (28000): Access denied <span class="keyword">for</span> user <span class="string">'lijinlong'</span>@<span class="string">'localhost'</span> (using password: YES)</div></pre></td></tr></table></figure>
<p>难道是lijinlong账户没有相应的权限，于是用root账户给账户lijinlong赋予了所有权限。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> lijinlong@<span class="string">"%"</span>;</div></pre></td></tr></table></figure>
<p>重新登录，依然是Access denied。</p>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>百思不得其解，于是去翻MySQL的用户手册，看到如下一段话。</p>
<blockquote>
<p>The ‘finley’@’localhost’ account is necessary if there is an anonymous-user account for localhost. Without the ‘finley’@’localhost’ account, that anonymous-user account takes precedence when finley connects from the local host and finley is treated as an anonymous user. The reason for this is that the anonymous-user account has a more specific Host column value than the ‘finley’@’%’ account and thus comes earlier in the user table sort order. (user table sorting is discussed in Section 6.2.4, “Access Control, Stage 1: Connection Verification”.)</p>
</blockquote>
<p>传送门：<a href="http://dev.mysql.com/doc/refman/5.6/en/adding-users.html" target="_blank" rel="external">http://dev.mysql.com/doc/refman/5.6/en/adding-users.html</a></p>
<p>原来是由于新建的账户host为”%”，原生的匿名账户比新建的lijinlong账户更加具体，所以lijinlong会被视为匿名账户。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> lijinlong@<span class="string">"localhost"</span>;</div></pre></td></tr></table></figure>
<p>成功解决问题。<br>还有一种解决办法是直接删除掉无用的匿名账户。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/16/新博客/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/16/新博客/" itemprop="url">
                  新博客
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-16T17:44:54+08:00">
                2016-11-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/11/16/新博客/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/16/新博客/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="为什么要开新博客"><a href="#为什么要开新博客" class="headerlink" title="为什么要开新博客"></a>为什么要开新博客</h3><p>之前开过两次技术博客，一次挂在新浪的SAE上，一次挂在腾讯云上，但是都因为各种原因被迫停掉了（域名续费、服务器续费，60+每月只为撑起一个技术博客太不划算了），CSDN是一个选择，但是个人不喜欢上面各种乱七八糟的广告，现在干脆把博客做成静态页面，然后把它挂到Github提供的Github Pages服务上。</p>
<h3 id="感兴趣的领域"><a href="#感兴趣的领域" class="headerlink" title="感兴趣的领域"></a>感兴趣的领域</h3><p>个人比较感兴趣的领域有数据库、操作系统、网络安全、编译原理、各种五花八门的算法问题、Web和Adroid(iOS)等应用开发，当然，作为CS专业的学生，关于计算机的各种原理、应用都应了解，平时也爱瞎折腾，欢迎跟我交流任何关于计算机的技术，我的邮箱是kimlongli@icloud.com。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.png"
               alt="李金隆" />
          <p class="site-author-name" itemprop="name">李金隆</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">10</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李金隆</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"kimlongli"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  

  


</body>
</html>
