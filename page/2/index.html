<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="李金隆的博客, Jinlong blog, 副业造轮子" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Jinlong's Blog">
<meta property="og:url" content="http://kimlongli.github.io/page/2/index.html">
<meta property="og:site_name" content="Jinlong's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jinlong's Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-1180709375655337",
    enable_page_level_ads: true
  });
</script>



  <link rel="canonical" href="http://kimlongli.github.io/page/2/"/>





  <title> Jinlong's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Jinlong's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">副业造轮子</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            文章
          </a>
        </li>
      
        
        <li class="menu-item menu-item-essays">
          <a href="/essays" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-newspaper-o"></i> <br />
            
            随笔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      
      	

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2017/08/26/快速幂算法/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/26/快速幂算法/" itemprop="url">
                  快速幂运算算法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-26T22:55:37+08:00">
                2017-08-26
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一般思路的求幂函数会是如下所示：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">power</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> i;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> result = <span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">		result *= a;</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以上函数算法复杂度为O(n)，快速幂算法可以将幂运算的算法复杂度降到O(logn)。原理如下。<br>比如计算3^13，因为13的二进制表示为1101，所以：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">3 ^ 13 = 3 ^ [1] * 3 ^ [00] * 3 ^ [100] * 3 ^ [1000]</div></pre></td></tr></table></figure></p>
<p>（注：中括号内为二进制表示）<br>类似的，我们对于所有幂运算都可以化成以上形式，算法复杂度由原来的O(n)变为O(logn)，矩阵快速幂运算代码实现如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//重载矩阵类的^运算符</span></div><div class="line">Matrix <span class="keyword">operator</span>^(<span class="keyword">int</span> n) &#123;</div><div class="line">	Matrix result, multi;</div><div class="line"></div><div class="line">	result.init();   <span class="comment">//初始化为单位矩阵</span></div><div class="line">	multi = *<span class="keyword">this</span>;	 </div><div class="line"></div><div class="line">	<span class="keyword">while</span>(n) &#123;</div><div class="line">		<span class="keyword">if</span>(n &amp; <span class="number">0x1</span>) &#123;</div><div class="line">			result = result * multi;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		multi = multi * multi;</div><div class="line">		n &gt;&gt;= <span class="number">1</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>(注：Matrix为矩阵)</p>
<p>应用（快速计算斐波那契数列）：<br>一般计算斐波那契数列我们用递推的方法：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">calc1</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span>(n == <span class="number">1</span> || n == <span class="number">2</span>)</div><div class="line">		<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(n &lt;= <span class="number">0</span>)</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> i;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> *arr = <span class="keyword">new</span> <span class="keyword">long</span> <span class="keyword">long</span>[n];</div><div class="line">	arr[<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line">	arr[<span class="number">1</span>] = <span class="number">1</span>;</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(i = <span class="number">2</span>; i &lt; n; i++) &#123;</div><div class="line">		arr[i] = arr[i - <span class="number">1</span>] + arr[i - <span class="number">2</span>];</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> arr[i - <span class="number">1</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果我们要求斐波那契数列的第一亿项，递推求值的方式将会花费很长的时间。<br>由于f(n) = f(n - 1) + f(n - 2)，所以<br><img src="/uploads/quick2.jpg" alt="quick2.jpg"><br>推出<br><img src="/uploads/quick1.jpg" alt="quick1.jpg"><br>至此我们就可以在求斐波那契数列中应用上快速幂运算了：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">calc2</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span>(n == <span class="number">1</span> || n == <span class="number">2</span>)</div><div class="line">		<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(n &lt;= <span class="number">0</span>)</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line"></div><div class="line">	Matrix m;</div><div class="line">	m.arr[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line">	m.arr[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">1</span>;</div><div class="line">	m.arr[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line">	m.arr[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">0</span>;</div><div class="line"></div><div class="line">	Matrix a = m ^ (n - <span class="number">2</span>);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> a.arr[<span class="number">0</span>][<span class="number">0</span>] * <span class="number">1</span> + a.arr[<span class="number">0</span>][<span class="number">1</span>] * <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      	

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2017/03/28/一个基于动态规划lcs算法的迷你文本比较器/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/28/一个基于动态规划lcs算法的迷你文本比较器/" itemprop="url">
                  一个基于动态规划lcs算法的迷你文本比较器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-28T18:38:13+08:00">
                2017-03-28
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>github地址<a href="https://github.com/kimlongli/min-diff" target="_blank" rel="external">https://github.com/kimlongli/min-diff</a><br>此项目暂时不超过一百行代码，主体文件为diff.js。</p>
<p>使用方法如下：</p>
<ul>
<li><p>引入js文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"diff.js"</span>&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>调用diff函数获取结果</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">result = diff(txt1, txt2);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>其中txt1和txt2为需要比较的文本内容，比较结果将会以以下结果返回：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</div><div class="line"> 	a = <span class="number">1</span>;</div><div class="line">+	b = a + <span class="number">2</span>;</div><div class="line">-	c = b;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>每行前面的+代表这是增加的行，-代表这是减少的行。<br>可以通过<a href="https://kimlongli.github.io/demo/diff-demo.html">demo</a>来了解具体的实例。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      	

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2017/02/12/Linux下编写高性能的网络程序/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/12/Linux下编写高性能的网络程序/" itemprop="url">
                  Linux下编写高性能的网络程序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-12T18:53:48+08:00">
                2017-02-12
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="最简单的tcp服务器端程序"><a href="#最简单的tcp服务器端程序" class="headerlink" title="最简单的tcp服务器端程序"></a>最简单的tcp服务器端程序</h4><p>我们先来实现一个最简单的tcp服务器程序。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span>(sockfd == <span class="number">-1</span>) &#123;</div><div class="line">                perror(<span class="string">"socket"</span>);</div><div class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">        &#125;</div><div class="line">        sockaddr_in address;</div><div class="line">        address.sin_family = AF_INET;</div><div class="line">        address.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line">        address.sin_port = htons(<span class="number">9090</span>);</div><div class="line">        <span class="keyword">int</span> addr_len = <span class="keyword">sizeof</span>(address);</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">int</span> res = bind(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;address, addr_len);</div><div class="line">        listen(sockfd, <span class="number">5</span>);</div><div class="line">        <span class="keyword">if</span>(res == <span class="number">-1</span>) &#123;</div><div class="line">                perror(<span class="string">"bind"</span>);</div><div class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *msg = <span class="string">"Hello. I'm server."</span>;</div><div class="line">        <span class="keyword">char</span> data_rcv[<span class="number">1024</span>];</div><div class="line">        sockaddr_in client_addr;</div><div class="line">        <span class="keyword">int</span> client_fd;</div><div class="line">        <span class="keyword">socklen_t</span> client_socklen = <span class="keyword">sizeof</span>(client_addr);</div><div class="line"></div><div class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">                <span class="built_in">cout</span>&lt;&lt;<span class="string">"server is waiting for connect..."</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">                client_fd = accept(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;client_socklen);</div><div class="line">                <span class="keyword">if</span>(client_fd == <span class="number">-1</span>) &#123;</div><div class="line">                        perror(<span class="string">"accept"</span>);</div><div class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">int</span> nwrite = write(client_fd, msg, <span class="built_in">strlen</span>(msg));</div><div class="line">                <span class="built_in">cout</span>&lt;&lt;<span class="string">"write "</span>&lt;&lt;nwrite&lt;&lt;<span class="string">" bytes"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">                close(client_fd);</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        close(sockfd);</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">return</span> EXIT_SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个服务器程序简单地建立、绑定、监听套接字，然后逐一地accept来自客户端的请求。这是最简单的模型，只能串行地先处理一个请求，在对客户端write完之后，关闭客户端套接字，然后再accept下一个请求。在网络不好的情况下，在当前请求的处理中，由于write等函数可能被网络阻塞，导致执行异常缓慢，下一个请求可能被block很久。毫无疑问，这样的服务器模型是肯定不能满足需要应付大访问量的业务需求的。需要注意的是一些数据成员我们要先通过hton系列函数把它转换成网络字节序（网络字节序是大端表示，我们的PC大多数都是小端机器），否则会出现奇怪的现象，比如说没有把端口号9090通过htons转换成网络字节序的话，通过netstat -tln查看发现打开的并不是9090端口，而是33315端口（因为9090的小端表示是0x8223，在大端看来，0x8223等于十进制的33315）。下图是9090没有通过htons转换的结果：<br><img src="/uploads/server2.png" alt="server2.png"><br>telnet可以帮我们测试这个小程序。图中红框部分是server的响应消息。在发送完消息之后，服务器关闭了连接。<br><img src="/uploads/server1.png" alt="server1.png"></p>
<h4 id="将其改造成http服务器"><a href="#将其改造成http服务器" class="headerlink" title="将其改造成http服务器"></a>将其改造成http服务器</h4><p>为了方便压力测试，我们将其改造成简单的http echo服务器，先定义对应的响应头和相应体，并初始化相应头。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> *header_pattern = <span class="string">"HTTP/1.0 200 OK\r\nContent-length: %d\r\nContent-type: text/html\r\n\r\n"</span>;</div><div class="line"><span class="keyword">char</span> header[<span class="number">512</span>];</div><div class="line"><span class="keyword">char</span> *body = <span class="string">"hello, world"</span>;</div><div class="line"><span class="built_in">sprintf</span>(header, header_pattern, <span class="built_in">strlen</span>(body));</div></pre></td></tr></table></figure></p>
<p>在header_pattern中，预留了%d存放body的长度，第四行使用sprintf将body的长度写入其中。<br>然后在accept之后，先后把响应头和响应体写到客户端（注意：是分两次write而不是header和body合起来一起写）。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">write(client_fd, header, <span class="built_in">strlen</span>(header));</div><div class="line">write(client_fd, body, <span class="built_in">strlen</span>(body));</div></pre></td></tr></table></figure></p>
<p>然后我们就可以通过浏览器访问我们的”服务器了“。<br><img src="/uploads/server.jpg" alt="server.jpg"></p>
<h4 id="异步响应多客户端"><a href="#异步响应多客户端" class="headerlink" title="异步响应多客户端"></a>异步响应多客户端</h4><p>要克服后面的请求会被block很久的毛病，我们必须想办法让服务器程序可以”并行“地处理正在排队等待处理的请求。多线程可以帮我们做到这一点。</p>
<h5 id="多线程实现"><a href="#多线程实现" class="headerlink" title="多线程实现"></a>多线程实现</h5><p>我们用多线程方法改一下代码，得到以下程序。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> *content = <span class="string">"hello,world"</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> *header = <span class="string">"HTTP/1.0 200 OK\r\nContent-length: 11\r\nContent-type: text/html\r\n\r\n"</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span>* <span class="title">client_handler</span><span class="params">(<span class="keyword">void</span> *args)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> cli_fd = (<span class="keyword">int</span>)(<span class="keyword">long</span>)args;</div><div class="line">        <span class="keyword">char</span> *buf = <span class="keyword">new</span> <span class="keyword">char</span>[BUFSIZ];</div><div class="line">        read(cli_fd, buf, BUFSIZ);</div><div class="line">        <span class="keyword">delete</span> []buf;</div><div class="line">        write(cli_fd, header, <span class="built_in">strlen</span>(header));</div><div class="line">        write(cli_fd, content, <span class="built_in">strlen</span>(content));</div><div class="line">        close(cli_fd);</div><div class="line">        pthread_exit(<span class="literal">NULL</span>);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> sock_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line">        sockaddr_in serv_addr;</div><div class="line">        serv_addr.sin_family = AF_INET;</div><div class="line">        serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line">        serv_addr.sin_port = htons(<span class="number">9090</span>);</div><div class="line">        <span class="keyword">socklen_t</span> serv_addr_len = <span class="keyword">sizeof</span>(serv_addr);</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(bind(sock_fd, (sockaddr*)&amp;serv_addr, serv_addr_len) == <span class="number">-1</span>) &#123;</div><div class="line">                perror(<span class="string">"bind"</span>);</div><div class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(listen(sock_fd, <span class="number">128</span>) != <span class="number">0</span>) &#123;</div><div class="line">                perror(<span class="string">"listen"</span>);</div><div class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"start listening at port 9090 ..."</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">pthread_t</span> tid;</div><div class="line">        <span class="keyword">pthread_attr_t</span> attr;</div><div class="line">        pthread_attr_init(&amp;attr);</div><div class="line">        pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> cli_fd;</div><div class="line">        sockaddr_in cli_addr;</div><div class="line">        <span class="keyword">socklen_t</span> cli_addr_len = <span class="keyword">sizeof</span>(cli_addr);</div><div class="line"></div><div class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">                cli_fd = accept(sock_fd, (<span class="keyword">struct</span> sockaddr*)&amp;cli_addr, &amp;cli_addr_len);</div><div class="line">                <span class="keyword">if</span>(cli_fd == <span class="number">-1</span>) &#123;</div><div class="line">                        perror(<span class="string">"accept"</span>);</div><div class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">                &#125;</div><div class="line">                pthread_create(&amp;tid, &amp;attr, client_handler, (<span class="keyword">void</span>*)(<span class="keyword">long</span>)cli_fd);</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        close(sock_fd);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>思路很简单，每次accept了一个连接之后，启动单独启动一个额外的线程（设置其属性为脱离线程，这样我们就不用在主线程去join 了），由这个额外的线程去负责读写刚才accept的客户端套接字。由于主线程启动一个额外的线程之后可以立刻返回，进而可以继续accept，等待下一个连接的到来，下一个连接到来之后继续启动线程来处理。使用线程的好处是明显的，这样下一个连接就不用等待上一个连接完可以被服务器accept，并与其它请求“并行”地被服务器处理。但是多线程服务器模型有一个问题，那就是当来自客户端的请求量很大的时候，需要启动很多线程来负责处理请求，由于存在非常多的线程，系统仅仅调度这些线程便消耗了大量的的资源，所以此模型并不适合高访问量的场景。</p>
<h5 id="抛弃线程，使用多路复用函数select"><a href="#抛弃线程，使用多路复用函数select" class="headerlink" title="抛弃线程，使用多路复用函数select"></a>抛弃线程，使用多路复用函数select</h5><p>select函数可以让我们编写更加高性能的网络程序。我们可以把accept来的一堆客户端套接字放到select里面的套接字集，然后阻塞在select函数中，一旦有套接字可读可写，select会立刻返回，我们处理完相应的工作后（读写完可读可写的套接字之后），继续在select中阻塞，直到再次有请求的到来。这样就免去了系统调度一大堆线程的开支。我们用一个set来保存已有的套接字（源代码在下面给出），每一次都把set中的最大值加一放到select的第一个参数里面，下面的for循环进行套接字检查（从0开始到套接字的最大值遍历，用FD_ISINSET来检查当前套接字是否在套接字集合里面）的时候也直接用这个最大值作为上限，这样我们就不用每次都检查FD_SIZE那么多次了。</p>
<h5 id="使用非阻塞"><a href="#使用非阻塞" class="headerlink" title="使用非阻塞"></a>使用非阻塞</h5><p>在select返回之后，便开始对可读可写的套接字进行读写，然后接着阻塞在select中等待下一次有套接字可读可写。这样做有一个小问题，在select返回之后，在对相应套接字的读写过程中，可能会出现网络不好的现象，这样的话一些write和read函数就会阻塞，排在后面的可读可写的套接字就会一直得不到处理。<br>我们可以用非阻塞读写来解决这个问题。我们把所有的套接字都用fcntl来设置成非阻塞。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> flag = fcntl(sock_fd, F_GETFL, <span class="number">0</span>);</div><div class="line">flag |= O_NONBLOCK;</div><div class="line">fcntl(sock_fd, F_SETFL, flag);</div></pre></td></tr></table></figure></p>
<p>这种情况下，无论读写成功或者失败，或者只读或者只写了一部分，read和write函数会立刻返回，这样的话就不会影响后面的请求的处理了。因为write在非阻塞的情况下是遵守“能写多少就写多少的情况”，所以需要额外的数据结构来保存对每一个套接字已经写了多少（保存写的进度），以程序方便select下次返回的时候对相应的套接字在上次的断点上继续写数据。具体实现如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;set&gt;</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_PROGRESS 100000000</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//pair的比较类，这样做是为了确保pair.first为key（在set中不会出现重复）。</span></div><div class="line"><span class="keyword">struct</span> CompPair &#123;</div><div class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">operator</span> <span class="params">()</span><span class="params">(<span class="keyword">const</span> pair&lt;<span class="keyword">int</span>, <span class="keyword">size_t</span>&gt; &amp;p1, <span class="keyword">const</span> pair&lt;<span class="keyword">int</span>, <span class="keyword">size_t</span>&gt; &amp;p2)</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> p1.first &lt; p2.first;</div><div class="line">        &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//读取文件内容并返回</span></div><div class="line"><span class="function"><span class="keyword">char</span>* <span class="title">read_file_data</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *file_name, <span class="keyword">size_t</span> *len)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> fd = open(file_name, O_RDONLY);</div><div class="line">        <span class="keyword">struct</span> stat st;</div><div class="line">        <span class="keyword">char</span> *result = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">if</span>(fd != <span class="number">-1</span> &amp;&amp; fstat(fd, &amp;st) != <span class="number">-1</span>) &#123;</div><div class="line">                *len = st.st_size;</div><div class="line">                result = <span class="keyword">new</span> <span class="keyword">char</span>[*len + <span class="number">1</span>];</div><div class="line">                <span class="keyword">int</span> nread = read(fd, result, *len);</div><div class="line">                <span class="keyword">if</span>(*len != nread) &#123;</div><div class="line">                        <span class="keyword">delete</span> []result;</div><div class="line">                        result = <span class="literal">NULL</span>;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        close(fd);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//释放掉存放文件内容的指针</span></div><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">free_file_data</span><span class="params">(<span class="keyword">char</span>* p)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(p != <span class="literal">NULL</span>) &#123;</div><div class="line">                <span class="keyword">delete</span> []p;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</div><div class="line">		<span class="comment">/* 用法是命令后面直接跟一个文件名字，</span></div><div class="line">		*  这个文件就是要分享的文件，其内容</div><div class="line">		*  将作为响应的body，将会出现在浏览</div><div class="line">		*  器上，这样做事为了方便后面的性能</div><div class="line">		*  测试</div><div class="line">		*/</div><div class="line">        <span class="keyword">if</span>(argc != <span class="number">2</span>) &#123;</div><div class="line">                <span class="built_in">cout</span>&lt;&lt;<span class="string">"usage: "</span>&lt;&lt;argv[<span class="number">0</span>]&lt;&lt;<span class="string">" &lt;file to share&gt;"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">                <span class="built_in">exit</span>(EXIT_SUCCESS);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//读取文件数据，长度存在file_len中</span></div><div class="line">        <span class="keyword">size_t</span> file_len;</div><div class="line">        <span class="keyword">char</span> *file_data = read_file_data(argv[<span class="number">1</span>], &amp;file_len);</div><div class="line">        <span class="keyword">if</span>(file_data != <span class="literal">NULL</span>) &#123;</div><div class="line">                <span class="built_in">cout</span>&lt;&lt;<span class="string">"file size: "</span>&lt;&lt;file_len&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">cout</span>&lt;&lt;<span class="string">"open file error"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *header_pattern = <span class="string">"HTTP/1.0 200 OK\r\nContent-length: %d\r\nContent-type: text/html\r\n\r\n"</span>;</div><div class="line">        <span class="keyword">char</span> header[<span class="number">1024</span>];</div><div class="line">        <span class="comment">//把body的长度写入header当中</span></div><div class="line">        <span class="built_in">sprintf</span>(header, header_pattern, file_len);</div><div class="line">        <span class="keyword">int</span> header_len = <span class="built_in">strlen</span>(header);</div><div class="line"></div><div class="line">        <span class="comment">//保存进度的set，pair.first是相应的套接字值，第二个参数是已经写了的字节数</span></div><div class="line">        <span class="comment">//负数表示正在写header，正数表示正在写body</span></div><div class="line">        <span class="built_in">set</span>&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">size_t</span>&gt;, CompPair&gt; progress_set;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">int</span> sock_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="comment">//保存全部套接字的set，这样做事为了获取套接字最大值再加一传给select的第一个参数</span></div><div class="line">        <span class="built_in">set</span>&lt;<span class="keyword">int</span>&gt; sock_fd_set;</div><div class="line">        sock_fd_set.insert(sock_fd + <span class="number">1</span>);</div><div class="line"></div><div class="line">        <span class="comment">//把监听套接字设成非阻塞的</span></div><div class="line">        <span class="keyword">int</span> flag = fcntl(sock_fd, F_GETFL, <span class="number">0</span>);</div><div class="line">        flag |= O_NONBLOCK;</div><div class="line">        fcntl(sock_fd, F_SETFL, flag);</div><div class="line"></div><div class="line">        sockaddr_in serv_addr, cli_addr;</div><div class="line">        serv_addr.sin_family = AF_INET;</div><div class="line">        serv_addr.sin_port = htons(<span class="number">9734</span>);</div><div class="line">        serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line">        <span class="keyword">socklen_t</span> cli_addr_len = <span class="keyword">sizeof</span>(cli_addr);</div><div class="line">        <span class="keyword">int</span> serv_addr_len = <span class="keyword">sizeof</span>(serv_addr);</div><div class="line">        <span class="comment">//绑定</span></div><div class="line">        <span class="keyword">int</span> res = bind(sock_fd, (sockaddr*)&amp;serv_addr, serv_addr_len);</div><div class="line">        <span class="keyword">if</span>(res == <span class="number">-1</span>) &#123;</div><div class="line">                perror(<span class="string">"bind"</span>);</div><div class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//监听</span></div><div class="line">        listen(sock_fd, <span class="number">128</span>);</div><div class="line"></div><div class="line">        fd_set read_set, tmp_set, write_set, tmp_set1;</div><div class="line">        FD_ZERO(&amp;read_set);</div><div class="line">        FD_ZERO(&amp;write_set);</div><div class="line">        FD_SET(sock_fd, &amp;read_set);</div><div class="line">        <span class="keyword">char</span> buf[BUFSIZ];</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</div><div class="line">                tmp_set = read_set;</div><div class="line">                tmp_set1 = write_set;</div><div class="line">                timeval timeout = &#123; .tv_sec = <span class="number">5</span>, .tv_usec = <span class="number">500000</span> &#125;;</div><div class="line"></div><div class="line">                <span class="comment">//select函数调用，第一个参数是套接字的最大值加一，后面分别是需要读的套接字集，需要写的套接字集，错误输出套接字集</span></div><div class="line">                <span class="keyword">int</span> select_result = select(*(--sock_fd_set.end()), &amp;tmp_set, (fd_set*)&amp;tmp_set1, (fd_set*)<span class="literal">NULL</span>, &amp;timeout);</div><div class="line"></div><div class="line">                <span class="keyword">if</span>(select_result == <span class="number">0</span>) &#123;</div><div class="line">                        <span class="built_in">cout</span>&lt;&lt;<span class="string">"timeout"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(select_result == <span class="number">-1</span>) &#123;</div><div class="line">                        perror(<span class="string">"select"</span>);</div><div class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">int</span> i;</div><div class="line">                        <span class="comment">//获取套接字最大值</span></div><div class="line">                        <span class="keyword">int</span> max_sock_fd = *(--sock_fd_set.end());</div><div class="line">                        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; max_sock_fd; i++) &#123;</div><div class="line">                        	<span class="comment">//检查是否在可写套接字集中</span></div><div class="line">                                <span class="keyword">if</span>(FD_ISSET(i, &amp;tmp_set1)) &#123;</div><div class="line">                                        <span class="keyword">int</span> start_pos = <span class="number">0</span>;</div><div class="line">                                        <span class="comment">//找到当前套接字的写进度</span></div><div class="line">                                        <span class="built_in">set</span>&lt;pair&lt;<span class="keyword">int</span>, <span class="keyword">size_t</span>&gt; &gt;::iterator iter = progress_set.find(pair&lt;<span class="keyword">int</span>, <span class="keyword">size_t</span>&gt;(i, <span class="number">0</span>));</div><div class="line">                                        <span class="keyword">if</span>(iter != progress_set.end()) &#123;</div><div class="line">                                                start_pos = iter-&gt;second;</div><div class="line">                                        &#125;</div><div class="line">                                        <span class="keyword">else</span> &#123;</div><div class="line">                                                <span class="built_in">cout</span>&lt;&lt;<span class="string">"progress error"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">                                                <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">                                        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">                                        pair&lt;<span class="keyword">int</span>, <span class="keyword">size_t</span>&gt; pair_to_insert(iter-&gt;first, <span class="number">0</span>);</div><div class="line"></div><div class="line">                                        progress_set.erase(iter);</div><div class="line"></div><div class="line">                                        <span class="comment">//如果进度是INIT_PROGRESS，则开始写头部</span></div><div class="line">                                        <span class="keyword">if</span>(start_pos == INIT_PROGRESS) &#123;</div><div class="line">                                                <span class="comment">//cout&lt;&lt;"begin write header"&lt;&lt;endl;</span></div><div class="line">                                                <span class="keyword">int</span> nwrite = write(i, header, header_len);</div><div class="line">                                                <span class="keyword">if</span>(nwrite == header_len) &#123;</div><div class="line">                                                        pair_to_insert.second = <span class="number">0</span>;</div><div class="line">                                                        <span class="comment">//cout&lt;&lt;"finish write header"&lt;&lt;endl;</span></div><div class="line">                                                &#125;</div><div class="line">                                                <span class="keyword">else</span> &#123;</div><div class="line">                                                        start_pos = <span class="number">-1</span> - nwrite;</div><div class="line">                                                        pair_to_insert.second = start_pos;</div><div class="line">                                                &#125;</div><div class="line">                                        &#125;</div><div class="line">                                        <span class="comment">//如果进度大于等于0，写响应体</span></div><div class="line">                                        <span class="keyword">else</span> <span class="keyword">if</span>(start_pos &gt;= <span class="number">0</span>) &#123;</div><div class="line">                                                <span class="comment">//cout&lt;&lt;"write body"&lt;&lt;endl;</span></div><div class="line">                                                <span class="keyword">int</span> bytes_to_write = file_len - start_pos;</div><div class="line">                                                <span class="keyword">int</span> nwrite = write(i, file_data + start_pos, bytes_to_write);</div><div class="line">                                                <span class="keyword">if</span>(bytes_to_write == nwrite) &#123;</div><div class="line">                                                        FD_CLR(i, &amp;write_set);</div><div class="line">                                                        FD_CLR(i, &amp;read_set);</div><div class="line">                                                        close(i);</div><div class="line">                                                        <span class="comment">//cout&lt;&lt;"send to fd "&lt;&lt;i&lt;&lt;" done"&lt;&lt;endl;</span></div><div class="line">                                                        <span class="keyword">continue</span>;</div><div class="line">                                                &#125;</div><div class="line">                                                <span class="keyword">else</span> &#123;</div><div class="line">                                                        pair_to_insert.second = start_pos + nwrite;</div><div class="line">                                                &#125;</div><div class="line">                                        &#125;</div><div class="line">                                        <span class="comment">//如果进度为负，继续写头部，实际进度为进度的绝对值再减一</span></div><div class="line">                                        <span class="keyword">else</span> &#123;</div><div class="line">                                                <span class="comment">//cout&lt;&lt;"write header"&lt;&lt;endl;</span></div><div class="line">                                                start_pos = -start_pos - <span class="number">1</span>;</div><div class="line">                                                <span class="keyword">int</span> bytes_to_write = header_len - start_pos;</div><div class="line">                                                <span class="keyword">int</span> nwrite = write(i , header + start_pos, bytes_to_write);</div><div class="line">                                                <span class="comment">//写完了头部之后把进度设成0，告诉程序下次应该开始写响应体了</span></div><div class="line">                                                <span class="keyword">if</span>(nwrite == bytes_to_write) &#123;</div><div class="line"></div><div class="line">                                                        pair_to_insert.second = <span class="number">0</span>;</div><div class="line">                                                &#125;</div><div class="line">                                                <span class="comment">//否则保存好进度</span></div><div class="line">                                                <span class="keyword">else</span> &#123;</div><div class="line">                                                        pair_to_insert.second = <span class="number">-1</span> - start_pos - nwrite;</div><div class="line">                                                &#125;</div><div class="line">                                        &#125;</div><div class="line"></div><div class="line">                                        progress_set.insert(pair_to_insert);</div><div class="line">                                &#125;</div><div class="line">                                <span class="comment">//检查是否在可读套接字集中</span></div><div class="line">                                <span class="keyword">if</span>(FD_ISSET(i, &amp;tmp_set)) &#123;</div><div class="line">                        		<span class="comment">//如果是监听套接字，则accept新的客户端套接字，然后把新的客户端</span></div><div class="line">                        		<span class="comment">//套接字加入到读和写套接字集中</span></div><div class="line">                                        <span class="keyword">if</span>(i == sock_fd) &#123;</div><div class="line">                                                <span class="keyword">int</span> cli_fd = accept(i, (sockaddr*)&amp;cli_addr, &amp;cli_addr_len);</div><div class="line">                                                <span class="keyword">if</span>(cli_fd == <span class="number">-1</span>) &#123;</div><div class="line">                                                        perror(<span class="string">"accept"</span>);</div><div class="line">                                                        <span class="keyword">continue</span>;</div><div class="line">                                                &#125;</div><div class="line"></div><div class="line"></div><div class="line">                                                sock_fd_set.insert(cli_fd + <span class="number">1</span>);</div><div class="line">                                                <span class="comment">//初始化进度为INIT_PROGRESS</span></div><div class="line">                                                progress_set.insert(pair&lt;<span class="keyword">int</span>, <span class="keyword">size_t</span>&gt;(cli_fd, INIT_PROGRESS));</div><div class="line"></div><div class="line">                                                <span class="comment">//设置成非阻塞</span></div><div class="line">                                                flag = fcntl(cli_fd, F_GETFL, <span class="number">0</span>);</div><div class="line">                                                flag |= O_NONBLOCK;</div><div class="line">                                                fcntl(cli_fd, F_SETFL, flag);</div><div class="line"></div><div class="line">                                                <span class="comment">//加入到需要读的套接字集中</span></div><div class="line">                                                FD_SET(cli_fd, &amp;read_set);</div><div class="line">                                        &#125;</div><div class="line"></div><div class="line">                                        <span class="keyword">else</span> &#123;</div><div class="line">                                        		<span class="comment">//如果不是监听套接字，就读取请求头</span></div><div class="line">                                                <span class="keyword">int</span> nread = read(i, buf, BUFSIZ);</div><div class="line">                                                <span class="keyword">if</span>(nread == <span class="number">0</span>) &#123;</div><div class="line">                                                        close(i);</div><div class="line">                                                        FD_CLR(i, &amp;read_set);</div><div class="line">                                                        FD_CLR(i, &amp;write_set);</div><div class="line"></div><div class="line">                                                        <span class="built_in">set</span>&lt;<span class="keyword">int</span>&gt;::iterator iter = sock_fd_set.find(i + <span class="number">1</span>);</div><div class="line">                                                        <span class="keyword">if</span>(iter != sock_fd_set.end()) &#123;</div><div class="line">                                                                sock_fd_set.erase(iter);</div><div class="line">                                                                <span class="built_in">cout</span>&lt;&lt;<span class="string">"max sock is "</span>&lt;&lt;*(--sock_fd_set.end())&lt;&lt;<span class="built_in">endl</span>;;</div><div class="line">                                                        &#125;</div><div class="line">                                                        <span class="keyword">else</span> &#123;</div><div class="line">                                                                <span class="built_in">cout</span>&lt;&lt;<span class="string">"set error"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">                                                        &#125;</div><div class="line"></div><div class="line">                                                        <span class="built_in">cout</span>&lt;&lt;<span class="string">"fd "</span>&lt;&lt;i&lt;&lt;<span class="string">" closed"</span>&lt;&lt;<span class="built_in">endl</span>;</div><div class="line">                                                        <span class="keyword">continue</span>;</div><div class="line">                                                &#125;</div><div class="line">                                                <span class="keyword">if</span>(nread == <span class="number">-1</span>) &#123;</div><div class="line">                                                        perror(<span class="string">"read"</span>);</div><div class="line">                                                        <span class="keyword">continue</span>;</div><div class="line">                                                &#125;</div><div class="line">                                                </div><div class="line">                                                <span class="comment">//读取成功后，把套接字加入到需要写的套接字集中，为写响应头做准备</span></div><div class="line">                                                FD_SET(i, &amp;write_set);</div><div class="line">                                        &#125;</div><div class="line"></div><div class="line">                                &#125;</div><div class="line"></div><div class="line"></div><div class="line">                        &#125;</div><div class="line"></div><div class="line"></div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        free_file_data(file_data);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="使用更高性能的epoll代替select"><a href="#使用更高性能的epoll代替select" class="headerlink" title="使用更高性能的epoll代替select"></a>使用更高性能的epoll代替select</h5><p>epoll是linux2.5.44内核之后的产物，具有更高的性能。使用方法跟select大同小异，这里就不阐述了。</p>
<h4 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h4><p>以上程序性能的高低都还是理论上的，还没有进行相应的实际测试。我们使用ab压力测试工具来对以上几个程序进行性能测试。<br><img src="/uploads/test.jpg" alt="test.jpg"><br>可见，epoll的性能是最高的，select略逊色于epoll，而多线程性能是最低的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      	

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2017/01/16/一个简易游戏辅助的实现/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/16/一个简易游戏辅助的实现/" itemprop="url">
                  一个简易游戏辅助的实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-16T16:41:42+08:00">
                2017-01-16
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>相信大家都有用过游戏辅助，比如说按键精灵，八门神器等。本文要实现一个简易的qq五子棋辅助，实现用程序自动与网友对弈。先上成果图：<br><img src="/uploads/gamehelper.jpg" alt="/uploads/gamehelper.jpg"><br>概括来说，实现过程分为3个部分：</p>
<ul>
<li>辅助程序从qq五子棋游戏中获取相关信息</li>
<li>辅助程序执行相关算法，算出结果</li>
<li>模拟人类操作（比如点击鼠标）把结果反馈给qq五子棋</li>
</ul>
<h3 id="获取信息"><a href="#获取信息" class="headerlink" title="获取信息"></a>获取信息</h3><p>从游戏中获取信息（比如当前所有棋子的位置）有很多方法，其中一种方法是直接读取程序内存里面的相关数据（qq五子棋里面肯定有段内存是存储棋子位置的，极可能是一个数组），比如qq五子棋中棋盘的部分数据如下：<br><img src="/uploads/memory.jpg" alt="/uploads/memory.jpg"><br>每一个数据占两个字节（short），第一个数据4代表当前总共下了4步棋，后面是棋盘数据，棋盘数据是按棋盘上的一竖列一竖列排列的，比如1代表在棋盘左上角下了第一个棋子，2代表接着在左上角下面下了一个棋子，以此类推。所以以上数据对应的棋盘如下：<br><img src="/uploads/board.jpg" alt="/uploads/board.jpg"><br>找到相关的数据容易，用ollydbg动态调试一下很快就出来了。如果数据的地址每次都不变，那么我们可以用以下方法来获取程序的内存数据（一些软件破解的注册机也是这么干的）：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">DWORD processId;</div><div class="line">HWND hWnd = FindWindow(<span class="literal">NULL</span>, <span class="string">"五子棋"</span>);			<span class="comment">//首先获取qq五子棋的窗口句柄</span></div><div class="line"><span class="keyword">if</span> (hWnd == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">GetWindowThreadProcessId(hWnd, &amp;processId);		</div><div class="line">HANDLE process = OpenProcess(PROCESS_ALL_ACCESS, FALSE, processId);		<span class="comment">//打开进程，获取进程句柄</span></div><div class="line">ReadProcessMemory(process, (LPCVOID)(<span class="number">0x1f51c16</span>), buff, size, &amp;readSize);	<span class="comment">//读取内存</span></div><div class="line">CloseHandle(process);</div></pre></td></tr></table></figure></p>
<p>但可怕的是，游戏里面的数据为了防外挂防辅助等，游戏里面的数据一般都是变址的，也就是每次运行都会不一样，qq五子棋就是这样。所以还要逆向去分析相关的变址算法。这样的话辅助（外挂）的编写成本就高了很多。我们先不用这种方法（读取内存）去获取信息，对于五子棋游戏，先用一种简单粗暴的方法，读取游戏程序窗口上的相关像素，来获取棋子的位置（因为棋子颜色都是黑与白的，所以很容易分辨出整个棋盘的下棋情况）。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">HDC hDC = GetDC(hWnd);</div><div class="line">COLORREF color = GetPixel(hDC, x, y);</div></pre></td></tr></table></figure></p>
<p>其中x,y为你要获取的像素在qq五子棋窗口中的坐标。</p>
<h3 id="执行相关算法"><a href="#执行相关算法" class="headerlink" title="执行相关算法"></a>执行相关算法</h3><p>在获取了相关的信息之后，接下来的任务就是编写相关的算法来用电脑自动“玩游戏”，相关算法参考我之前的博文。<br><a href=""></a><br>当然，你也可以直接用一些开源的五子棋引擎，比如yixin。</p>
<h3 id="结果反馈"><a href="#结果反馈" class="headerlink" title="结果反馈"></a>结果反馈</h3><p>在用相关算法算出下一步的操作（下一步应该下哪里）之后，辅助应该模拟人类操作来进行“下棋”，这里是简单的鼠标点击操作，也就是向qq五子棋游戏窗口发送鼠标左键按下的消息：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SendMessage(hWnd, WM_LBUTTONDOWN, VK_LBUTTON, MAKELPARAM(x, y));</div></pre></td></tr></table></figure></p>
<p>但是，如果这样操作的话，并不能成功模拟人类在qq五子棋上下棋，qq五子棋可能为了防止诸如按键精灵等此类辅助程序加了一些限制，分析后发现要成功“下棋”，还要发送一个在该点上的鼠标移动消息：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SendMessage(hWnd, WM_MOUSEMOVE, VK_LBUTTON, MAKELPARAM(x, y));</div><div class="line">SendMessage(hWnd, WM_LBUTTONDOWN, VK_LBUTTON, MAKELPARAM(x, y));</div></pre></td></tr></table></figure></p>
<p>自此，一个简单的qq五子棋辅助就完成了。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>这是一个非常简单的游戏辅助，直接获取窗口像素来获取棋盘信息这种方式会受很多因素的影响，比如说，游戏中对方突然发了一句“快点吧，我等到花儿都谢了”，棋盘左下侧会出现一个蓝色的气泡，这样的话，棋盘那部分像素就变成了蓝色，相应的这会影响我们的辅助运行，当然，这是可以通过修改代码来修复的。<br>一些比较高级的外挂，一方面他们会通过读取游戏内存来获取相关的游戏数据，另一方面他们会通过分析相关的网络协议，进行抓包改包直接在网络通讯层面来模拟人类操作。每一个比较火的游戏背后一般都会有这样一个庞大的黑色产业链，站在明处的游戏厂商会不断采取相关措施来防外挂，包括一些惩罚机制（封号等），道高一尺魔高一丈，站在暗处的黑客们也会继续优化他们的外挂程序，继续产出和买卖各种各样的外挂和辅助程序。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      	

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2017/01/07/如何用程序画一个雪花/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/07/如何用程序画一个雪花/" itemprop="url">
                  如何用程序画雪花
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-07T01:23:57+08:00">
                2017-01-07
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>在知乎看到一篇很有趣的帖子<br><a href="https://zhuanlan.zhihu.com/p/24688522" target="_blank" rel="external">用 C 语言画科赫雪花</a><br>作者利用递归的思想和相关的算法用以下字符画出了科赫雪花：</p>
<ul>
<li>下划线(_)</li>
<li>减号(-)</li>
<li>斜杠(/)</li>
<li>反斜杠(\)<br>效果如下：<br><img src="/uploads/snowflake.png" alt="snowflake.png"><br>这种实现方法的好处是逻辑简单，易于实现。缺点是画出来的科赫雪花不够细致，因为毕竟是用ascii字符画出来的。<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3>基本思想上面的帖子已经阐述过了，这里引用以上帖子的两张图，如侵删。<br><img src="/uploads/snowflake1.png" alt="snowflake1.png"><br>简单来说就是给定一条直线，分成三等分，选出中间的线段作等边三角形。如上图所视。不断地重复这个过程，即可画出科赫曲线。把三条科赫曲线组合在一起，便成了雪花形状，如下图所示：<br><img src="/uploads/snowflake2.png" alt="snowflake2.png"><br>用字符画科赫雪花的方法刚才提到的帖子里面已经说了，下面讲画出精准的科赫雪花的方法。如下图所示：<br><img src="/uploads/snowflake3.jpg" alt="snowflake3.jpg"><br>EF为原始线段，将其分成三等分，为EA、AB、BF,以AB为边作等边三角形ABC。开始的时候点E和点F已知，所以点A和点B的坐标很容易就可以求到。若E点和F点的坐标为：<br>E(x1, y1), F(x2, y2)<br>则<br>A(x1 * 2.0 / 3.0 + x2 * 1.0 / 3.0, y1 * 2.0 / 3.0 + y2 * 1.0 / 3.0)<br>B(x1 * 1.0 / 3.0 + x2 * 2.0 / 3.0, y1 * 1.0 / 3.0 + y2 * 2.0 / 3.0)<br>关键是点C的坐标比较难求。因为CA与BA的夹角为60° ，所以向量&lt;A,C&gt;可以看做是向量&lt;A,B&gt;逆时针旋转60° 的结果。我们复习一下旋转公式：<br>x = x0 * cosθ - y0 * sinθ<br>y = y0 * cosθ + x0 * sinθ<br>其中x0，y0是原始向量的横坐标和纵坐标，θ是逆时针旋转角，x、y是求出来的旋转后的向量的横坐标和纵坐标。<br>因为向量&lt;A,B&gt;很容易求出，而&lt;A,C&gt;是&lt;A,B&gt;逆时针旋转60°的结果，所以可以根据上面的旋转公式求出&lt;A,C&gt;，接着我们可以求出C点的坐标为：<br>C = A + &lt;A,C&gt;<br>至此，未知的A，B，C点都求出来了。接着，我们会把线段EA、AC、CB、BF作为原始线段，重复上面的过程，直到求出来的点足够多，足以拼成一个漂亮的雪花为止。<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h5 id="大体思路"><a href="#大体思路" class="headerlink" title="大体思路"></a>大体思路</h5>由于很多图形绘制引擎（比如OpenGL）绘制图像时候会先绘制一个个最基本的三角形，然后经过大量的三角形来组合成我们的图像。我们的工作是求出所有绘制雪花所需要的三角形上的点。例如，我们会首先绘制一个最基本的等边三角形。如图所示：<br><img src="/uploads/snowflake4.jpg" alt="snowflake4.jpg"><br>接着以等边三角形的边为基本边，按上诉步骤接着画三角形，如下图：<br><img src="/uploads/snowflake5.jpg" alt="snowflake5.jpg"><br><img src="/uploads/snowflake6.jpg" alt="snowflake6.jpg"><br><img src="/uploads/snowflake7.jpg" alt="snowflake7.jpg"><br>直到画出来的三角形足够多，图案看起来像雪花为止。</li>
</ul>
<p>下面是代码实现：</p>
<h5 id="Point结构体"><a href="#Point结构体" class="headerlink" title="Point结构体"></a>Point结构体</h5><p>无论是点还是向量都是由两个变量(x,y)组成的，我们定义一个简单的Point工具类：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> Point &#123;</div><div class="line">    <span class="keyword">double</span> x;</div><div class="line">    <span class="keyword">double</span> y;</div><div class="line">    Point() &#123;&#125;;</div><div class="line">    Point(<span class="keyword">double</span> x, <span class="keyword">double</span> y) &#123;</div><div class="line">        <span class="keyword">this</span>-&gt;x = x;</div><div class="line">        <span class="keyword">this</span>-&gt;y = y;</div><div class="line">    &#125;</div><div class="line">    <span class="function">Point <span class="title">rotate</span><span class="params">(<span class="keyword">double</span> angle)</span> </span>&#123;</div><div class="line">        Point result;</div><div class="line">        result.x = x * <span class="built_in">cos</span>(angle) - y * <span class="built_in">sin</span>(angle);</div><div class="line">        result.y = y * <span class="built_in">cos</span>(angle) + x * <span class="built_in">sin</span>(angle);</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    Point <span class="keyword">operator</span> +(Point p) &#123;</div><div class="line">        Point result;</div><div class="line">        result.x = p.x + x;</div><div class="line">        result.y = p.y + y;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    Point <span class="keyword">operator</span> -(Point p) &#123;</div><div class="line">        Point result;</div><div class="line">        result.x = x - p.x;</div><div class="line">        result.y = y - p.y;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>注意rotate是旋转函数，angle为指定的旋转角度，返回结果为旋转后的Point。</p>
<h5 id="层次结构"><a href="#层次结构" class="headerlink" title="层次结构"></a>层次结构</h5><p>我们定义一个类为KochCurve类，精简后的代码(省略了拷贝函数，析构函数等细节处理）如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> KochCurve &#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    KochCurve(Point p1, Point p2);</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">calc</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">Point* <span class="title">getPoints</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> pointToDraw;</div><div class="line">    &#125;</div><div class="line">    <span class="function">KochCurve** <span class="title">getKochCurves</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> kcs;</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    Point point[<span class="number">2</span>];</div><div class="line">    Point pointToDraw[<span class="number">3</span>];</div><div class="line">    KochCurve *kcs[<span class="number">4</span>];</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//初始化</span></div><div class="line">KochCurve::KochCurve(Point p1, Point p2) &#123;</div><div class="line">    point[<span class="number">0</span>] = p1;</div><div class="line">    point[<span class="number">1</span>] = p2;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</div><div class="line">        kcs[i] = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"><span class="comment">//计算函数，计算用于画三角形的A、B、C点，以及EA，AC，CB，BF这四条边，它们将会作为下一个计算回合的基本边</span></div><div class="line"><span class="keyword">void</span> KochCurve::calc() &#123;</div><div class="line">    pointToDraw[<span class="number">0</span>].x = <span class="number">2.0</span> / <span class="number">3</span> * point[<span class="number">0</span>].x + <span class="number">1.0</span> / <span class="number">3</span> * point[<span class="number">1</span>].x;</div><div class="line">    pointToDraw[<span class="number">0</span>].y = <span class="number">2.0</span> / <span class="number">3</span> * point[<span class="number">0</span>].y + <span class="number">1.0</span> / <span class="number">3</span> * point[<span class="number">1</span>].y;</div><div class="line">    </div><div class="line">    pointToDraw[<span class="number">1</span>].x = <span class="number">1.0</span> / <span class="number">3</span> * point[<span class="number">0</span>].x + <span class="number">2.0</span> / <span class="number">3</span> * point[<span class="number">1</span>].x;</div><div class="line">    pointToDraw[<span class="number">1</span>].y = <span class="number">1.0</span> / <span class="number">3</span> * point[<span class="number">0</span>].y + <span class="number">2.0</span> / <span class="number">3</span> * point[<span class="number">1</span>].y;</div><div class="line">    </div><div class="line">    </div><div class="line">    pointToDraw[<span class="number">2</span>] = pointToDraw[<span class="number">0</span>] + (pointToDraw[<span class="number">1</span>] - pointToDraw[<span class="number">0</span>]).rotate(PI / <span class="number">3</span>);</div><div class="line">    </div><div class="line">    kcs[<span class="number">0</span>] = <span class="keyword">new</span> KochCurve(point[<span class="number">0</span>], pointToDraw[<span class="number">0</span>]);</div><div class="line">    kcs[<span class="number">1</span>] = <span class="keyword">new</span> KochCurve(pointToDraw[<span class="number">0</span>], pointToDraw[<span class="number">2</span>]);</div><div class="line">    kcs[<span class="number">2</span>] = <span class="keyword">new</span> KochCurve(pointToDraw[<span class="number">2</span>], pointToDraw[<span class="number">1</span>]);</div><div class="line">    kcs[<span class="number">3</span>] = <span class="keyword">new</span> KochCurve(pointToDraw[<span class="number">1</span>], point[<span class="number">1</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>该类主要是以下结构：<br><img src="/uploads/snowflake3.jpg" alt="snowflake3.jpg"><br>类成员与上图的对应关系为：</p>
<ul>
<li>数组point[2]为基本线两个端点E和F，其中point[0]为E，point[1]为F</li>
<li>数组pointToDraw[3]主要指用来绘制三角形的点，它们是A，B，C。其中，pointToDraw[0]表示A点，pointToDraw[1]表示B点，pointToDraw[2]表示C点。</li>
<li>kcs的意思是（KochCurves），数组kcs的长度为4个，表示四条线段EA、AC、CB、BF，它们将会作为下一个计算回合的基本边。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">##### 雪花类</div><div class="line">直接上代码，结合代码看下面的注解：</div><div class="line">``` c++</div><div class="line">class SnowFlake &#123;</div><div class="line">public:</div><div class="line">    SnowFlake(Point p1, Point p2, Point p3, int depth);</div><div class="line">    void calc();</div><div class="line">    int getLen() &#123;</div><div class="line">        return len;</div><div class="line">    &#125;</div><div class="line">    Point* getPoints() &#123;</div><div class="line">        return points;</div><div class="line">    &#125;</div><div class="line">private:</div><div class="line">    int depth;</div><div class="line">    int len;</div><div class="line">    KochCurve kc[3];</div><div class="line">    </div><div class="line">    int index;</div><div class="line">    Point *points;</div><div class="line">    </div><div class="line">    </div><div class="line">    void createPoints(KochCurve *kc, int d);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">SnowFlake::SnowFlake(Point p1, Point p2, Point p3, int depth) &#123;</div><div class="line">    kc[0] = KochCurve(p1, p2);</div><div class="line">    kc[1] = KochCurve(p2, p3);</div><div class="line">    kc[2] = KochCurve(p3, p1);</div><div class="line">    </div><div class="line">    this-&gt;depth = depth;</div><div class="line">    index = 0;</div><div class="line">    </div><div class="line">    </div><div class="line">    len = 3 + 3 * (pow(4, depth) - 1);</div><div class="line">    points = new Point[len];</div><div class="line">    </div><div class="line">    </div><div class="line">    points[index++] = p1;</div><div class="line">    points[index++] = p2;</div><div class="line">    points[index++] = p3;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void SnowFlake::calc() &#123;</div><div class="line">    int i;</div><div class="line">    for(i = 0; i &lt; 3; i++) &#123;</div><div class="line">        createPoints(&amp;kc[i], depth);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    cout&lt;&lt;&quot;index:&quot;&lt;&lt;index&lt;&lt;endl;</div><div class="line">    cout&lt;&lt;&quot;len:&quot;&lt;&lt;len&lt;&lt;endl;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">void SnowFlake::createPoints(KochCurve *kc, int d) &#123;</div><div class="line">    if(d == 0)</div><div class="line">        return;</div><div class="line">    kc-&gt;calc();</div><div class="line">    Point *ps = kc-&gt;getPoints();</div><div class="line">    int j;</div><div class="line">    for(j = 0; j &lt; 3; j++) &#123;</div><div class="line">        points[index++] = ps[j];</div><div class="line">    &#125;</div><div class="line">    KochCurve **kcs = kc-&gt;getKochCurves();</div><div class="line">    int i;</div><div class="line">    for(i = 0; i &lt; 4; i++) &#123;</div><div class="line">        createPoints(kcs[i], d - 1);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>雪花类的构造函数接受4个参数，前三个为基本三角形的三个点，一般我们会传入一个等边三角形的三个点，最后一个参数是depth（深度），这个参数指定程序会将上诉的流程（“原理”一节中的流程，也就是把一条基本线平均分成3份，在中间份的基础上做等边三角形）递归地执行多少次。那么，当深度为depth时候，我们需要一个多大的空间来存储点呢？我们计算一下当深度为depth的时候会生成多少个点。<br>首先开始的时候我们需要花一个等边三角形，生成了3个点。接着以等边三角形的每一条边为基本线，开始以当前计算回合的A点B点C点为顶点画三角形。所以总的点数为：<br>point num = 3 + 3 * (3 + 3 * 4 + 3 * 4 * 4 + … + 3 * 4 ^ (depth - 1)) = 3 + 3 * (4 ^ depth - 1)<br>雪花类的成员变量以及成员函数注解如下：</p>
<ul>
<li>depth为计算深度，递归次数</li>
<li>len为点数，即上面计算出来的point num</li>
<li>数组kc[3]为三条科赫曲线。</li>
<li>index为points数组的当前写索引</li>
<li>计算出来的所有点会被存于points数组中</li>
</ul>
<h6 id="调用示例"><a href="#调用示例" class="headerlink" title="调用示例"></a>调用示例</h6><p>如果你看了上面还没明白，看看下面的调用示例：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">//生成雪花对象，指定基础等边三角形的顶点和计算深度</div><div class="line">SnowFlake sf(Point(-0.5, 0.5), Point(0.5, 0.5), Point(0.0, -0.36602), 5);</div><div class="line">//计算所有的点</div><div class="line">   sf.calc();</div><div class="line">   //获取计算出来的所有的点</div><div class="line">   Point *points = sf.getPoints();</div><div class="line">   //获取长度</div><div class="line">   int i, len = sf.getLen();</div><div class="line">   //2d坐标转换成OpenGL的3D坐标（指定z坐标为0）</div><div class="line">   for(i = 0; i &lt; len; i++) &#123;</div><div class="line">       vertices.push_back((GLfloat)points[i].x);</div><div class="line">       vertices.push_back((GLfloat)points[i].y);</div><div class="line">       vertices.push_back(0.0f);</div><div class="line">   &#125;</div><div class="line">   //画三角形</div><div class="line">   ...</div></pre></td></tr></table></figure></p>
<p>最后的实现效果：<br><img src="/uploads/snowflake7.jpg" alt="snowflake7.jpg"></p>
<h3 id="后续优化"><a href="#后续优化" class="headerlink" title="后续优化"></a>后续优化</h3><p>如果指定初始等边三角形的点，则雪花的全部坐标就已经定下来了，所以我们没必要在运行时对其进行运算，我们可以在程序开始运行之前把相应的点给计算出来。一种解决方案是编写一个小程序把雪花坐标给全部计算出来，然后把它们存储在一个文件中，这样画雪花的程序在开始画雪花之前只需要把坐标数据读入就好了。另一种解决方案是利用c++的模板元递归技术。在编译时候就把雪花所有坐标给计算好，在运行的时候直接取值就好了。</p>
<p>作者水平有限，难免有错误的地方，欢迎指正。<br>代码经调整后稍后奉上。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      	

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/12/14/如何设计一个还可以的五子棋AI/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/14/如何设计一个还可以的五子棋AI/" itemprop="url">
                  如何设计一个还可以的五子棋AI
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-14T01:08:44+08:00">
                2016-12-14
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="图形界面"><a href="#图形界面" class="headerlink" title="图形界面"></a>图形界面</h3><p>由于图形界面不是本次讨论的重点，所以只用python实现了一个简单的图形界面，然后用C++来实现算法部分的内容，编译成动态链接库，在python界面程序中调用动态链接库中的相关函数就可以了。选择python是因为考虑到它的夸平台性，在各大操作系统都可以直接解释执行。对于动态链接库，Linux是so，而Windows是dll，代码写法略有不同，但也差别不大。<br>比如说在*nix系统中直接编译我们写好的代码成so库就好了，而在Windows中函数则要额外加上<strong>declspec(dllexport)或</strong>declspec(dllimport)声明，例如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> BUILD_DLL</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">define</span> DLL_EXPORT __declspec(dllexport)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">	<span class="meta">#<span class="meta-keyword">define</span> DLL_EXPORT __declspec(dllimport)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</div><div class="line">	<span class="function">DLL_EXPORT <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> a + b;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意，如果是用C++，需要用extern “C” {}把导出函数括起来，否则C++中的函数名字修饰（Decorated Name）会导致在加载动态链接库中相应函数的时候找不到函数名</p>
<p>另外附上*uix平台和Windows平台编译生成动态链接库的命令：<br>Linux<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">g++ -shared <span class="_">-f</span>PIC -o libfivechess.so fivechess.cpp</div></pre></td></tr></table></figure></p>
<p>Windows<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">g++ -c -DBUILD fivechess.cpp</div><div class="line">g++ -shared -o fivechess.dll fivechess.o -Wl,--out-implib,libfivechess.a</div></pre></td></tr></table></figure></p>
<p>当应用需要发布的时候可以用pyinstaller等工具来把python脚本打包成exe等可执行文件。<br><img src="/uploads/wuziqi3.jpg" alt="wuziqi3.jpg"><br><img src="/uploads/wuziqi4.jpg" alt="wuziqi4.jpg"></p>
<h3 id="最初的思路"><a href="#最初的思路" class="headerlink" title="最初的思路"></a>最初的思路</h3><p>下面进入本次讨论的重点，算法部分。<br>最初的思路是根据人的经验制定一个评分表，根据评分表对棋盘中每一个位置进行评分，选取评分最高的位置作为下一步走的棋。什么是评分表呢？看下图：<br><img src="/uploads/score.jpg" alt="score.jpg"><br>这是摘自董红安2005年论文“计算机五子棋博弈系统的研究与实现”中的评分表，图中共有16中不同的特征，在每一种特征中，O代表棋子，+代表空位，每一种特征的右侧有其对应的评分。在一个好的评分表中，威胁大的特征具有绝对优势的评分，再多威胁小的评分加起来也不可能超过威胁大的评分表。<br>有了评分表，那怎么利用评分表对相应位置进行评分呢？评分规则如下：<br>对该位置所在的行和列和正斜列以及反斜列上相关范围进行扫描，如图<br><img src="/uploads/score1.jpg" alt="score1.jpg"><br>可以看出，图中四个矩形的模式分别是(假如要在粉色多边形的位置上放置绿方棋子）：</p>
<ul>
<li>横：+++OO++++</li>
<li>竖：+++OOO+++</li>
<li>\：++++O++++</li>
<li>/：++AOO++++<br>其中的A表示该位置有敌方棋子，我们对这四组数据进行模式匹配，得出该位置的分数为：<br>120 + 720 + 20 + 0 = 860<br>应用此算法对棋盘中的所有位置进行评分，然后选取分数最高的位置进行下棋</li>
</ul>
<h3 id="加入博弈树-利用极大极小搜索提升棋力"><a href="#加入博弈树-利用极大极小搜索提升棋力" class="headerlink" title="加入博弈树-利用极大极小搜索提升棋力"></a>加入博弈树-利用极大极小搜索提升棋力</h3><p>上诉的方法虽然简单容易实现，却可以取得不错的效果，有时候一不小还真的被他打输了。但是，上诉方法的确有非常大的缺陷，电脑只能预测一步，相当于一个仅仅拘束于眼前利益的傻子，稍微熟悉五子棋的人套路一下电脑，就可以轻易打赢电脑了。<br>解决方法是我们可以设计程序让电脑可以思考几步，极大极小搜索树可以帮忙我们实现这种功能。在此我们需要修改一下评分函数，这次不是对每一个位置进行评分，而是对整个棋局来进行评分（评分的时候对整个棋盘的每一行每一列每一斜列进行模式匹配，然后把所有的分数加起来即可），整个棋局作为一个独立单位。<br><img src="/uploads/score2.jpg" alt="score2.jpg"><br>如图，我们先计算叶子节点的分数（注：这里指的分数是对于己方来说的，分数越高，对己方越有利）。接着，如果子节点是己（敌）方下的棋，则子节点的父节点的值被赋值为子节点中的最大（小）值。最后，在第一层中，找出得分最高的节点，作为下一步下棋的位置。（注：生成下一步可能下棋的点的时候只需要考虑现有棋子旁边的点，也就是与现有棋子相差一格且没有棋子的点即可）</p>
<p>在使用了极大极小搜索之后，棋力得到了一定的提升。但是因为极大极小搜索需要巨大的运算量（时间复杂度为指数级别），所以只能做很少几层的搜索（3层），这对于计算机来说是患了很深的近视眼（观察距离只能是3层），下面我们通过AlphaBeta优化来优化极大极小搜索。</p>
<h3 id="质的提升-AlphaBeta剪枝"><a href="#质的提升-AlphaBeta剪枝" class="headerlink" title="质的提升-AlphaBeta剪枝"></a>质的提升-AlphaBeta剪枝</h3><p>AlphaBeta剪枝是对极大极小搜索的优化，描述算法需要大量的篇幅，这里就不讨论了，直接给出一篇写的还不错的文章<a href="http://www.xqbase.com/computer/search_alphabeta.htm" target="_blank" rel="external">http://www.xqbase.com/computer/search_alphabeta.htm</a>，另外附上伪代码：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">AlphaBeta</span><span class="params">(<span class="keyword">int</span> depth, <span class="keyword">int</span> alpha, <span class="keyword">int</span> beta)</span> </span>&#123;</div><div class="line">　<span class="keyword">if</span>(depth == <span class="number">0</span>) &#123;</div><div class="line">　　<span class="keyword">return</span> Evaluate();</div><div class="line">　&#125;</div><div class="line">　GenerateLegalMoves();</div><div class="line">　<span class="keyword">while</span>(MovesLeft()) &#123;</div><div class="line">　　MakeNextMove();</div><div class="line">　　val = -AlphaBeta(depth - <span class="number">1</span>, -beta, -alpha);</div><div class="line">　　UnmakeMove();</div><div class="line">　　<span class="keyword">if</span>(val &gt;= beta) &#123;</div><div class="line">　　　<span class="keyword">return</span> beta;</div><div class="line">　　&#125;</div><div class="line">　　<span class="keyword">if</span>(val &gt; alpha) &#123;</div><div class="line">　　　alpha = val;</div><div class="line">　　&#125;</div><div class="line">　&#125;</div><div class="line">　<span class="keyword">return</span> alpha;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="再一次质的提升-启发式搜索"><a href="#再一次质的提升-启发式搜索" class="headerlink" title="再一次质的提升-启发式搜索"></a>再一次质的提升-启发式搜索</h3><p>AlphaBeta剪枝有严重依赖于每一层节点扫描的顺序，因为前面节点生成的alpha直接决定了后面节点剪枝的多少。如果我们针对每一层生成的节点事先排好序，那么程序的速度将极大地提升。然而，对生成的节点进行绝对准确地排序是不可能的，因为需要巨大的运算量（等同于再进行一次alphabeta剪枝的搜索），所以我们只能对节点进行粗略地排好序。<br>在”最初的思想”中，我们已经讨论了如何对棋盘上的位置进行评分，我们可以利用这个评分，对生成的可能的点进行排序。排序开销小，然而对整体的搜索速度带来巨大的提升。加入此优化之后，五子棋可以轻松做到5层搜索。</p>
<h3 id="看起来不起眼的一个小优化"><a href="#看起来不起眼的一个小优化" class="headerlink" title="看起来不起眼的一个小优化"></a>看起来不起眼的一个小优化</h3><p>在进行了AlphaBeta剪枝和启发式搜索之后，搜索依然只能进行到5层左右。6层还非常慢。<br>在启发式式搜索的优化中，已经对下一步可能出现的位置粗略地排好了序，极大地提高了AlphaBeta剪枝的效率。但是由于每层产生的点太多，导致计算机仍然需要搜索数量巨大的节点。<br>事实上，只要对位置进行评分的函数足够好，我们就可以保证最优解基本出现在排好序的节点的前十之中。所以我们只需要扫描产生的排好序的点的前十个点就ok了。这个不起眼的优化提升非常巨大，有了这个小优化之后，在一台好一点的电脑五子棋的搜索层数可以达到7层。棋力迅猛提升，在电脑先走的情况下基本打不赢电脑。<br>附上伪代码：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">AlphaBeta</span><span class="params">(<span class="keyword">int</span> depth, <span class="keyword">int</span> alpha, <span class="keyword">int</span> beta)</span> </span>&#123;</div><div class="line">　<span class="keyword">if</span>(depth == <span class="number">0</span>) &#123;</div><div class="line">　　<span class="keyword">return</span> Evaluate();</div><div class="line">　&#125;</div><div class="line">　GenerateLegalMoves();</div><div class="line"></div><div class="line">  <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"></div><div class="line">　<span class="keyword">while</span>(MovesLeft()) &#123;</div><div class="line">　　MakeNextMove();</div><div class="line">　　val = -AlphaBeta(depth - <span class="number">1</span>, -beta, -alpha);</div><div class="line">　　UnmakeMove();</div><div class="line">　　<span class="keyword">if</span>(val &gt;= beta) &#123;</div><div class="line">　　　<span class="keyword">return</span> beta;</div><div class="line">　　&#125;</div><div class="line">　　<span class="keyword">if</span>(val &gt; alpha) &#123;</div><div class="line">　　　alpha = val;</div><div class="line">　　&#125;</div><div class="line">	<span class="keyword">if</span>(count++ &gt;= <span class="number">10</span>)</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">　&#125;</div><div class="line">　<span class="keyword">return</span> alpha;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="增加置换表以及悔棋功能"><a href="#增加置换表以及悔棋功能" class="headerlink" title="增加置换表以及悔棋功能"></a>增加置换表以及悔棋功能</h3><p>到此，棋子力已经超过7层了。然而在搜索的过程中，还是会出现一些重复搜索的情况，例如：<br><img src="/uploads/score3.jpg" alt="score3.jpg"><br>这时候，就要用到zobrist和置换表了，相关链接如下：<br><a href="http://www.xqbase.com/computer/struct_zobrist.htm" target="_blank" rel="external">http://www.xqbase.com/computer/struct_zobrist.htm</a><br><a href="http://www.xqbase.com/computer/search_hashing.htm" target="_blank" rel="external">http://www.xqbase.com/computer/search_hashing.htm</a><br>对于置换表，保存搜索过的棋局的哈希数组越大，速度就越快。但是这次的提升并没有前几次优化的提升那么明显，以为索引的计算以及记录也需要时间，况且总结点还那么大，加入了置换表之后搜索还是只能停留在7层。不过，总体来看，使用置换表对程序的性能来说还是有一定的提升的。使用置换表还有一个很有用的功能，那就是如果用户悔棋，然后再下的话，运算速度可以快不少，因为有的节点已经搜索过计算好保存在置换表中啦。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>好了，到此我们就完成了一个简易版但棋力还可以的五子棋AI。<br>下面是其对弈github中小有名气的五子棋项目<a href="https://github.com/lihongxun945/gobang" target="_blank" rel="external">gobang</a>的对弈结果，本讨论做的具有7层搜索能力的五子棋AI可以轻松打赢gobang（其实也可以打赢网上大部分的五子棋软件）。<br><img src="/uploads/wuziqi1.jpg" alt="wuziqi1.jpg"><br><img src="/uploads/wuziqi2.jpg" alt="wuziqi2.jpg"><br>在人机对弈上，此五子棋已经达到了普通人偏上的棋力水平，发给很多朋友测试后称很难打赢，在“电脑先走”的这种情况下更是几乎没有赢过。但是，由于这只是一个简易版的五子棋AI，不懂得如何算杀，更不懂得如何把控局面进行优势的积累，与弈心、黑石等著名五子棋引擎还是有一定的差距的。源代码经调整后随后呈上。<br>最后附上下载链接（Windows EXE可执行文件）：<br><a href="https://kimlongli.github.io/files/fivechess.zip">https://kimlongli.github.io/files/fivechess.zip</a><br>（注: 在一些老式电脑上可能运行比较慢）</p>
<h3 id="一些优化（2017-1-20更新）"><a href="#一些优化（2017-1-20更新）" class="headerlink" title="一些优化（2017/1/20更新）"></a>一些优化（2017/1/20更新）</h3><ul>
<li>前面提到的对整个局面进行评分。一种解决方案是在alpha-beta的每一次迭代中，都对整个棋盘进行一次扫描，来得出一个局面的评分。这样虽然可行，但是效率低下。因为在alpha-beta剪枝函数的每一次迭代当中，棋盘中的棋子只会增加（减少）一个，棋盘中的大部分区域的评分是不变的，所以不用每次迭代都对整个棋盘来进行一次完整的扫描。可以保存好前一次迭代里棋盘的评分（可以把每一行，每一列每一斜列的评分都保存起来），然后在当前迭代中扫描当前下的棋子所在的行、列、斜列，结合前一次迭代的棋盘评分，得出新的评分。这样就免去了每次都要重新扫描整个棋盘。效率可以有不小的提升。</li>
<li>计算下一步所有可能的点的时候，也可以采用同样的思想。<br>  下一步可能出现的点（新） = 下一步可能出现的点（旧） - 当前下棋的点 + 当前下棋的点旁边的位置</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      	

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/26/入门：使用React-Native设计一个计算器/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/26/入门：使用React-Native设计一个计算器/" itemprop="url">
                  入门：使用React Native设计一个计算器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-26T20:23:09+08:00">
                2016-11-26
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>期末快要来了，各种大作业蜂拥而至，其中就包括于士琪的Java Web的大作业。为了摆脱历史性遗留的各种管理系统(…)，我决定做一个简单版的微信，考虑对原生Android开发并不是很熟悉（特别是界面），还有微信小程序的出现，还有越来越火看起来势不可挡的React Native以及其跨平台性，还考虑到React Native的简单易用(好吧，被看穿了)，我决定用React Native和JSP(这个是必须的了)来做这次的Java Web大作业。在此之前，先做一个简单的计算器来练练手。</p>
<h3 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h3><h5 id="界面设计"><a href="#界面设计" class="headerlink" title="界面设计"></a>界面设计</h5><p>先看看实现后的效果<br><img src="/uploads/calculator.jpg" alt="calculator.jpg"><br>界面设计思路如下：</p>
<ul>
<li>整个程序界面为一个大的container(style.container)</li>
<li>大界面分为两个部分，一个是显示区域(style.displayContainer)（顶部显示输入的数字的区域），一个是输入区域(style.inputContainer)（下面的按钮区域）</li>
<li>显示区域只包含一个Text组件</li>
<li>输入区域包含许多行(style.inputBoxRow)</li>
<li>每一行包含若干个按钮(style.inputBox)</li>
</ul>
<p>inputButton（界面中的按钮）类代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InputButton</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span>( </div><div class="line">      &lt;TouchableHighlight style=&#123;style.inputBox&#125; onPress=&#123;this.props.onPress&#125;&gt;</div><div class="line">        &lt;Text style=&#123;style.inputBoxText&#125;&gt;&#123;this.props.value&#125;&lt;/Text&gt;</div><div class="line">      &lt;/TouchableHighlight&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>主类（Calculator）程序中的render代码以及绘制按钮的函数代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Calculator</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">	...</div><div class="line">	_renderInputBoxes() &#123;</div><div class="line">	    <span class="keyword">var</span> result = [];</div><div class="line">	    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</div><div class="line">	      	<span class="keyword">var</span> inputRow = [];</div><div class="line">	      	<span class="keyword">for</span>(<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</div><div class="line">	        	inputRow.push(&lt;InputButton key=&#123;"inputBox" + i + j&#125; value=&#123;inputButtons[i][j]&#125; onPress=&#123;this._onPressButton.bind(this, inputButtons[i][j])&#125; /&gt;);</div><div class="line">	      	&#125;</div><div class="line">	      	result.push(&lt;View style=&#123;style.inputBoxRow&#125; key=&#123;"inputBoxRow" + i&#125;&gt;&#123;inputRow&#125;&lt;/View&gt;);</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    return result;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	render() &#123;</div><div class="line">	    return(</div><div class="line">			&lt;View style=&#123;style.container&#125;&gt;</div><div class="line">				&lt;View style=&#123;style.displayContainer&#125;&gt;</div><div class="line">				  	&lt;Text style=&#123;style.displayText&#125;&gt;&#123;this.state.displayContent&#125;&lt;/Text&gt;</div><div class="line">				&lt;/View&gt;</div><div class="line">				&lt;View style=&#123;style.inputContainer&#125;&gt;</div><div class="line">				  	&#123;this._renderInputBoxes()&#125;</div><div class="line">				&lt;/View&gt;</div><div class="line">			&lt;/View&gt;</div><div class="line">	    );</div><div class="line">	  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>噢对了，还有样式定义的代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> style = StyleSheet.create(&#123;</div><div class="line">	<span class="attr">container</span>: &#123;</div><div class="line">		<span class="attr">flex</span>: <span class="number">1</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">displayContainer</span>: &#123;</div><div class="line">		<span class="attr">flex</span>: <span class="number">2</span>,</div><div class="line">		<span class="attr">backgroundColor</span>: <span class="string">'#183442'</span>,</div><div class="line">		<span class="attr">justifyContent</span>: <span class="string">'center'</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">displayText</span>: &#123;</div><div class="line">		<span class="attr">fontSize</span>: <span class="number">70</span>,</div><div class="line">		<span class="attr">flex</span>: <span class="number">1</span>,</div><div class="line">		<span class="attr">textAlign</span>: <span class="string">'right'</span>,</div><div class="line">		<span class="attr">color</span>: <span class="string">'white'</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">inputContainer</span>: &#123;</div><div class="line">		<span class="attr">flex</span>: <span class="number">8</span>,</div><div class="line">		<span class="attr">backgroundColor</span>: <span class="string">'#3d6070'</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">inputBoxRow</span>: &#123;</div><div class="line">		<span class="attr">flex</span>: <span class="number">1</span>,</div><div class="line">		<span class="attr">flexDirection</span>: <span class="string">'row'</span>,</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">inputBox</span>: &#123;</div><div class="line">		<span class="attr">flex</span>: <span class="number">1</span>,</div><div class="line">		<span class="attr">alignItems</span>: <span class="string">'center'</span>,</div><div class="line">		<span class="attr">justifyContent</span>: <span class="string">'center'</span>,</div><div class="line">		<span class="attr">borderWidth</span>: <span class="number">0.5</span>,</div><div class="line">		<span class="attr">borderColor</span>: <span class="string">'#91AA9D'</span></div><div class="line">	&#125;,</div><div class="line">	<span class="attr">inputBoxText</span>: &#123;</div><div class="line">		<span class="attr">fontSize</span>: <span class="number">70</span>,</div><div class="line">		<span class="attr">color</span>: <span class="string">'white'</span>,</div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h5 id="逻辑设计"><a href="#逻辑设计" class="headerlink" title="逻辑设计"></a>逻辑设计</h5><p>接下来就是逻辑设计了，首先看看主类的state<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">constructor</span>(props) &#123;</div><div class="line">    <span class="keyword">super</span>(props);</div><div class="line">    <span class="keyword">this</span>.state = &#123;</div><div class="line">		<span class="attr">displayContent</span>: <span class="string">""</span>,</div><div class="line">		<span class="attr">saveNumber</span>: <span class="number">0.0</span>,</div><div class="line">		<span class="attr">saveOperator</span>: <span class="string">'+'</span>,</div><div class="line">		<span class="attr">haveDot</span>: <span class="literal">false</span>,</div><div class="line">		<span class="attr">mode</span>: <span class="number">0</span>,</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>思路如下：<br>程序通过一个mode变量来记录程序的状态（一个自动机）。</p>
<ul>
<li>当mode为0，数字键按下时候，mode立即变为1，显示的内容被设置为刚才按下的键的内容；其它键按下无效。</li>
<li>当mode为1，数字键按下的时候，把按下的键的内容加到显示内容的末尾；当符号键（加减乘除）按下的时候，mode变成2，并把当前显示的内容保存到saveNumber变量中；</li>
<li>当mode为2，数字键按下时候，mode立即变为3，显示的内容被设置为刚才按下的键的内容；其它键按下无效。</li>
<li>当mode为3，数字键按下的时候，把按下的键的内容加到显示内容的末尾；当等号键按下的时候，计算结果并显示到屏幕，mode变为0；</li>
<li>循环</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">_setOperator(ch) &#123;</div><div class="line">    <span class="keyword">if</span>(ch == <span class="string">'+'</span> || ch == <span class="string">'-'</span> || ch == <span class="string">'*'</span> || ch == <span class="string">'/'</span>) &#123;</div><div class="line">      <span class="keyword">let</span> number = <span class="built_in">parseFloat</span>(<span class="keyword">this</span>.state.displayContent);</div><div class="line">      <span class="keyword">this</span>.setState(&#123;<span class="attr">saveOperator</span>: ch, <span class="attr">mode</span>: <span class="number">2</span>, <span class="attr">saveNumber</span>: number&#125;);</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"> &#125;</div><div class="line"> _onPressButton(ch) &#123;</div><div class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>._setOperator(ch)) &#123;</div><div class="line">      <span class="keyword">if</span>(ch == <span class="string">'='</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state.mode == <span class="number">0</span> || <span class="keyword">this</span>.state.mode == <span class="number">2</span>)</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">let</span> result = <span class="built_in">eval</span>(<span class="keyword">this</span>.state.saveNumber + <span class="keyword">this</span>.state.saveOperator + <span class="keyword">this</span>.state.displayContent);</div><div class="line">        <span class="keyword">if</span>(result % <span class="number">1</span> === <span class="number">0</span>)</div><div class="line">          <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: result, <span class="attr">mode</span>: <span class="number">0</span>&#125;);</div><div class="line">        <span class="keyword">else</span></div><div class="line">          <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: result.toFixed(<span class="number">3</span>), <span class="attr">mode</span>: <span class="number">0</span>&#125;);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.mode == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: ch.toString(), <span class="attr">mode</span>: <span class="number">1</span>, <span class="attr">haveDot</span>: <span class="literal">false</span>&#125;);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.mode == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state.haveDot &amp;&amp; ch == <span class="string">'.'</span>)</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: <span class="keyword">this</span>.state.displayContent + ch.toString()&#125;);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.mode == <span class="number">2</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: ch.toString(), <span class="attr">mode</span>: <span class="number">3</span>, <span class="attr">haveDot</span>: <span class="literal">false</span>&#125;);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.mode == <span class="number">3</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state.haveDot &amp;&amp; ch == <span class="string">'.'</span>)</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">displayContent</span>: <span class="keyword">this</span>.state.displayContent + ch.toString()&#125;);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span>(ch == <span class="string">'.'</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">haveDot</span>: <span class="literal">true</span>&#125;);</div><div class="line"></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="打包发布应用"><a href="#打包发布应用" class="headerlink" title="打包发布应用"></a>打包发布应用</h3><p>停留在Debug版本的React Native应用运行时候是需要连接开发服务器的（默认是本机的8081端口），这样的话，就不能把debug版本的apk发送到其它系统上去运行了。解决办法是生成签名（因为没有root权限的安卓系统不允许没有签名的应用安装），把应用打包成release版本的apk，然后就可以发送到其它系统去测试了。步骤如下：</p>
<ul>
<li><p>生成密钥<br>进入android/app/，运行如下命令生成签名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">keytool -genkey -v -keystore my-test-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000</div></pre></td></tr></table></figure>
</li>
<li><p>创建assets文件夹<br>在android/app/src/main下创建assets文件夹</p>
</li>
<li><p>获取bundle文件并保存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -k <span class="string">"http://localhost:8081/index.android.bundle"</span> &gt; android/app/src/main/assets/index.android.bundle</div></pre></td></tr></table></figure>
</li>
<li><p>添加gradle的keystore配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">//在 defaultConfig 后面添加</div><div class="line">signingConfigs &#123;</div><div class="line">    release &#123;</div><div class="line">        storeFile file(&quot;/my-test-key.keystore&quot;) //替换成你实际密匙文件所在位置</div><div class="line">        storePassword  &quot;生成密钥步骤中的密码&quot;　　</div><div class="line">        keyAlias  &quot;my-key-alias&quot;　　　　</div><div class="line">        keyPassword  &quot;生成密钥步骤中的密码&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">//修改原来的配置，主要是加入 signingConfig 这一行</div><div class="line">buildTypes &#123;</div><div class="line">    release &#123;</div><div class="line">        minifyEnabled enableProguardInReleaseBuilds</div><div class="line">        proguardFiles fetDefaultProguardFile(&apos;proguard-android.txt), &apos;proguard-rules.pro&apos; </div><div class="line">        signingConfig signingConfigs.release</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>执行打包脚本<br>进入android目录，执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./gradlew assembleRelease</div></pre></td></tr></table></figure>
</li>
<li><p>发布应用<br>拷贝android/app/build/outputs/apk下的apk文件（release版本）发送到你想要测试的系统上安装运行即可。</p>
</li>
</ul>
<p><img src="/uploads/calculator1.jpg" alt="calculator1.jpg"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      	

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/25/笔记：Java中的反射机制/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/25/笔记：Java中的反射机制/" itemprop="url">
                  笔记：Java中的反射机制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-25T17:30:25+08:00">
                2016-11-25
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><blockquote>
<p>JAVA反射机制是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意方法和属性；这种动态获取信息以及动态调用对象方法的功能称为java语言的反射机制。JAVA反射（放射）机制：“程序运行时，允许改变程序结构或变量类型，这种语言称为动态语言”。从这个观点看，Perl，Python，Ruby是动态语言，C++，Java，C#不是动态语言。但是JAVA有着一个非常突出的动态相关机制：Reflection，用在Java身上指的是我们可以于运行时加载、探知、使用编译期间完全未知的classes。换句话说，Java程序可以加载一个运行时才得知名称的class，获悉其完整构造（但不包括methods定义），并生成其对象实体、或对其fields设值、或唤起其methods。 —-摘自某百科</p>
</blockquote>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> MyTest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Field;</div><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"><span class="keyword">import</span> java.io.Serializable;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Human</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> age = <span class="number">0</span>;</div><div class="line">	<span class="keyword">private</span> String name = <span class="string">""</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> age;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String []args)</span> </span>&#123;</div><div class="line">		Human human = <span class="keyword">new</span> Human();</div><div class="line"></div><div class="line">		<span class="comment">//获取class对象，方式一</span></div><div class="line">		System.out.println(<span class="string">"###获取class对象，方式一###"</span>);</div><div class="line">		Class&lt;Human&gt; c1 = Human.class;</div><div class="line">		System.out.println(c1);</div><div class="line"></div><div class="line">		<span class="comment">//方式二</span></div><div class="line">		System.out.println(<span class="string">"###方式二###"</span>);</div><div class="line">		Class&lt;? extends Human&gt; c2 = human.getClass();</div><div class="line">		System.out.println(c2);</div><div class="line"></div><div class="line">		<span class="comment">//方式三</span></div><div class="line">		System.out.println(<span class="string">"###方式三###"</span>);</div><div class="line">		Class&lt;?&gt; c3 = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			c3 = Class.forName(<span class="string">"MyTest.Human"</span>);</div><div class="line">		&#125; <span class="keyword">catch</span>(ClassNotFoundException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		System.out.println(c3);</div><div class="line"></div><div class="line">		<span class="comment">//生成对象</span></div><div class="line">		System.out.println(<span class="string">"###生成对象###"</span>);</div><div class="line">		Human h3 = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			h3 = (Human)c3.newInstance();</div><div class="line">		&#125; <span class="keyword">catch</span>(InstantiationException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span>(IllegalAccessException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		h3.setName(<span class="string">"lijinlong"</span>);</div><div class="line">		System.out.println(h3.getName());</div><div class="line"></div><div class="line"></div><div class="line">		<span class="comment">//获取构造函数</span></div><div class="line">		System.out.println(<span class="string">"###获取构造函数###"</span>);</div><div class="line">		Constructor&lt;?&gt; con3 = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			con3 = c3.getConstructor(String.class, <span class="keyword">int</span>.class);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span>(NoSuchMethodException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; </div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			h3 = (Human)con3.newInstance(<span class="string">"zhouyi"</span>, <span class="number">19</span>);</div><div class="line">		&#125; <span class="keyword">catch</span>(InstantiationException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span>(IllegalAccessException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span>(InvocationTargetException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		System.out.println(h3.getName());</div><div class="line"></div><div class="line"></div><div class="line">		<span class="comment">//取得类的构造方法</span></div><div class="line">		System.out.println(<span class="string">"###获取类的构造方法###"</span>);</div><div class="line">		Constructor&lt;?&gt;[] cons = c3.getConstructors();</div><div class="line">		System.out.println(Arrays.toString(cons));</div><div class="line"></div><div class="line">		<span class="comment">//取得接口</span></div><div class="line">		System.out.println(<span class="string">"###取得接口###"</span>);</div><div class="line">		Class&lt;?&gt;[] interfaces = c3.getInterfaces();</div><div class="line">		System.out.println(Arrays.toString(interfaces));</div><div class="line"></div><div class="line">		<span class="comment">//取得父类(Java中不允许多继承，所以只有一个)</span></div><div class="line">		System.out.println(<span class="string">"###取得父类###"</span>);</div><div class="line">		Class&lt;?&gt; superClass = c3.getSuperclass();</div><div class="line">		System.out.println(superClass);</div><div class="line"></div><div class="line">		<span class="comment">//取得类的所有方法</span></div><div class="line">		System.out.println(<span class="string">"###取得类的所有方法###"</span>);</div><div class="line">		Method []methods = c3.getMethods();</div><div class="line">		System.out.println(Arrays.toString(methods));</div><div class="line"></div><div class="line">		<span class="comment">//调用获取的方法</span></div><div class="line">		System.out.println(<span class="string">"###调用获取的方法###"</span>);</div><div class="line">		Method method = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			method = c3.getMethod(<span class="string">"setName"</span>, String.class);</div><div class="line">		&#125; <span class="keyword">catch</span>(NoSuchMethodException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			method.invoke(h3, <span class="string">"seer"</span>);</div><div class="line">		&#125; <span class="keyword">catch</span>(IllegalAccessException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span>(InvocationTargetException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		System.out.println(h3.getName());</div><div class="line">		</div><div class="line"></div><div class="line"></div><div class="line">		<span class="comment">//获取类的属性，并改变属性值</span></div><div class="line">		System.out.println(<span class="string">"###获取类的属性，并改变属性值###"</span>);</div><div class="line">		h3.setName(<span class="string">"rongjie"</span>);</div><div class="line">		Field nameField = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//也可以用getField，但是getField不可以获取私有变量</span></div><div class="line">			nameField = c3.getDeclaredField(<span class="string">"name"</span>);</div><div class="line">		&#125; <span class="keyword">catch</span>(NoSuchFieldException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		nameField.setAccessible(<span class="keyword">true</span>);</div><div class="line">		String name = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			nameField.set(h3, <span class="string">"gear"</span>);</div><div class="line">			name = (String)nameField.get(h3);</div><div class="line">		&#125; <span class="keyword">catch</span>(IllegalAccessException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		System.out.println(name);</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###获取class对象，方式一###</span></div><div class="line">class MyTest.Human</div><div class="line"><span class="comment">###方式二###</span></div><div class="line">class MyTest.Human</div><div class="line"><span class="comment">###方式三###</span></div><div class="line">class MyTest.Human</div><div class="line"><span class="comment">###生成对象###</span></div><div class="line">lijinlong</div><div class="line"><span class="comment">###获取构造函数###</span></div><div class="line">zhouyi</div><div class="line"><span class="comment">###获取类的构造方法###</span></div><div class="line">[public MyTest.Human(), public MyTest.Human(java.lang.String,int)]</div><div class="line"><span class="comment">###取得接口###</span></div><div class="line">[interface java.io.Serializable]</div><div class="line"><span class="comment">###取得父类###</span></div><div class="line">class java.lang.Object</div><div class="line"><span class="comment">###取得类的所有方法###</span></div><div class="line">[public java.lang.String MyTest.Human.getName(), public void MyTest.Human.setName(java.lang.String), public void MyTest.Human.setAge(int), public int MyTest.Human.getAge(), public final void java.lang.Object.wait(long,int) throws java.lang.InterruptedException, public final native void java.lang.Object.wait(long) throws java.lang.InterruptedException, public final void java.lang.Object.wait() throws java.lang.InterruptedException, public boolean java.lang.Object.equals(java.lang.Object), public java.lang.String java.lang.Object.toString(), public native int java.lang.Object.hashCode(), public final native java.lang.Class java.lang.Object.getClass(), public final native void java.lang.Object.notify(), public final native void java.lang.Object.notifyAll()]</div><div class="line"><span class="comment">###调用获取的方法###</span></div><div class="line">seer</div><div class="line"><span class="comment">###获取类的属性，并改变属性值###</span></div><div class="line">gear</div></pre></td></tr></table></figure>
<p>```</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      	

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/19/Redis源代码分析之ziplist/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/19/Redis源代码分析之ziplist/" itemprop="url">
                  Redis源代码分析之ziplist
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-19T15:52:20+08:00">
                2016-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>ziplist.c的头部给出了ziplist的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* ZIPLIST OVERALL LAYOUT:</span></div><div class="line"> * The general layout of the ziplist is as follows:</div><div class="line"> * &lt;zlbytes&gt;&lt;zltail&gt;&lt;zllen&gt;&lt;entry&gt;&lt;entry&gt;&lt;zlend&gt;</div><div class="line"> *</div><div class="line"> * &lt;zlbytes&gt; is an unsigned integer to hold the number of bytes that the</div><div class="line"> * ziplist occupies. This value needs to be stored to be able to resize the</div><div class="line"> * entire structure without the need to traverse it first.</div><div class="line"> *</div><div class="line"> * &lt;zltail&gt; is the offset to the last entry in the list. This allows a pop</div><div class="line"> * operation on the far side of the list without the need for full traversal.</div><div class="line"> *</div><div class="line"> * &lt;zllen&gt; is the number of entries.When this value is larger than 2**16-2,</div><div class="line"> * we need to traverse the entire list to know how many items it holds.</div><div class="line"> *</div><div class="line"> * &lt;zlend&gt; is a single byte special value, equal to 255, which indicates the</div><div class="line"> * end of the list.</div><div class="line"> *</div><div class="line"> * ZIPLIST ENTRIES:</div><div class="line"> * Every entry in the ziplist is prefixed by a header that contains two pieces</div><div class="line"> * of information. First, the length of the previous entry is stored to be</div><div class="line"> * able to traverse the list from back to front. Second, the encoding with an</div><div class="line"> * optional string length of the entry itself is stored.</div><div class="line"> *</div><div class="line"> * The length of the previous entry is encoded in the following way:</div><div class="line"> * If this length is smaller than 254 bytes, it will only consume a single</div><div class="line"> * byte that takes the length as value. When the length is greater than or</div><div class="line"> * equal to 254, it will consume 5 bytes. The first byte is set to 254 to</div><div class="line"> * indicate a larger value is following. The remaining 4 bytes take the</div><div class="line"> * length of the previous entry as value.</div><div class="line"> *</div><div class="line"> * The other header field of the entry itself depends on the contents of the</div><div class="line"> * entry. When the entry is a string, the first 2 bits of this header will hold</div><div class="line"> * the type of encoding used to store the length of the string, followed by the</div><div class="line"> * actual length of the string. When the entry is an integer the first 2 bits</div><div class="line"> * are both set to 1. The following 2 bits are used to specify what kind of</div><div class="line"> * integer will be stored after this header. An overview of the different</div><div class="line"> * types and encodings is as follows:</div><div class="line"> *</div><div class="line"> * |00pppppp| - 1 byte</div><div class="line"> *      String value with length less than or equal to 63 bytes (6 bits).</div><div class="line"> * |01pppppp|qqqqqqqq| - 2 bytes</div><div class="line"> *      String value with length less than or equal to 16383 bytes (14 bits).</div><div class="line"> * |10______|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt| - 5 bytes</div><div class="line"> *      String value with length greater than or equal to 16384 bytes.</div><div class="line"> * |11000000| - 1 byte</div><div class="line"> *      Integer encoded as int16_t (2 bytes).</div><div class="line"> * |11010000| - 1 byte</div><div class="line"> *      Integer encoded as int32_t (4 bytes).</div><div class="line"> * |11100000| - 1 byte</div><div class="line"> *      Integer encoded as int64_t (8 bytes).</div><div class="line"> * |11110000| - 1 byte</div><div class="line"> *      Integer encoded as 24 bit signed (3 bytes).</div><div class="line"> * |11111110| - 1 byte</div><div class="line"> *      Integer encoded as 8 bit signed (1 byte).</div><div class="line"> * |1111xxxx| - (with xxxx between 0000 and 1101) immediate 4 bit integer.</div><div class="line"> *      Unsigned integer from 0 to 12. The encoded value is actually from</div><div class="line"> *      1 to 13 because 0000 and 1111 can not be used, so 1 should be</div><div class="line"> *      subtracted from the encoded 4 bit value to obtain the right value.</div><div class="line"> * |11111111| - End of ziplist.</div><div class="line"> *</div><div class="line"> * All the integers are represented in little endian byte order.</div><div class="line"> */</div></pre></td></tr></table></figure>
<p>由上面的的定义可以看出，ziplist大概看起来就是下面这样子<br><img src="/uploads/ziplist.jpg" alt="ziplist"></p>
<ul>
<li>其中zllen为4个字节，保存ziplist字节数；</li>
<li>zltail保存的是尾节点偏移量，4个字节；</li>
<li>zllen保存的是ziplist的长度，2个字节，ziplist的长度超出范围，只能通过遍历来知道ziplist的长度；</li>
<li><p>接着是一个个的entry，这是ziplist的节点，entry包含三个字段，第一个是prevlen，记录前一个节点的长度，方便逆向遍历，长度为1个字节或者5个字节，第二个是encoding，里面记录了data段的长度，1个字节到5个字节，最后的一个字段是data段，记录数据；</p>
</li>
<li><p>最后是zlend，结束标志，值为255</p>
</li>
</ul>
<h3 id="源代码分析"><a href="#源代码分析" class="headerlink" title="源代码分析"></a>源代码分析</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div><div class="line">856</div><div class="line">857</div><div class="line">858</div><div class="line">859</div><div class="line">860</div><div class="line">861</div><div class="line">862</div><div class="line">863</div><div class="line">864</div><div class="line">865</div><div class="line">866</div><div class="line">867</div><div class="line">868</div><div class="line">869</div><div class="line">870</div><div class="line">871</div><div class="line">872</div><div class="line">873</div><div class="line">874</div><div class="line">875</div><div class="line">876</div><div class="line">877</div><div class="line">878</div><div class="line">879</div><div class="line">880</div><div class="line">881</div><div class="line">882</div><div class="line">883</div><div class="line">884</div><div class="line">885</div><div class="line">886</div><div class="line">887</div><div class="line">888</div><div class="line">889</div><div class="line">890</div><div class="line">891</div><div class="line">892</div><div class="line">893</div><div class="line">894</div><div class="line">895</div><div class="line">896</div><div class="line">897</div><div class="line">898</div><div class="line">899</div><div class="line">900</div><div class="line">901</div><div class="line">902</div><div class="line">903</div><div class="line">904</div><div class="line">905</div><div class="line">906</div><div class="line">907</div><div class="line">908</div><div class="line">909</div><div class="line">910</div><div class="line">911</div><div class="line">912</div><div class="line">913</div><div class="line">914</div><div class="line">915</div><div class="line">916</div><div class="line">917</div><div class="line">918</div><div class="line">919</div><div class="line">920</div><div class="line">921</div><div class="line">922</div><div class="line">923</div><div class="line">924</div><div class="line">925</div><div class="line">926</div><div class="line">927</div><div class="line">928</div><div class="line">929</div><div class="line">930</div><div class="line">931</div><div class="line">932</div><div class="line">933</div><div class="line">934</div><div class="line">935</div><div class="line">936</div><div class="line">937</div><div class="line">938</div><div class="line">939</div><div class="line">940</div><div class="line">941</div><div class="line">942</div><div class="line">943</div><div class="line">944</div><div class="line">945</div><div class="line">946</div><div class="line">947</div><div class="line">948</div><div class="line">949</div><div class="line">950</div><div class="line">951</div><div class="line">952</div></pre></td><td class="code"><pre><div class="line">#define ZIP_END 255				//ziplist结尾zlend</div><div class="line">#define ZIP_BIGLEN 254			//zllen如果超过ZIP_BIGLEN的话，将会使用5个字节存储，不能使255，否则就跟zlend重复了</div><div class="line"></div><div class="line">/* Different encoding/length possibilities */</div><div class="line">#define ZIP_STR_MASK 0xc0</div><div class="line">#define ZIP_INT_MASK 0x30</div><div class="line">#define ZIP_STR_06B (0 &lt;&lt; 6)</div><div class="line">#define ZIP_STR_14B (1 &lt;&lt; 6)</div><div class="line">#define ZIP_STR_32B (2 &lt;&lt; 6)</div><div class="line">#define ZIP_INT_16B (0xc0 | 0&lt;&lt;4)</div><div class="line">#define ZIP_INT_32B (0xc0 | 1&lt;&lt;4)</div><div class="line">#define ZIP_INT_64B (0xc0 | 2&lt;&lt;4)</div><div class="line">#define ZIP_INT_24B (0xc0 | 3&lt;&lt;4)</div><div class="line">#define ZIP_INT_8B 0xfe</div><div class="line">/* 4 bit integer immediate encoding */</div><div class="line">#define ZIP_INT_IMM_MASK 0x0f</div><div class="line">#define ZIP_INT_IMM_MIN 0xf1    /* 11110001 */</div><div class="line">#define ZIP_INT_IMM_MAX 0xfd    /* 11111101 */</div><div class="line">#define ZIP_INT_IMM_VAL(v) (v &amp; ZIP_INT_IMM_MASK)</div><div class="line"></div><div class="line">#define INT24_MAX 0x7fffff</div><div class="line">#define INT24_MIN (-INT24_MAX - 1)</div><div class="line"></div><div class="line">/* Macro to determine type */</div><div class="line">#define ZIP_IS_STR(enc) (((enc) &amp; ZIP_STR_MASK) &lt; ZIP_STR_MASK)</div><div class="line"></div><div class="line">/* Utility macros */</div><div class="line">#define ZIPLIST_BYTES(zl)       (*((uint32_t*)(zl)))  //返回ziplist字节数</div><div class="line">#define ZIPLIST_TAIL_OFFSET(zl) (*((uint32_t*)((zl)+sizeof(uint32_t))))	//返回尾节点偏移量</div><div class="line">#define ZIPLIST_LENGTH(zl)      (*((uint16_t*)((zl)+sizeof(uint32_t)*2))) //返回ziplist的长度</div><div class="line">#define ZIPLIST_HEADER_SIZE     (sizeof(uint32_t)*2+sizeof(uint16_t)) //返回ziplist的头部长度，即zlbytes&gt;&lt;zltail&gt;&lt;zllen&gt;的长度</div><div class="line">#define ZIPLIST_END_SIZE        (sizeof(uint8_t))	//zlend的长度</div><div class="line">#define ZIPLIST_ENTRY_HEAD(zl)  ((zl)+ZIPLIST_HEADER_SIZE) //ziplist节点的开始位置</div><div class="line">#define ZIPLIST_ENTRY_TAIL(zl)  ((zl)+intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) //ziplist为尾部节点</div><div class="line">#define ZIPLIST_ENTRY_END(zl)   ((zl)+intrev32ifbe(ZIPLIST_BYTES(zl))-1) //ziplist结束符zlend</div><div class="line"></div><div class="line"></div><div class="line">//增加ziplist的长度</div><div class="line">#define ZIPLIST_INCR_LENGTH(zl,incr) &#123; \</div><div class="line">	//如果zllen的长度小于2**16 -  1，那么zllen = zllen + 1，否则不加1，这样的话求ziplist长度时候需要遍历整个ziplist才能知道zllen</div><div class="line">    if (ZIPLIST_LENGTH(zl) &lt; UINT16_MAX) \</div><div class="line">        ZIPLIST_LENGTH(zl) = intrev16ifbe(intrev16ifbe(ZIPLIST_LENGTH(zl))+incr); \</div><div class="line">&#125;</div><div class="line"></div><div class="line">//ziplist节点结构体（注：并非用来存储ziplist的原生数据）</div><div class="line">typedef struct zlentry &#123;</div><div class="line">    unsigned int prevrawlensize, prevrawlen;	//编码前一个节点的长度所需要的字节数，前一个节点的长度</div><div class="line">    unsigned int lensize, len; 	//编码本节点长度所需要的字节数，本字节的长度</div><div class="line">    unsigned int headersize; 	//ziplist的头长度，包括zlbytes,zltail,zllen</div><div class="line">    unsigned char encoding;		//数据编码</div><div class="line">    unsigned char *p;			//节点数据</div><div class="line">&#125; zlentry;</div><div class="line"></div><div class="line">//初始化zlentry</div><div class="line">#define ZIPLIST_ENTRY_ZERO(zle) &#123; \</div><div class="line">    (zle)-&gt;prevrawlensize = (zle)-&gt;prevrawlen = 0; \</div><div class="line">    (zle)-&gt;lensize = (zle)-&gt;len = (zle)-&gt;headersize = 0; \</div><div class="line">    (zle)-&gt;encoding = 0; \</div><div class="line">    (zle)-&gt;p = NULL; \</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Extract the encoding from the byte pointed by 'ptr' and set it into</div><div class="line"> * 'encoding'. */</div><div class="line">#define ZIP_ENTRY_ENCODING(ptr, encoding) do &#123;  \</div><div class="line">    (encoding) = (ptr[0]); \</div><div class="line">    if ((encoding) &lt; ZIP_STR_MASK) (encoding) &amp;= ZIP_STR_MASK; \</div><div class="line">&#125; while(0)</div><div class="line"></div><div class="line">void ziplistRepr(unsigned char *zl);</div><div class="line"></div><div class="line">//根据encoding来判断编码整数数据所需要的长度</div><div class="line">static unsigned int zipIntSize(unsigned char encoding) &#123;</div><div class="line">    switch(encoding) &#123;</div><div class="line">    case ZIP_INT_8B:  return 1;		//1个字节的整数</div><div class="line">    case ZIP_INT_16B: return 2;		//2</div><div class="line">    case ZIP_INT_24B: return 3;		//...</div><div class="line">    case ZIP_INT_32B: return 4;</div><div class="line">    case ZIP_INT_64B: return 8;</div><div class="line">    default: return 0; /* 4 bit immediate */</div><div class="line">    &#125;</div><div class="line">    assert(NULL);</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//给p写入encoding数据（字符串和整数分情况），如果p为空，则直接返回存储encoding所需要的长度</div><div class="line">static unsigned int zipEncodeLength(unsigned char *p, unsigned char encoding, unsigned int rawlen) &#123;</div><div class="line">    unsigned char len = 1, buf[5];</div><div class="line"></div><div class="line">    if (ZIP_IS_STR(encoding)) &#123;</div><div class="line">        /* Although encoding is given it may not be set for strings,</div><div class="line">         * so we determine it here using the raw length. */</div><div class="line">        if (rawlen &lt;= 0x3f) &#123;</div><div class="line">            if (!p) return len;</div><div class="line">            buf[0] = ZIP_STR_06B | rawlen;</div><div class="line">        &#125; else if (rawlen &lt;= 0x3fff) &#123;</div><div class="line">            len += 1;</div><div class="line">            if (!p) return len;</div><div class="line">            buf[0] = ZIP_STR_14B | ((rawlen &gt;&gt; 8) &amp; 0x3f);</div><div class="line">            buf[1] = rawlen &amp; 0xff;</div><div class="line">        &#125; else &#123;</div><div class="line">            len += 4;</div><div class="line">            if (!p) return len;</div><div class="line">            buf[0] = ZIP_STR_32B;</div><div class="line">            buf[1] = (rawlen &gt;&gt; 24) &amp; 0xff;</div><div class="line">            buf[2] = (rawlen &gt;&gt; 16) &amp; 0xff;</div><div class="line">            buf[3] = (rawlen &gt;&gt; 8) &amp; 0xff;</div><div class="line">            buf[4] = rawlen &amp; 0xff;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        //如果是整数直接返回1（整数encoding只需要一个字节来保存）</div><div class="line">        if (!p) return len;</div><div class="line">        buf[0] = encoding;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Store this length at p */</div><div class="line">    memcpy(p,buf,len);</div><div class="line">    return len;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//解码ptr位置的encoding，把编码长度赋值给lensize，把data段长度赋值给len</div><div class="line">#define ZIP_DECODE_LENGTH(ptr, encoding, lensize, len) do &#123;                    \</div><div class="line">    ZIP_ENTRY_ENCODING((ptr), (encoding));                                     \</div><div class="line">    if ((encoding) &lt; ZIP_STR_MASK) &#123;                                           \</div><div class="line">        if ((encoding) == ZIP_STR_06B) &#123;                                       \</div><div class="line">            (lensize) = 1;                                                     \</div><div class="line">            (len) = (ptr)[0] &amp; 0x3f;                                           \</div><div class="line">        &#125; else if ((encoding) == ZIP_STR_14B) &#123;                                \</div><div class="line">            (lensize) = 2;                                                     \</div><div class="line">            (len) = (((ptr)[0] &amp; 0x3f) &lt;&lt; 8) | (ptr)[1];                       \</div><div class="line">        &#125; else if (encoding == ZIP_STR_32B) &#123;                                  \</div><div class="line">            (lensize) = 5;                                                     \</div><div class="line">            (len) = ((ptr)[1] &lt;&lt; 24) |                                         \</div><div class="line">                    ((ptr)[2] &lt;&lt; 16) |                                         \</div><div class="line">                    ((ptr)[3] &lt;&lt;  8) |                                         \</div><div class="line">                    ((ptr)[4]);                                                \</div><div class="line">        &#125; else &#123;                                                               \</div><div class="line">            assert(NULL);                                                      \</div><div class="line">        &#125;                                                                      \</div><div class="line">    &#125; else &#123;                                                                   \</div><div class="line">        (lensize) = 1;                                                         \</div><div class="line">        (len) = zipIntSize(encoding);                                          \</div><div class="line">    &#125;                                                                          \</div><div class="line">&#125; while(0);</div><div class="line"></div><div class="line">//根据前一个节点的长度len在指针p的位置编码prevlen，如果p为NULL，则返回编码该prevlen所需要的长度</div><div class="line">static unsigned int zipPrevEncodeLength(unsigned char *p, unsigned int len) &#123;</div><div class="line">    if (p == NULL) &#123;</div><div class="line">        //如果len小于254，则用一个字节编码即可，如果不是则要5个字节</div><div class="line">        return (len &lt; ZIP_BIGLEN) ? 1 : sizeof(len)+1;</div><div class="line">    &#125; else &#123;</div><div class="line">        if (len &lt; ZIP_BIGLEN) &#123;</div><div class="line">            //写数据</div><div class="line">            p[0] = len;</div><div class="line">            return 1;</div><div class="line">        &#125; else &#123;</div><div class="line">            p[0] = ZIP_BIGLEN;</div><div class="line">            memcpy(p+1,&amp;len,sizeof(len));</div><div class="line">            memrev32ifbe(p+1);</div><div class="line">            return 1+sizeof(len);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//prevlen的编码，用于prevlen如果大于254的情况下</div><div class="line">static void zipPrevEncodeLengthForceLarge(unsigned char *p, unsigned int len) &#123;</div><div class="line">    if (p == NULL) return;</div><div class="line">    //前一个字节赋值为254，后面的四个字节保存len</div><div class="line">    p[0] = ZIP_BIGLEN;</div><div class="line">    memcpy(p+1,&amp;len,sizeof(len));</div><div class="line">    memrev32ifbe(p+1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回在ptr位置的prevlen的编码长度</div><div class="line">#define ZIP_DECODE_PREVLENSIZE(ptr, prevlensize) do &#123;                          \</div><div class="line">    if ((ptr)[0] &lt; ZIP_BIGLEN) &#123;                                               \</div><div class="line">        (prevlensize) = 1;                                                     \</div><div class="line">    &#125; else &#123;                                                                   \</div><div class="line">        (prevlensize) = 5;                                                     \</div><div class="line">    &#125;                                                                          \</div><div class="line">&#125; while(0);</div><div class="line"></div><div class="line">//解码在ptr位置的prevlen，把它的值保存在prevlen变量中</div><div class="line">#define ZIP_DECODE_PREVLEN(ptr, prevlensize, prevlen) do &#123;                     \</div><div class="line">    //先获取编码长度</div><div class="line">    ZIP_DECODE_PREVLENSIZE(ptr, prevlensize);                                  \</div><div class="line">    if ((prevlensize) == 1) &#123;                                                  \</div><div class="line">        (prevlen) = (ptr)[0];                                                  \</div><div class="line">    &#125; else if ((prevlensize) == 5) &#123;                                           \</div><div class="line">        assert(sizeof((prevlensize)) == 4);                                    \</div><div class="line">        memcpy(&amp;(prevlen), ((char*)(ptr)) + 1, 4);                             \</div><div class="line">        memrev32ifbe(&amp;prevlen);                                                \</div><div class="line">    &#125;                                                                          \</div><div class="line">&#125; while(0);</div><div class="line"></div><div class="line">//计算新的prevlen与旧的prevlen相差的字节数</div><div class="line">static int zipPrevLenByteDiff(unsigned char *p, unsigned int len) &#123;</div><div class="line">    unsigned int prevlensize;</div><div class="line">    //先获取旧的prevlen的编码长度</div><div class="line">    ZIP_DECODE_PREVLENSIZE(p, prevlensize);</div><div class="line">    //用现在需要的长度减去旧的prevlen的编码长度，算出diff</div><div class="line">    return zipPrevEncodeLength(NULL, len) - prevlensize;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//算出整个节点的长度</div><div class="line">static unsigned int zipRawEntryLength(unsigned char *p) &#123;</div><div class="line">    unsigned int prevlensize, encoding, lensize, len;</div><div class="line">    //先获取prevlen的编码长度</div><div class="line">    ZIP_DECODE_PREVLENSIZE(p, prevlensize);</div><div class="line">    //在获取encoding的编码长度lensize，和解码出data段的长度，len</div><div class="line">    ZIP_DECODE_LENGTH(p + prevlensize, encoding, lensize, len);</div><div class="line">    //加起来就是一个节点的总长度，</div><div class="line">    return prevlensize + lensize + len;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//尝试把字符串entry转换成整形，存在v中</div><div class="line">static int zipTryEncoding(unsigned char *entry, unsigned int entrylen, long long *v, unsigned char *encoding) &#123;</div><div class="line">    long long value;</div><div class="line"></div><div class="line">    //字符串长度超过32位或者字符串长度为0的时候，直接返回0</div><div class="line">    if (entrylen &gt;= 32 || entrylen == 0) return 0;</div><div class="line">    //如果可以转换的话</div><div class="line">    if (string2ll((char*)entry,entrylen,&amp;value)) &#123;</div><div class="line">        //判断转换出来的整数处于什么范围，选择最短的编码长度</div><div class="line">        if (value &gt;= 0 &amp;&amp; value &lt;= 12) &#123;</div><div class="line">            *encoding = ZIP_INT_IMM_MIN+value;</div><div class="line">        &#125; else if (value &gt;= INT8_MIN &amp;&amp; value &lt;= INT8_MAX) &#123;</div><div class="line">            *encoding = ZIP_INT_8B;</div><div class="line">        &#125; else if (value &gt;= INT16_MIN &amp;&amp; value &lt;= INT16_MAX) &#123;</div><div class="line">            *encoding = ZIP_INT_16B;</div><div class="line">        &#125; else if (value &gt;= INT24_MIN &amp;&amp; value &lt;= INT24_MAX) &#123;</div><div class="line">            *encoding = ZIP_INT_24B;</div><div class="line">        &#125; else if (value &gt;= INT32_MIN &amp;&amp; value &lt;= INT32_MAX) &#123;</div><div class="line">            *encoding = ZIP_INT_32B;</div><div class="line">        &#125; else &#123;</div><div class="line">            *encoding = ZIP_INT_64B;</div><div class="line">        &#125;</div><div class="line">        *v = value;</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//保存值在p位置，以encoding的格式保存</div><div class="line">static void zipSaveInteger(unsigned char *p, int64_t value, unsigned char encoding) &#123;</div><div class="line">    int16_t i16;</div><div class="line">    int32_t i32;</div><div class="line">    int64_t i64;</div><div class="line">    //判断encoding的类型，根据类型来写入value值在data段</div><div class="line">    if (encoding == ZIP_INT_8B) &#123;</div><div class="line">        ((int8_t*)p)[0] = (int8_t)value;</div><div class="line">    &#125; else if (encoding == ZIP_INT_16B) &#123;</div><div class="line">        i16 = value;</div><div class="line">        memcpy(p,&amp;i16,sizeof(i16));</div><div class="line">        memrev16ifbe(p);</div><div class="line">    &#125; else if (encoding == ZIP_INT_24B) &#123;</div><div class="line">        i32 = value&lt;&lt;8;</div><div class="line">        memrev32ifbe(&amp;i32);</div><div class="line">        memcpy(p,((uint8_t*)&amp;i32)+1,sizeof(i32)-sizeof(uint8_t));</div><div class="line">    &#125; else if (encoding == ZIP_INT_32B) &#123;</div><div class="line">        i32 = value;</div><div class="line">        memcpy(p,&amp;i32,sizeof(i32));</div><div class="line">        memrev32ifbe(p);</div><div class="line">    &#125; else if (encoding == ZIP_INT_64B) &#123;</div><div class="line">        i64 = value;</div><div class="line">        memcpy(p,&amp;i64,sizeof(i64));</div><div class="line">        memrev64ifbe(p);</div><div class="line">    &#125; else if (encoding &gt;= ZIP_INT_IMM_MIN &amp;&amp; encoding &lt;= ZIP_INT_IMM_MAX) &#123;</div><div class="line">        /* Nothing to do, the value is stored in the encoding itself. */</div><div class="line">    &#125; else &#123;</div><div class="line">        assert(NULL);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//根据encoding来读取Integer，原理同上，注释略</div><div class="line">static int64_t zipLoadInteger(unsigned char *p, unsigned char encoding) &#123;</div><div class="line">    int16_t i16;</div><div class="line">    int32_t i32;</div><div class="line">    int64_t i64, ret = 0;</div><div class="line">    if (encoding == ZIP_INT_8B) &#123;</div><div class="line">        ret = ((int8_t*)p)[0];</div><div class="line">    &#125; else if (encoding == ZIP_INT_16B) &#123;</div><div class="line">        memcpy(&amp;i16,p,sizeof(i16));</div><div class="line">        memrev16ifbe(&amp;i16);</div><div class="line">        ret = i16;</div><div class="line">    &#125; else if (encoding == ZIP_INT_32B) &#123;</div><div class="line">        memcpy(&amp;i32,p,sizeof(i32));</div><div class="line">        memrev32ifbe(&amp;i32);</div><div class="line">        ret = i32;</div><div class="line">    &#125; else if (encoding == ZIP_INT_24B) &#123;</div><div class="line">        i32 = 0;</div><div class="line">        memcpy(((uint8_t*)&amp;i32)+1,p,sizeof(i32)-sizeof(uint8_t));</div><div class="line">        memrev32ifbe(&amp;i32);</div><div class="line">        ret = i32&gt;&gt;8;</div><div class="line">    &#125; else if (encoding == ZIP_INT_64B) &#123;</div><div class="line">        memcpy(&amp;i64,p,sizeof(i64));</div><div class="line">        memrev64ifbe(&amp;i64);</div><div class="line">        ret = i64;</div><div class="line">    &#125; else if (encoding &gt;= ZIP_INT_IMM_MIN &amp;&amp; encoding &lt;= ZIP_INT_IMM_MAX) &#123;</div><div class="line">        ret = (encoding &amp; ZIP_INT_IMM_MASK)-1;</div><div class="line">    &#125; else &#123;</div><div class="line">        assert(NULL);</div><div class="line">    &#125;</div><div class="line">    return ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//解码节点信息，保存在结构体e中</div><div class="line">static void zipEntry(unsigned char *p, zlentry *e) &#123;</div><div class="line">    //获取prevlen，以及其编码长度</div><div class="line">    ZIP_DECODE_PREVLEN(p, e-&gt;prevrawlensize, e-&gt;prevrawlen);</div><div class="line">    //获取encoding和其编码长度，和data段的长度len</div><div class="line">    ZIP_DECODE_LENGTH(p + e-&gt;prevrawlensize, e-&gt;encoding, e-&gt;lensize, e-&gt;len);</div><div class="line">    //计算节点“头”的长度，即prevlen的编码长度加上encoding的编码长度</div><div class="line">    e-&gt;headersize = e-&gt;prevrawlensize + e-&gt;lensize;</div><div class="line">    e-&gt;p = p;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//创建一个新的ziplist</div><div class="line">unsigned char *ziplistNew(void) &#123;</div><div class="line">    unsigned int bytes = ZIPLIST_HEADER_SIZE+1;</div><div class="line">    unsigned char *zl = zmalloc(bytes);</div><div class="line">    ZIPLIST_BYTES(zl) = intrev32ifbe(bytes);</div><div class="line">    ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(ZIPLIST_HEADER_SIZE);</div><div class="line">    ZIPLIST_LENGTH(zl) = 0;</div><div class="line">    zl[bytes-1] = ZIP_END;</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//从新分配zl的大小</div><div class="line">static unsigned char *ziplistResize(unsigned char *zl, unsigned int len) &#123;</div><div class="line">    zl = zrealloc(zl,len);</div><div class="line">    ZIPLIST_BYTES(zl) = intrev32ifbe(len);</div><div class="line">    zl[len-1] = ZIP_END;</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//连锁更新函数，因为当插入一个新的节点时候，新节点的后一个元素的prevlen要重新编码，由此</div><div class="line">//新节点的后后个元素就又要更新prevlen了...由此导致一系列的连锁更新</div><div class="line">static unsigned char *__ziplistCascadeUpdate(unsigned char *zl, unsigned char *p) &#123;</div><div class="line">    size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), rawlen, rawlensize;</div><div class="line">    size_t offset, noffset, extra;</div><div class="line">    unsigned char *np;</div><div class="line">    zlentry cur, next;</div><div class="line"></div><div class="line">    //如果p还没到达尾部的话</div><div class="line">    while (p[0] != ZIP_END) &#123;</div><div class="line">        //解码p位置上的节点，把相关信息保存在cur结构体中</div><div class="line">        zipEntry(p, &amp;cur);</div><div class="line">        //整个节点的大小</div><div class="line">        rawlen = cur.headersize + cur.len;</div><div class="line">        //编码这个节点的大小所需要的字节数</div><div class="line">        rawlensize = zipPrevEncodeLength(NULL,rawlen);</div><div class="line"></div><div class="line">        //如果p位置所在的节点后面是zlend，也就是后面没有节点了，跳出</div><div class="line">        if (p[rawlen] == ZIP_END) break;</div><div class="line">        //把下一个节点的信息读取到next结构体中</div><div class="line">        zipEntry(p+rawlen, &amp;next);</div><div class="line"></div><div class="line">        //如果下一个节点的prevlen编码长度与编码rawlen所需要的长度一样，跳出</div><div class="line">        if (next.prevrawlen == rawlen) break;</div><div class="line"></div><div class="line">        //如果下一个节点的prevlen编码长度不够</div><div class="line">        if (next.prevrawlensize &lt; rawlensize) &#123;</div><div class="line">           </div><div class="line">            offset = p-zl;</div><div class="line">            //计算需要的额外空间extra</div><div class="line">            extra = rawlensize-next.prevrawlensize;</div><div class="line">            //重新分配</div><div class="line">            zl = ziplistResize(zl,curlen+extra);</div><div class="line">            p = zl+offset;</div><div class="line"></div><div class="line">            //np为下一个节点的位置</div><div class="line">            np = p+rawlen;</div><div class="line">            //noffset为下一个节点的偏移量</div><div class="line">            noffset = np-zl;</div><div class="line"></div><div class="line">            //如果np不是尾节点，则更新zltail，如果np是尾节点，则不用更新，因为np的位置相对之前没有变</div><div class="line">            if ((zl+intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) != np) &#123;</div><div class="line">                ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">                    intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+extra);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            //内存移动</div><div class="line">            memmove(np+rawlensize,</div><div class="line">                np+next.prevrawlensize,</div><div class="line">                curlen-noffset-next.prevrawlensize-1);</div><div class="line">            //把rawlen编码进np的prevlen字段中</div><div class="line">            zipPrevEncodeLength(np,rawlen);</div><div class="line"></div><div class="line">            //跟新p和curlen</div><div class="line">            p += rawlen;</div><div class="line">            curlen += extra;</div><div class="line">        &#125; else &#123;</div><div class="line">            //如果下一个节点的prevlen的编码长度比rawlensize要大</div><div class="line">            if (next.prevrawlensize &gt; rawlensize) &#123;</div><div class="line">                //这说明要缩小np的prevlen编码长度，但是我们采用懒惰策略，暂时不缩小prelen的编码长度，而是把rawlen先写入np的prevlen中</div><div class="line">                zipPrevEncodeLengthForceLarge(p+rawlen,rawlen);</div><div class="line">            &#125; else &#123;</div><div class="line">                //如果长度刚刚好，则编码rawlen到np的prevlen字段中</div><div class="line">                zipPrevEncodeLength(p+rawlen,rawlen);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            /* Stop here, as the raw length of "next" has not changed. */</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Delete "num" entries, starting at "p". Returns pointer to the ziplist. */</div><div class="line">static unsigned char *__ziplistDelete(unsigned char *zl, unsigned char *p, unsigned int num) &#123;</div><div class="line">    unsigned int i, totlen, deleted = 0;</div><div class="line">    size_t offset;</div><div class="line">    int nextdiff = 0;</div><div class="line">    zlentry first, tail;</div><div class="line"></div><div class="line">    zipEntry(p, &amp;first);</div><div class="line">    for (i = 0; p[0] != ZIP_END &amp;&amp; i &lt; num; i++) &#123;</div><div class="line">        p += zipRawEntryLength(p);</div><div class="line">        deleted++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    totlen = p-first.p;</div><div class="line">    if (totlen &gt; 0) &#123;</div><div class="line">        if (p[0] != ZIP_END) &#123;</div><div class="line">            /* Storing `prevrawlen` in this entry may increase or decrease the</div><div class="line">             * number of bytes required compare to the current `prevrawlen`.</div><div class="line">             * There always is room to store this, because it was previously</div><div class="line">             * stored by an entry that is now being deleted. */</div><div class="line">            nextdiff = zipPrevLenByteDiff(p,first.prevrawlen);</div><div class="line">            p -= nextdiff;</div><div class="line">            zipPrevEncodeLength(p,first.prevrawlen);</div><div class="line"></div><div class="line">            /* Update offset for tail */</div><div class="line">            ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">                intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))-totlen);</div><div class="line"></div><div class="line">            /* When the tail contains more than one entry, we need to take</div><div class="line">             * "nextdiff" in account as well. Otherwise, a change in the</div><div class="line">             * size of prevlen doesn't have an effect on the *tail* offset. */</div><div class="line">            zipEntry(p, &amp;tail);</div><div class="line">            if (p[tail.headersize+tail.len] != ZIP_END) &#123;</div><div class="line">                ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">                   intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+nextdiff);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            /* Move tail to the front of the ziplist */</div><div class="line">            memmove(first.p,p,</div><div class="line">                intrev32ifbe(ZIPLIST_BYTES(zl))-(p-zl)-1);</div><div class="line">        &#125; else &#123;</div><div class="line">            /* The entire tail was deleted. No need to move memory. */</div><div class="line">            ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">                intrev32ifbe((first.p-zl)-first.prevrawlen);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        /* Resize and update length */</div><div class="line">        offset = first.p-zl;</div><div class="line">        zl = ziplistResize(zl, intrev32ifbe(ZIPLIST_BYTES(zl))-totlen+nextdiff);</div><div class="line">        ZIPLIST_INCR_LENGTH(zl,-deleted);</div><div class="line">        p = zl+offset;</div><div class="line"></div><div class="line">        /* When nextdiff != 0, the raw length of the next entry has changed, so</div><div class="line">         * we need to cascade the update throughout the ziplist */</div><div class="line">        if (nextdiff != 0)</div><div class="line">            zl = __ziplistCascadeUpdate(zl,p);</div><div class="line">    &#125;</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Insert item at "p". */</div><div class="line">//在位置p中插入节点，数据后移</div><div class="line">static unsigned char *__ziplistInsert(unsigned char *zl, unsigned char *p, unsigned char *s, unsigned int slen) &#123;</div><div class="line">    size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), reqlen;</div><div class="line">    unsigned int prevlensize, prevlen = 0;</div><div class="line">    size_t offset;</div><div class="line">    int nextdiff = 0;</div><div class="line">    unsigned char encoding = 0;</div><div class="line">    long long value = 123456789; /* initialized to avoid warning. Using a value</div><div class="line">                                    that is easy to see if for some reason</div><div class="line">                                    we use it uninitialized. */</div><div class="line">    zlentry tail;	</div><div class="line"></div><div class="line">    //判断位置p是不是zlend</div><div class="line">    if (p[0] != ZIP_END) &#123;</div><div class="line">    	//把位置p中所在的节点的[编码前一个节点长度所需的字节数]和[前一个节点的长度]计算出来</div><div class="line">        ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);</div><div class="line">    &#125; else &#123;</div><div class="line">    	//如果位置p是zlend，</div><div class="line">        unsigned char *ptail = ZIPLIST_ENTRY_TAIL(zl);	//返回尾节点</div><div class="line">        //如果尾节点不为zlend的话，也就是ziplist不为空时</div><div class="line">        if (ptail[0] != ZIP_END) &#123;</div><div class="line">        	//把尾部节点的长度计算出来</div><div class="line">            prevlen = zipRawEntryLength(ptail);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //判断字符串数据是否可以用整数来表示，如果可以，则用整数类型表示，以节省空间</div><div class="line">    if (zipTryEncoding(s,slen,&amp;value,&amp;encoding)) &#123;</div><div class="line">        //获取存储该整数数据所需要的字节数</div><div class="line">        reqlen = zipIntSize(encoding);</div><div class="line">    &#125; else &#123;</div><div class="line">        //如果不能转化为整数数据，直接把字符串长度付给reqlen</div><div class="line">        reqlen = slen;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //reqlen加上编码prevlen需要的字节数</div><div class="line">    reqlen += zipPrevEncodeLength(NULL,prevlen);</div><div class="line">    //reqlen加上编码len需要的字节数</div><div class="line">    reqlen += zipEncodeLength(NULL,encoding,slen);</div><div class="line"></div><div class="line">    //因为加入新节点之后，新节点的后一个节点的prevlen字段先前保存的时候新节点的前一个节点的长度</div><div class="line">    //现在保存的是新节点的长度，所以长度可能有所改变，长度改变用nextdiff来计算</div><div class="line">    nextdiff = (p[0] != ZIP_END) ? zipPrevLenByteDiff(p,reqlen) : 0;</div><div class="line"></div><div class="line">    //对存储ziplist的内存进行realloc，因为zl的地址可能会改变，所以要先保存好p到zl的offset</div><div class="line">    offset = p-zl;</div><div class="line">    zl = ziplistResize(zl,curlen+reqlen+nextdiff);</div><div class="line">    p = zl+offset;		//恢复p</div><div class="line"></div><div class="line">    //如果插入位置不在ziplist的尾部</div><div class="line">    if (p[0] != ZIP_END) &#123;</div><div class="line">        //数据后移，为新节点腾出空间</div><div class="line">        memmove(p+reqlen,p-nextdiff,curlen-offset-1+nextdiff);</div><div class="line"></div><div class="line">        //更新新节点的后一个节点的prevlen</div><div class="line">        zipPrevEncodeLength(p+reqlen,reqlen);</div><div class="line"></div><div class="line">        //更新tail位置，看到这里大家可能有点懵逼，这里为什么不用加上nextdiff的长度的呢，别急，继续往下看</div><div class="line">        ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">            intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+reqlen);</div><div class="line"></div><div class="line">        /* When the tail contains more than one entry, we need to take</div><div class="line">         * "nextdiff" in account as well. Otherwise, a change in the</div><div class="line">         * size of prevlen doesn't have an effect on the *tail* offset. */</div><div class="line">        //把新节点后一个节点的信息提取到*tail结构体中</div><div class="line">        zipEntry(p+reqlen, &amp;tail);</div><div class="line">        //如果新节点后一个节点不是尾节点，那么就要加上nextdiff（解答了上面的疑惑）</div><div class="line">        if (p[reqlen+tail.headersize+tail.len] != ZIP_END) &#123;</div><div class="line">            ZIPLIST_TAIL_OFFSET(zl) =</div><div class="line">                intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+nextdiff);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">    	//如果新节点就是ziplist的为节点，那么就更新zltail</div><div class="line">        ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(p-zl);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //如果nextdiff不为0，那么就执行连锁更新</div><div class="line">    if (nextdiff != 0) &#123;</div><div class="line">        offset = p-zl;</div><div class="line">        zl = __ziplistCascadeUpdate(zl,p+reqlen);</div><div class="line">        p = zl+offset;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //把prelen写入新节点中</div><div class="line">    p += zipPrevEncodeLength(p,prevlen);</div><div class="line">    //把len(encoding)写入新节点中</div><div class="line">    p += zipEncodeLength(p,encoding,slen);</div><div class="line">    //如果数据是字符串，那么宝贝数据到data段</div><div class="line">    if (ZIP_IS_STR(encoding)) &#123;</div><div class="line">        memcpy(p,s,slen);</div><div class="line">    &#125; else &#123;</div><div class="line">    	//如果是整数就整数</div><div class="line">        zipSaveInteger(p,value,encoding);</div><div class="line">    &#125;</div><div class="line">    //给ziplist的长度加1</div><div class="line">    ZIPLIST_INCR_LENGTH(zl,1);</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"> //合并两个压缩表first和second，两个中比较大的一个压缩表会被realloc以足以存储合并后的结果，另一个会被释放掉</div><div class="line">unsigned char *ziplistMerge(unsigned char **first, unsigned char **second) &#123;</div><div class="line">    //任何一个参数为NULL的话，返回NULL</div><div class="line">    if (first == NULL || *first == NULL || second == NULL || *second == NULL)</div><div class="line">        return NULL;</div><div class="line"></div><div class="line">    //如果这两个ziplist是同一个ziplist的话，返回NULL</div><div class="line">    if (*first == *second)</div><div class="line">        return NULL;</div><div class="line"></div><div class="line">    //第一个ziplist的字节数</div><div class="line">    size_t first_bytes = intrev32ifbe(ZIPLIST_BYTES(*first));</div><div class="line">    //第一个ziplist的节点数</div><div class="line">    size_t first_len = intrev16ifbe(ZIPLIST_LENGTH(*first));</div><div class="line"></div><div class="line">    //第二个ziplist的字节数</div><div class="line">    size_t second_bytes = intrev32ifbe(ZIPLIST_BYTES(*second));</div><div class="line">    //第二个ziplist的节点数</div><div class="line">    size_t second_len = intrev16ifbe(ZIPLIST_LENGTH(*second));</div><div class="line"></div><div class="line">    int append;</div><div class="line">    unsigned char *source, *target;</div><div class="line">    size_t target_bytes, source_bytes;</div><div class="line">    /* Pick the largest ziplist so we can resize easily in-place.</div><div class="line">     * We must also track if we are now appending or prepending to</div><div class="line">     * the target ziplist. */</div><div class="line">    //如果第一个ziplist的节点数大于第二个ziplist的话</div><div class="line">    if (first_len &gt;= second_len) &#123;</div><div class="line">        //那么就把second合并到first</div><div class="line">        target = *first;</div><div class="line">        target_bytes = first_bytes;</div><div class="line">        source = *second;</div><div class="line">        source_bytes = second_bytes;</div><div class="line">        append = 1;</div><div class="line">    &#125; else &#123;</div><div class="line">        //否则，把first合并到second</div><div class="line">        target = *second;</div><div class="line">        target_bytes = second_bytes;</div><div class="line">        source = *first;</div><div class="line">        source_bytes = first_bytes;</div><div class="line">        append = 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //计算合并后的字节数</div><div class="line">    size_t zlbytes = first_bytes + second_bytes -</div><div class="line">                     ZIPLIST_HEADER_SIZE - ZIPLIST_END_SIZE;</div><div class="line">    //计算合并后的节点数</div><div class="line">    size_t zllength = first_len + second_len;</div><div class="line"></div><div class="line">    //zllength应该小于2**16 - 1，否则把2**16 - 1赋给zllength</div><div class="line">    zllength = zllength &lt; UINT16_MAX ? zllength : UINT16_MAX;</div><div class="line"></div><div class="line">    //分别求出firs和second的尾节点偏移</div><div class="line">    size_t first_offset = intrev32ifbe(ZIPLIST_TAIL_OFFSET(*first));</div><div class="line">    size_t second_offset = intrev32ifbe(ZIPLIST_TAIL_OFFSET(*second));</div><div class="line"></div><div class="line">    //给target分配空间（两个ziplist合起来的空间）</div><div class="line">    target = zrealloc(target, zlbytes);</div><div class="line">    if (append) &#123;</div><div class="line">        //如果把second(source)加到first(target)</div><div class="line">        //把second拷贝到first后</div><div class="line">        memcpy(target + target_bytes - ZIPLIST_END_SIZE,</div><div class="line">               source + ZIPLIST_HEADER_SIZE,</div><div class="line">               source_bytes - ZIPLIST_HEADER_SIZE);</div><div class="line">    &#125; else &#123;</div><div class="line">        //如果把first(source)加到second(target)</div><div class="line">        //先把second后移，腾出空间给first</div><div class="line">        memmove(target + source_bytes - ZIPLIST_END_SIZE,</div><div class="line">                target + ZIPLIST_HEADER_SIZE,</div><div class="line">                target_bytes - ZIPLIST_HEADER_SIZE);</div><div class="line">        //把first拷贝到腾出的空间里面</div><div class="line">        memcpy(target, source, source_bytes - ZIPLIST_END_SIZE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //更新ziplist的zlbytes</div><div class="line">    ZIPLIST_BYTES(target) = intrev32ifbe(zlbytes);</div><div class="line">    //更新ziplist的zllen</div><div class="line">    ZIPLIST_LENGTH(target) = intrev16ifbe(zllength);</div><div class="line"></div><div class="line">    //更新尾节点偏移</div><div class="line">    ZIPLIST_TAIL_OFFSET(target) = intrev32ifbe(</div><div class="line">                                   (first_bytes - ZIPLIST_END_SIZE) +</div><div class="line">                                   (second_offset - ZIPLIST_HEADER_SIZE));</div><div class="line"></div><div class="line">    //连锁更新</div><div class="line">    target = __ziplistCascadeUpdate(target, target+first_offset);</div><div class="line"></div><div class="line">    //释放资源</div><div class="line">    if (append) &#123;</div><div class="line">        zfree(*second);</div><div class="line">        *second = NULL;</div><div class="line">        *first = target;</div><div class="line">    &#125; else &#123;</div><div class="line">        zfree(*first);</div><div class="line">        *first = NULL;</div><div class="line">        *second = target;</div><div class="line">    &#125;</div><div class="line">    return target;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//把s加到ziplist开始或者末尾</div><div class="line">unsigned char *ziplistPush(unsigned char *zl, unsigned char *s, unsigned int slen, int where) &#123;</div><div class="line">    unsigned char *p;</div><div class="line">    p = (where == ZIPLIST_HEAD) ? ZIPLIST_ENTRY_HEAD(zl) : ZIPLIST_ENTRY_END(zl);</div><div class="line">    return __ziplistInsert(zl,p,s,slen);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回index位置上的节点，如果不存在返回NULL, 如果index未负数，从尾节点开始向前遍历</div><div class="line">unsigned char *ziplistIndex(unsigned char *zl, int index) &#123;</div><div class="line">    unsigned char *p;</div><div class="line">    unsigned int prevlensize, prevlen = 0;</div><div class="line">    //如果为负数，从后往前遍历</div><div class="line">    if (index &lt; 0) &#123;</div><div class="line">        index = (-index)-1;</div><div class="line">        p = ZIPLIST_ENTRY_TAIL(zl);</div><div class="line">        if (p[0] != ZIP_END) &#123;</div><div class="line">            ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);</div><div class="line">            while (prevlen &gt; 0 &amp;&amp; index--) &#123;</div><div class="line">                p -= prevlen;</div><div class="line">                ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        p = ZIPLIST_ENTRY_HEAD(zl);</div><div class="line">        while (p[0] != ZIP_END &amp;&amp; index--) &#123;</div><div class="line">            p += zipRawEntryLength(p);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return (p[0] == ZIP_END || index &gt; 0) ? NULL : p;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回在p位置的节点的下一个节点</div><div class="line">unsigned char *ziplistNext(unsigned char *zl, unsigned char *p) &#123;</div><div class="line">    ((void) zl);</div><div class="line"></div><div class="line">    /* "p" could be equal to ZIP_END, caused by ziplistDelete,</div><div class="line">     * and we should return NULL. Otherwise, we should return NULL</div><div class="line">     * when the *next* element is ZIP_END (there is no next entry). */</div><div class="line">    if (p[0] == ZIP_END) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    p += zipRawEntryLength(p);</div><div class="line">    if (p[0] == ZIP_END) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return p;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回上一个节点</div><div class="line">unsigned char *ziplistPrev(unsigned char *zl, unsigned char *p) &#123;</div><div class="line">    unsigned int prevlensize, prevlen = 0;</div><div class="line"></div><div class="line">    /* Iterating backwards from ZIP_END should return the tail. When "p" is</div><div class="line">     * equal to the first element of the list, we're already at the head,</div><div class="line">     * and should return NULL. */</div><div class="line">    if (p[0] == ZIP_END) &#123;</div><div class="line">        p = ZIPLIST_ENTRY_TAIL(zl);</div><div class="line">        return (p[0] == ZIP_END) ? NULL : p;</div><div class="line">    &#125; else if (p == ZIPLIST_ENTRY_HEAD(zl)) &#123;</div><div class="line">        return NULL;</div><div class="line">    &#125; else &#123;</div><div class="line">        ZIP_DECODE_PREVLEN(p, prevlensize, prevlen);</div><div class="line">        assert(prevlen &gt; 0);</div><div class="line">        return p-prevlen;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//获取p位置上的值，如果是字符串，则存于sstr中，如果是整数，则存于sval中</div><div class="line">unsigned int ziplistGet(unsigned char *p, unsigned char **sstr, unsigned int *slen, long long *sval) &#123;</div><div class="line">    zlentry entry;</div><div class="line">    if (p == NULL || p[0] == ZIP_END) return 0;</div><div class="line">    if (sstr) *sstr = NULL;</div><div class="line"></div><div class="line">    //提取节点信息</div><div class="line">    zipEntry(p, &amp;entry);</div><div class="line">    //如果是字符串</div><div class="line">    if (ZIP_IS_STR(entry.encoding)) &#123;</div><div class="line">        if (sstr) &#123;</div><div class="line">            *slen = entry.len;</div><div class="line">            *sstr = p+entry.headersize;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        if (sval) &#123;</div><div class="line">            //如果是整数直接根据enconding提取p+entry.headersize上的数据存在sval中</div><div class="line">            *sval = zipLoadInteger(p+entry.headersize,entry.encoding);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return 1;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//包装函数，在p位置插入字符窜s，slen为s的长度</div><div class="line">unsigned char *ziplistInsert(unsigned char *zl, unsigned char *p, unsigned char *s, unsigned int slen) &#123;</div><div class="line">    return __ziplistInsert(zl,p,s,slen);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Delete a single entry from the ziplist, pointed to by *p.</div><div class="line"> * Also update *p in place, to be able to iterate over the</div><div class="line"> * ziplist, while deleting entries. */</div><div class="line">unsigned char *ziplistDelete(unsigned char *zl, unsigned char **p) &#123;</div><div class="line">    size_t offset = *p-zl;</div><div class="line">    zl = __ziplistDelete(zl,*p,1);</div><div class="line"></div><div class="line">    /* Store pointer to current element in p, because ziplistDelete will</div><div class="line">     * do a realloc which might result in a different "zl"-pointer.</div><div class="line">     * When the delete direction is back to front, we might delete the last</div><div class="line">     * entry and end up with "p" pointing to ZIP_END, so check this. */</div><div class="line">    *p = zl+offset;</div><div class="line">    return zl;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//删除指定位置上的节点</div><div class="line">unsigned char *ziplistDeleteRange(unsigned char *zl, int index, unsigned int num) &#123;</div><div class="line">    unsigned char *p = ziplistIndex(zl,index);</div><div class="line">    return (p == NULL) ? zl : __ziplistDelete(zl,p,num);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//比较p位置的节点与sstr的数据是否相等</div><div class="line">unsigned int ziplistCompare(unsigned char *p, unsigned char *sstr, unsigned int slen) &#123;</div><div class="line">    zlentry entry;</div><div class="line">    unsigned char sencoding;</div><div class="line">    long long zval, sval;</div><div class="line">    if (p[0] == ZIP_END) return 0;</div><div class="line"></div><div class="line">    //提取当前节点的信息到entry结构体</div><div class="line">    zipEntry(p, &amp;entry);</div><div class="line">    if (ZIP_IS_STR(entry.encoding)) &#123;</div><div class="line">        //如果是当前节点的数据段是字符串的话，进行字符串比较</div><div class="line">        if (entry.len == slen) &#123;</div><div class="line">            return memcmp(p+entry.headersize,sstr,slen) == 0;</div><div class="line">        &#125; else &#123;</div><div class="line">            return 0;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">       	//如果不是字符串，先尝试把sstr转换成整数，然后再对其进行比较</div><div class="line">        if (zipTryEncoding(sstr,slen,&amp;sval,&amp;sencoding)) &#123;</div><div class="line">          zval = zipLoadInteger(p+entry.headersize,entry.encoding);</div><div class="line">          return zval == sval;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//给出vstr，查找与之相等的节点，skip指定每隔skip个节点比较一次，如果没有找到，返回NULL</div><div class="line">unsigned char *ziplistFind(unsigned char *p, unsigned char *vstr, unsigned int vlen, unsigned int skip) &#123;</div><div class="line">    int skipcnt = 0;</div><div class="line">    unsigned char vencoding = 0;</div><div class="line">    long long vll = 0;</div><div class="line"></div><div class="line">    //如果没达到zlend</div><div class="line">    while (p[0] != ZIP_END) &#123;</div><div class="line">        unsigned int prevlensize, encoding, lensize, len;</div><div class="line">        unsigned char *q;</div><div class="line"></div><div class="line">        //解码出当前节点的prevlensize</div><div class="line">        ZIP_DECODE_PREVLENSIZE(p, prevlensize);</div><div class="line">        //解码出len和lensize</div><div class="line">        ZIP_DECODE_LENGTH(p + prevlensize, encoding, lensize, len);</div><div class="line">        //求出数据段的开始地址q</div><div class="line">        q = p + prevlensize + lensize;</div><div class="line"></div><div class="line">        if (skipcnt == 0) &#123;</div><div class="line">            //比较当前节点的数据是否跟给出的vstr相同，如果相同则返回当前节点的开始地址</div><div class="line">            //如果是字符串数据</div><div class="line">            if (ZIP_IS_STR(encoding)) &#123;</div><div class="line">                if (len == vlen &amp;&amp; memcmp(q, vstr, vlen) == 0) &#123;</div><div class="line">                    return p;</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                //接下来是编码输入数据vstr，当vencoding为0的时候，说明其还没有被编码，下面的代码对它进行编码</div><div class="line">                if (vencoding == 0) &#123;</div><div class="line">                    if (!zipTryEncoding(vstr, vlen, &amp;vll, &amp;vencoding)) &#123;</div><div class="line">                        //如果不能被转化成整形数据，那么把vencoding设成255，这样的话下次就不会再对其进行编码了</div><div class="line">                        vencoding = UCHAR_MAX;</div><div class="line">                    &#125;</div><div class="line">                    /* Must be non-zero by now */</div><div class="line">                    assert(vencoding);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                //如果vencoding不是UCHAR_MAX，那么说明vstr已经被转换成整形数据</div><div class="line">                if (vencoding != UCHAR_MAX) &#123;</div><div class="line">                    long long ll = zipLoadInteger(q, encoding);</div><div class="line">        			//ll等于vll的话，那就返回当前节点的开始指针</div><div class="line">                    if (ll == vll) &#123;</div><div class="line">                        return p;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            /* Reset skip count */</div><div class="line">            skipcnt = skip;</div><div class="line">        &#125; else &#123;</div><div class="line">            /* Skip entry */</div><div class="line">            skipcnt--;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //更新p，移动到下一个节点</div><div class="line">        p = q + len;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return NULL;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回ziplist的长度</div><div class="line">unsigned int ziplistLen(unsigned char *zl) &#123;</div><div class="line">    unsigned int len = 0;</div><div class="line">    //如果zllen字段的长度小于UINT16_MAX(2**16 - 1)，那么直接返回</div><div class="line">    if (intrev16ifbe(ZIPLIST_LENGTH(zl)) &lt; UINT16_MAX) &#123;</div><div class="line">        len = intrev16ifbe(ZIPLIST_LENGTH(zl));</div><div class="line">    &#125; else &#123;</div><div class="line">    	//否则，需要遍历整个ziplist，然后返回其长度，整个过程很低效</div><div class="line">        unsigned char *p = zl+ZIPLIST_HEADER_SIZE;</div><div class="line">        while (*p != ZIP_END) &#123;</div><div class="line">            p += zipRawEntryLength(p);</div><div class="line">            len++;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //如果遍历之后发现长度小于UINT16_MAX的话，重新更改zllen字段，改成实际长度，避免下次再次遍历</div><div class="line">        if (len &lt; UINT16_MAX) ZIPLIST_LENGTH(zl) = intrev16ifbe(len);</div><div class="line">    &#125;</div><div class="line">    return len;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//返回ziplist的字节数</div><div class="line">size_t ziplistBlobLen(unsigned char *zl) &#123;</div><div class="line">    return intrev32ifbe(ZIPLIST_BYTES(zl));</div><div class="line">&#125;</div><div class="line"></div><div class="line">//列出ziplist的基本信息，注释略</div><div class="line">void ziplistRepr(unsigned char *zl) &#123;</div><div class="line">    unsigned char *p;</div><div class="line">    int index = 0;</div><div class="line">    zlentry entry;</div><div class="line"></div><div class="line">    printf(</div><div class="line">        "&#123;total bytes %d&#125; "</div><div class="line">        "&#123;length %u&#125;\n"</div><div class="line">        "&#123;tail offset %u&#125;\n",</div><div class="line">        intrev32ifbe(ZIPLIST_BYTES(zl)),</div><div class="line">        intrev16ifbe(ZIPLIST_LENGTH(zl)),</div><div class="line">        intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl)));</div><div class="line">    p = ZIPLIST_ENTRY_HEAD(zl);</div><div class="line">    while(*p != ZIP_END) &#123;</div><div class="line">        zipEntry(p, &amp;entry);</div><div class="line">        printf(</div><div class="line">            "&#123;"</div><div class="line">                "addr 0x%08lx, "</div><div class="line">                "index %2d, "</div><div class="line">                "offset %5ld, "</div><div class="line">                "rl: %5u, "</div><div class="line">                "hs %2u, "</div><div class="line">                "pl: %5u, "</div><div class="line">                "pls: %2u, "</div><div class="line">                "payload %5u"</div><div class="line">            "&#125; ",</div><div class="line">            (long unsigned)p,</div><div class="line">            index,</div><div class="line">            (unsigned long) (p-zl),</div><div class="line">            entry.headersize+entry.len,</div><div class="line">            entry.headersize,</div><div class="line">            entry.prevrawlen,</div><div class="line">            entry.prevrawlensize,</div><div class="line">            entry.len);</div><div class="line">        p += entry.headersize;</div><div class="line">        if (ZIP_IS_STR(entry.encoding)) &#123;</div><div class="line">            if (entry.len &gt; 40) &#123;</div><div class="line">                if (fwrite(p,40,1,stdout) == 0) perror("fwrite");</div><div class="line">                printf("...");</div><div class="line">            &#125; else &#123;</div><div class="line">                if (entry.len &amp;&amp;</div><div class="line">                    fwrite(p,entry.len,1,stdout) == 0) perror("fwrite");</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            printf("%lld", (long long) zipLoadInteger(p,entry.encoding));</div><div class="line">        &#125;</div><div class="line">        printf("\n");</div><div class="line">        p += entry.len;</div><div class="line">        index++;</div><div class="line">    &#125;</div><div class="line">    printf("&#123;end&#125;\n\n");</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>时间问题只写了几个核心函数的注释和一些小函数的注释，不过读懂了那几个函数其它函数其实也就大同小异，先出门喝杯咖啡散散步，什么时候有空补上没有写完的注释。</p>
<p>## 2016/11/22 已经更新完所有注释 ##</p>
<p>能力有限，可能会有错误，欢迎指出，大家一起交流学习。</p>
<p><iframe src="https://music.163.com/outchain/player?type=2&amp;id=21969945&amp;auto=0&amp;height=66" width="330" height="86" frameborder="no" marginwidth="0" marginheight="0"></iframe></p>





















          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
      
      	

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://kimlongli.github.io/2016/11/19/工具分享：dash3-3破解版/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="李金隆">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jinlong's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jinlong's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/19/工具分享：dash3-3破解版/" itemprop="url">
                  工具分享：dash3.3破解版
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-19T11:50:50+08:00">
                2016-11-19
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Dash是mac平台上常用的文档查询工具，但是Dash不是免费的，过了试用期之后要付费，否则在查询文档的过程中会出现8秒延迟，如下图：</p>
<p><img src="/uploads/dash_raw.jpg" alt="dash_raw"></p>
<p>从没使用过正版软件的我(…)立马想到了通过逆向工程把查询延迟的页面给屏蔽掉，经过一番努力，效果如下：</p>
<p><img src="/uploads/dash_cracking.jpg" alt="dash_cracking"><br><img src="/uploads/dash_cracked.jpg" alt="dash_cracked"></p>
<p>承诺不留后门，大家可以放心使用。<br>下面给出下载地址，只需要把下载好的dash程序替换掉原来Contents/MacOS/的Dash即可</p>
<p><a href="https://kimlongli.github.io/files/Dash">https://kimlongli.github.io/files/Dash</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


      
    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.png"
               alt="李金隆" />
          <p class="site-author-name" itemprop="name">李金隆</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">

          
          
            
              
            
          
            
              
            
          
            
              
            
          
            
          
            
              
            
          
            
          
            
          
            
              
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
            
          
            
          
            
              
            
          
            
          
            
          
            
          
            
              
            
          
            
          

          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-posts">
            <a href="/essays">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">随笔</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/fnhn/activities" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:kimlongli@icloud.com" target="_blank" title="E-mail">
                  
                    <i class="fa fa-fw fa-envelope-o"></i>
                  
                  E-mail
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李金隆</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  <script type="text/javascript">
    var shuoshuoQuery = {short_name:""};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';
      ds.async = true;
      ds.id = 'shuoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//23.106.145.179:8090/test/create.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>





  




	





  
  

  

  

  

  


</body>
</html>
